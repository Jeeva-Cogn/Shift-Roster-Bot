<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPE ShiftBot - AI Roster Management</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5fbf">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NPE ShiftBot">
    
    <!-- SEO & Social Meta Tags -->
    <meta name="description" content="AI-powered shift roster management with health-conscious scheduling for NPE teams">
    <meta name="keywords" content="shift management, roster, AI scheduling, work-life balance, NPE, team management">
    <meta name="author" content="NPE Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="NPE ShiftBot - AI Roster Management">
    <meta property="og:description" content="Health-conscious AI scheduling that prioritizes work-life balance while maintaining operational efficiency">
    <meta property="og:type" content="website">
    <meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIHZpZXdCb3g9IjAgMCAxMjAwIDYzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjOGI1ZmJmIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjYTM3NGQwIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjMwIiBmaWxsPSJ1cmwoI2JnKSIvPjx0ZXh0IHg9IjYwMCIgeT0iMjgwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn6SWIE5QRSBTaGlmdEJvdDwvdGV4dD48dGV4dCB4PSI2MDAiIHk9IjM2MCIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgb3BhY2l0eT0iMC45Ij5BSSBSb3N0ZXIgTWFuYWdlbWVudCB3aXRoIEhlYWx0aC1Db25zY2lvdXMgU2NoZWR1bGluZzwvdGV4dD48L3N2Zz4=">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NPE ShiftBot - AI Roster Management">
    <meta name="twitter:description" content="Health-conscious AI scheduling for teams">
    
    <!-- Performance & Security -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGI1ZmJmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIzIi8+PHBhdGggZD0iTTEyIDFWM20wIDE4djJtMTEtMTJoLTJNNSAxMkgzbTEwLjUtNi5MTDE2IDRNNy41IDE3LjVMNiAxOW0wLTEzTDcuNSA3LjVtMTEgMUwxNyAxNy41Ii8+PC9zdmc+"
    
    <!-- External Dependencies with integrity checks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Google Sites Compatible CSS */
        :root {
            --primary-color: #8b5fbf;
            --secondary-color: #a374d0;
            --background-color: #f3f0f8;
            --card-bg: #ffffff;
            --text-color: #4a4a4a;
            --text-light: #888;
            --border-color: #d4c5e0;
            --shadow: 0 4px 6px rgba(139, 95, 191, 0.15);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f3f0f8 0%, #e8dff0 100%);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: var(--text-color);
            min-width: 120px;
        }

        .tab:hover {
            background: var(--background-color);
        }

        .tab.active {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f6fb 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .compact-chart {
            height: 200px !important;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 95, 191, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e15662 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            font-weight: 600;
            color: var(--primary-color);
        }

        .table tr:hover {
            background-color: #f8f6fb;
        }

        .leave-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .calendar-day:hover {
            background-color: var(--background-color);
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
        }

        .calendar-day.has-leave {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 1px solid #b6e3ea;
            color: #0c5460;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: auto;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ NPE ShiftBot</h1>
            <p>AI-Powered Roster Management with Health-Conscious Scheduling</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('team')">üë• NPE Team</button>
            <button class="tab" onclick="showTab('leaves')">üèñÔ∏è Leave Management</button>
            <button class="tab" onclick="showTab('shifts')">‚è∞ Shifts</button>
            <button class="tab" onclick="showTab('generator')">üéØ Schedule Generator</button>
            <button class="tab" onclick="showTab('reports')">üìà Reports</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="cards-grid">
                <div class="card">
                    <h3>üìä NPE Team Workload Distribution</h3>
                    <canvas id="workloadChart" class="compact-chart"></canvas>
                </div>
                <div class="card">
                    <h3>üìÖ Current Month Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalEmployees">12</div>
                            <div class="stat-label">Team Members</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activeShifts">3</div>
                            <div class="stat-label">Active Shifts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="pendingLeaves">0</div>
                            <div class="stat-label">Pending Leaves</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="approvedLeaves">0</div>
                            <div class="stat-label">Approved Leaves</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>üèñÔ∏è Leave Status Overview</h3>
                    <canvas id="leaveStatusChart" class="compact-chart"></canvas>
                </div>
                <div class="card">
                    <h3>‚ö° Health & Wellness Metrics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="avgConsecutiveDays">3.2</div>
                            <div class="stat-label">Avg Consecutive Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="burnoutAlerts">0</div>
                            <div class="stat-label">Burnout Alerts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPE Team Tab -->
        <div id="team" class="tab-content">
            <div class="card">
                <h3>üë• NPE Team Members</h3>
                <table class="table" id="teamTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Preferred Days Off</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                        <!-- Team data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leave Management Tab -->
        <div id="leaves" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üèñÔ∏è Request Leave</h3>
                    <form id="leaveRequestForm">
                        <div class="form-group">
                            <label for="employeeSelect">Employee</label>
                            <select id="employeeSelect" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveDate">Leave Date</label>
                            <input type="date" id="leaveDate" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveType">Leave Type</label>
                            <select id="leaveType" required>
                                <option value="">Select Type</option>
                                <option value="sick">Sick Leave</option>
                                <option value="vacation">Vacation</option>
                                <option value="personal">Personal</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">Reason (Optional)</label>
                            <textarea id="leaveReason" rows="3" placeholder="Brief reason for leave..."></textarea>
                        </div>
                        <button type="submit" class="btn">Submit Leave Request</button>
                    </form>
                </div>

                <div class="card">
                    <h3>üìã Pending Leave Requests</h3>
                    <div id="pendingLeavesList">
                        <!-- Pending leaves will be shown here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìÖ Leave Calendar Overview</h3>
                <div id="leaveCalendar" class="leave-calendar">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- Shifts Tab -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h3>‚è∞ Shift Configuration</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Shift</th>
                            <th>Time</th>
                            <th>Required Roles</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>S1 - Morning</td>
                            <td>06:00 - 14:00</td>
                            <td>2 Leads, 4 Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S2 - Afternoon</td>
                            <td>14:00 - 22:00</td>
                            <td>2 Leads, 4 Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S3 - Night</td>
                            <td>22:00 - 06:00</td>
                            <td>1 Lead, 2 Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S4 - Emergency</td>
                            <td>Variable</td>
                            <td>1 Lead, 1 Associate</td>
                            <td><span style="color: orange;">‚ö† Rare</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Schedule Generator Tab -->
        <div id="generator" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üéØ AI Schedule Generator</h3>
                    <div class="alert alert-info">
                        <strong>Health-Conscious Scheduling:</strong> Our AI considers work-life balance, prevents burnout (max 6 consecutive days), and ensures proper rest periods.
                    </div>
                    <form id="scheduleForm">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="numDays">Number of Days</label>
                            <select id="numDays" required>
                                <option value="7">1 Week</option>
                                <option value="14">2 Weeks</option>
                                <option value="30" selected>1 Month</option>
                                <option value="60">2 Months</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">ü§ñ Generate AI Schedule</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadSchedule()">üì• Download Excel</button>
                    </form>
                </div>

                <div class="card">
                    <h3>‚ö° Health Rules Applied</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üõ°Ô∏è <strong>WORK_LIFE_BALANCE:</strong> 5 days work + 2 days rest cycle
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üß† <strong>STRESS_MANAGEMENT:</strong> Max 6 consecutive work days
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üíö <strong>MENTAL_HEALTH:</strong> Respects preferred days off
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            ‚öñÔ∏è <strong>FAIR_DISTRIBUTION:</strong> Equal workload across team
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>üìä Generated Schedule</h3>
                <div id="scheduleOutput">
                    <p style="text-align: center; color: var(--text-light); padding: 40px;">
                        Click "Generate AI Schedule" to create a health-conscious roster
                    </p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üìà Workload Analytics</h3>
                    <canvas id="reportChart" class="compact-chart"></canvas>
                </div>
                <div class="card">
                    <h3>üìä Team Performance</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">98.5%</div>
                            <div class="stat-label">Schedule Adherence</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">4.2</div>
                            <div class="stat-label">Avg Days/Week</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">2.1</div>
                            <div class="stat-label">Avg Rest Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Violations</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample NPE Team Data
        const npeTeamData = [
            { id: '001', name: 'Temple Dinesh', role: 'Lead', status: 'Active', daysOff: [0, 6] },
            { id: '002', name: 'Priya Sharma', role: 'Lead', status: 'Active', daysOff: [1, 2] },
            { id: '003', name: 'Raj Kumar', role: 'Associate', status: 'Active', daysOff: [0, 6] },
            { id: '004', name: 'Anjali Patel', role: 'Associate', status: 'Active', daysOff: [3, 4] },
            { id: '005', name: 'Suresh Reddy', role: 'Lead', status: 'Active', daysOff: [1, 5] },
            { id: '006', name: 'Kavya Singh', role: 'Associate', status: 'Active', daysOff: [0, 6] },
            { id: '007', name: 'Arjun Nair', role: 'Lead', status: 'Active', daysOff: [2, 3] },
            { id: '008', name: 'Meera Gupta', role: 'Associate', status: 'Active', daysOff: [4, 5] },
            { id: '009', name: 'Vikram Joshi', role: 'Associate', status: 'Active', daysOff: [0, 1] },
            { id: '010', name: 'Sneha Iyer', role: 'Lead', status: 'Active', daysOff: [5, 6] },
            { id: '011', name: 'Rohit Verma', role: 'Associate', status: 'Active', daysOff: [2, 4] },
            { id: '012', name: 'Divya Krishnan', role: 'Associate', status: 'Active', daysOff: [1, 3] }
        ];

        // Leave Management System
        let leaveRequests = [];
        let scheduleData = null;

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Initialize tab-specific content
            if (tabName === 'dashboard') {
                initDashboard();
            } else if (tabName === 'team') {
                loadTeamData();
            } else if (tabName === 'leaves') {
                initLeaveManagement();
            } else if (tabName === 'reports') {
                initReports();
            }
        }

        // Initialize Dashboard
        function initDashboard() {
            // Workload Distribution Chart
            const ctx1 = document.getElementById('workloadChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Leads', 'Associates'],
                    datasets: [{
                        data: [5, 7],
                        backgroundColor: [
                            'linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%)',
                            'linear-gradient(135deg, #a374d0 0%, #b794d1 100%)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Leave Status Chart
            const ctx2 = document.getElementById('leaveStatusChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'Approved', 'Available'],
                    datasets: [{
                        data: [0, 0, 12],
                        backgroundColor: [
                            '#ffc107',
                            '#28a745', 
                            '#8b5fbf'
                        ],
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            updateDashboardStats();
        }

        // Update Dashboard Statistics
        function updateDashboardStats() {
            document.getElementById('totalEmployees').textContent = npeTeamData.length;
            document.getElementById('activeShifts').textContent = '3';
            document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'pending').length;
            document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'approved').length;
        }

        // Load Team Data
        function loadTeamData() {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';
            
            npeTeamData.forEach(member => {
                const row = document.createElement('tr');
                const daysOffText = member.daysOff.map(day => {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    return days[day];
                }).join(', ');
                
                row.innerHTML = `
                    <td><strong>${member.name}</strong></td>
                    <td><span style="padding: 3px 8px; border-radius: 12px; font-size: 12px; background: ${member.role === 'Lead' ? '#8b5fbf' : '#a374d0'}; color: white;">${member.role}</span></td>
                    <td><span style="color: green;">‚úì ${member.status}</span></td>
                    <td>${daysOffText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize Leave Management
        function initLeaveManagement() {
            // Populate employee select
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">Select Employee</option>';
            npeTeamData.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').value = today;

            updateLeaveRequests();
            generateLeaveCalendar();
        }

        // Handle Leave Request Form
        document.getElementById('leaveRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('employeeSelect').value;
            const leaveDate = document.getElementById('leaveDate').value;
            const leaveType = document.getElementById('leaveType').value;
            const leaveReason = document.getElementById('leaveReason').value;
            
            if (!employeeId || !leaveDate || !leaveType) {
                alert('Please fill all required fields!');
                return;
            }

            const employee = npeTeamData.find(e => e.id === employeeId);
            const request = {
                id: Date.now().toString(),
                employeeId: employeeId,
                employeeName: employee.name,
                date: leaveDate,
                type: leaveType,
                reason: leaveReason,
                status: 'pending',
                requestDate: new Date().toISOString()
            };

            leaveRequests.push(request);
            updateLeaveRequests();
            updateDashboardStats();
            
            // Reset form
            this.reset();
            document.getElementById('leaveDate').value = new Date().toISOString().split('T')[0];
            
            alert('Leave request submitted successfully!');
        });

        // Update Leave Requests Display
        function updateLeaveRequests() {
            const container = document.getElementById('pendingLeavesList');
            const pendingLeaves = leaveRequests.filter(l => l.status === 'pending');
            
            if (pendingLeaves.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No pending leave requests</p>';
                return;
            }
            
            container.innerHTML = pendingLeaves.map(leave => `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${leave.employeeName}</strong>
                        <span style="font-size: 12px; color: var(--text-light);">${leave.date}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #ffc107; color: white;">${leave.type}</span>
                    </div>
                    ${leave.reason ? `<p style="font-size: 14px; margin-bottom: 10px;">${leave.reason}</p>` : ''}
                    <div>
                        <button class="btn btn-success" style="padding: 5px 12px; margin-right: 5px;" onclick="approveLeave('${leave.id}')">‚úì Approve</button>
                        <button class="btn btn-danger" style="padding: 5px 12px;" onclick="rejectLeave('${leave.id}')">‚úó Reject</button>
                    </div>
                </div>
            `).join('');
        }

        // Approve Leave Request
        function approveLeave(leaveId) {
            const leave = leaveRequests.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'approved';
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                alert(`Leave approved for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Reject Leave Request
        function rejectLeave(leaveId) {
            const index = leaveRequests.findIndex(l => l.id === leaveId);
            if (index !== -1) {
                const leave = leaveRequests[index];
                leaveRequests.splice(index, 1);
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                alert(`Leave rejected for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Generate Leave Calendar
        function generateLeaveCalendar() {
            const container = document.getElementById('leaveCalendar');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear calendar
            container.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.fontWeight = 'bold';
                header.style.textAlign = 'center';
                header.style.padding = '10px 5px';
                header.style.background = 'var(--primary-color)';
                header.style.color = 'white';
                header.style.borderRadius = '5px';
                header.style.fontSize = '12px';
                header.textContent = day;
                container.appendChild(header);
            });
            
            // Add empty cells for days before month start
            const firstDay = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                container.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasLeave = leaveRequests.some(l => l.date === dateStr && l.status === 'approved');
                
                if (hasLeave) {
                    dayElement.classList.add('has-leave');
                    const leavesForDay = leaveRequests.filter(l => l.date === dateStr && l.status === 'approved');
                    dayElement.title = `Leaves: ${leavesForDay.map(l => l.employeeName).join(', ')}`;
                }
                
                container.appendChild(dayElement);
            }
        }

        // Schedule Generation
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('startDate').value;
            const numDays = parseInt(document.getElementById('numDays').value);
            
            if (!startDate) {
                alert('Please select a start date!');
                return;
            }
            
            generateSchedule(startDate, numDays);
        });

        // Generate AI Schedule
        function generateSchedule(startDate, numDays) {
            const output = document.getElementById('scheduleOutput');
            output.innerHTML = '<p style="text-align: center;">ü§ñ AI is generating health-conscious schedule...</p>';
            
            // Simulate AI processing
            setTimeout(() => {
                const schedule = createHealthConsciousSchedule(startDate, numDays);
                displaySchedule(schedule);
            }, 2000);
        }

        // Create Health-Conscious Schedule
        function createHealthConsciousSchedule(startDate, numDays) {
            const schedule = {};
            const shifts = ['S1', 'S2', 'S3'];
            const requirements = {
                'S1': { 'Lead': 2, 'Associate': 4 },
                'S2': { 'Lead': 2, 'Associate': 4 },
                'S3': { 'Lead': 1, 'Associate': 2 }
            };
            
            // Track consecutive days for each employee
            const consecutiveDays = {};
            npeTeamData.forEach(emp => consecutiveDays[emp.id] = 0);
            
            for (let i = 0; i < numDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay();
                
                schedule[dateStr] = {};
                
                // Check for approved leaves
                const approvedLeaves = leaveRequests.filter(l => l.date === dateStr && l.status === 'approved');
                const employeesOnLeave = approvedLeaves.map(l => l.employeeId);
                
                shifts.forEach(shift => {
                    schedule[dateStr][shift] = {};
                    
                    Object.keys(requirements[shift]).forEach(role => {
                        const needed = requirements[shift][role];
                        const availableEmployees = npeTeamData.filter(emp => 
                            emp.role === role && 
                            !employeesOnLeave.includes(emp.id) &&
                            consecutiveDays[emp.id] < 6 && // Health rule: max 6 consecutive days
                            !emp.daysOff.includes(dayOfWeek) // Respect preferred days off
                        ).sort((a, b) => consecutiveDays[a.id] - consecutiveDays[b.id]); // Prioritize those with fewer consecutive days
                        
                        schedule[dateStr][shift][role] = availableEmployees.slice(0, needed).map(emp => {
                            consecutiveDays[emp.id]++;
                            return emp.name;
                        });
                    });
                });
                
                // Reset consecutive days counter for employees who get a day off
                npeTeamData.forEach(emp => {
                    const isWorking = shifts.some(shift => 
                        Object.values(schedule[dateStr][shift]).some(roleAssignments => 
                            roleAssignments.includes(emp.name)
                        )
                    );
                    if (!isWorking) {
                        consecutiveDays[emp.id] = 0;
                    }
                });
            }
            
            scheduleData = schedule;
            return schedule;
        }

        // Display Generated Schedule
        function displaySchedule(schedule) {
            const output = document.getElementById('scheduleOutput');
            let html = '<div class="alert alert-success">‚úÖ Health-conscious schedule generated successfully!</div>';
            
            html += '<table class="table" style="font-size: 12px;"><thead><tr><th>Date</th><th>S1 (Morning)</th><th>S2 (Afternoon)</th><th>S3 (Night)</th></tr></thead><tbody>';
            
            Object.keys(schedule).forEach(date => {
                const daySchedule = schedule[date];
                html += `<tr><td><strong>${date}</strong></td>`;
                
                ['S1', 'S2', 'S3'].forEach(shift => {
                    const shiftData = daySchedule[shift];
                    let shiftText = '';
                    
                    Object.keys(shiftData).forEach(role => {
                        const employees = shiftData[role];
                        if (employees.length > 0) {
                            shiftText += `<div><strong>${role}s:</strong> ${employees.join(', ')}</div>`;
                        }
                    });
                    
                    html += `<td>${shiftText || 'No assignments'}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            output.innerHTML = html;
        }

        // Download Schedule as Excel
        function downloadSchedule() {
            if (!scheduleData) {
                alert('Please generate a schedule first!');
                return;
            }
            
            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            const wsData = [['Date', 'S1 Leads', 'S1 Associates', 'S2 Leads', 'S2 Associates', 'S3 Leads', 'S3 Associates']];
            
            Object.keys(scheduleData).forEach(date => {
                const daySchedule = scheduleData[date];
                const row = [date];
                
                ['S1', 'S2', 'S3'].forEach(shift => {
                    const leads = daySchedule[shift]['Lead'] || [];
                    const associates = daySchedule[shift]['Associate'] || [];
                    row.push(leads.join(', '), associates.join(', '));
                });
                
                wsData.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'NPE Schedule');
            XLSX.writeFile(wb, 'NPE_ShiftBot_Schedule.xlsx');
        }

        // Initialize Reports
        function initReports() {
            const ctx = document.getElementById('reportChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Average Working Days',
                        data: [4.2, 4.1, 4.3, 4.0],
                        borderColor: '#8b5fbf',
                        backgroundColor: 'rgba(139, 95, 191, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 7
                        }
                    }
                }
            });
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // Register Service Worker for PWA functionality
            registerServiceWorker();
            
            // Add install app prompt
            setupInstallPrompt();
        });

        // PWA Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('NPE ShiftBot: Service Worker registered successfully', registration);
                } catch (error) {
                    console.log('NPE ShiftBot: Service Worker registration failed', error);
                }
            }
        }

        // PWA Install Prompt
        let deferredPrompt;
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                showInstallButton();
            });
        }

        function showInstallButton() {
            // Create install button
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-success';
            installBtn.innerHTML = 'üì± Install App';
            installBtn.style.position = 'fixed';
            installBtn.style.bottom = '20px';
            installBtn.style.right = '20px';
            installBtn.style.zIndex = '1000';
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`NPE ShiftBot: User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
        }

        // Enhanced Local Storage with compression
        const Storage = {
            set: (key, value) => {
                try {
                    const compressed = JSON.stringify(value);
                    localStorage.setItem(`npe-shiftbot-${key}`, compressed);
                } catch (error) {
                    console.error('Storage error:', error);
                }
            },
            get: (key) => {
                try {
                    const item = localStorage.getItem(`npe-shiftbot-${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error('Storage error:', error);
                    return null;
                }
            },
            remove: (key) => {
                localStorage.removeItem(`npe-shiftbot-${key}`);
            }
        };

        // Auto-save functionality
        function autoSave() {
            Storage.set('leaveRequests', leaveRequests);
            Storage.set('scheduleData', scheduleData);
            Storage.set('lastSaved', new Date().toISOString());
        }

        // Load saved data on startup
        function loadSavedData() {
            const savedLeaves = Storage.get('leaveRequests');
            const savedSchedule = Storage.get('scheduleData');
            
            if (savedLeaves) {
                leaveRequests = savedLeaves;
            }
            
            if (savedSchedule) {
                scheduleData = savedSchedule;
            }
        }

        // Export all data as Excel backup
        function exportBackup() {
            const wb = XLSX.utils.book_new();
            
            // Export Team Data
            const teamData = [
                ['ID', 'Name', 'Role', 'Status', 'Preferred Days Off']
            ];
            npeTeamData.forEach(member => {
                const daysOffText = member.daysOff.map(day => {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    return days[day];
                }).join(', ');
                teamData.push([member.id, member.name, member.role, member.status, daysOffText]);
            });
            const teamWs = XLSX.utils.aoa_to_sheet(teamData);
            XLSX.utils.book_append_sheet(wb, teamWs, 'Team Data');
            
            // Export Leave Requests
            const leaveData = [
                ['Request ID', 'Employee ID', 'Employee Name', 'Date', 'Type', 'Reason', 'Status', 'Request Date']
            ];
            leaveRequests.forEach(leave => {
                leaveData.push([
                    leave.id, 
                    leave.employeeId, 
                    leave.employeeName, 
                    leave.date, 
                    leave.type, 
                    leave.reason || '', 
                    leave.status, 
                    leave.requestDate
                ]);
            });
            const leaveWs = XLSX.utils.aoa_to_sheet(leaveData);
            XLSX.utils.book_append_sheet(wb, leaveWs, 'Leave Requests');
            
            // Export Schedule Data (if exists)
            if (scheduleData) {
                const scheduleDataArray = [
                    ['Date', 'S1 Leads', 'S1 Associates', 'S2 Leads', 'S2 Associates', 'S3 Leads', 'S3 Associates']
                ];
                
                Object.keys(scheduleData).forEach(date => {
                    const daySchedule = scheduleData[date];
                    const row = [date];
                    
                    ['S1', 'S2', 'S3'].forEach(shift => {
                        const leads = daySchedule[shift]['Lead'] || [];
                        const associates = daySchedule[shift]['Associate'] || [];
                        row.push(leads.join(', '), associates.join(', '));
                    });
                    
                    scheduleDataArray.push(row);
                });
                
                const scheduleWs = XLSX.utils.aoa_to_sheet(scheduleDataArray);
                XLSX.utils.book_append_sheet(wb, scheduleWs, 'Generated Schedule');
            }
            
            // Add metadata sheet
            const metaData = [
                ['Property', 'Value'],
                ['Export Date', new Date().toISOString()],
                ['Version', '1.0.0'],
                ['Total Team Members', npeTeamData.length],
                ['Total Leave Requests', leaveRequests.length],
                ['Application', 'NPE ShiftBot - AI Roster Management']
            ];
            const metaWs = XLSX.utils.aoa_to_sheet(metaData);
            XLSX.utils.book_append_sheet(wb, metaWs, 'Metadata');
            
            XLSX.writeFile(wb, `NPE-ShiftBot-Backup-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Import backup data from Excel
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Import Leave Requests
                    if (workbook.SheetNames.includes('Leave Requests')) {
                        const leaveSheet = workbook.Sheets['Leave Requests'];
                        const leaveData = XLSX.utils.sheet_to_json(leaveSheet, { header: 1 });
                        
                        // Skip header row
                        const importedLeaves = [];
                        for (let i = 1; i < leaveData.length; i++) {
                            const row = leaveData[i];
                            if (row.length >= 8) {
                                importedLeaves.push({
                                    id: row[0] || Date.now().toString() + Math.random(),
                                    employeeId: row[1],
                                    employeeName: row[2],
                                    date: row[3],
                                    type: row[4],
                                    reason: row[5] || '',
                                    status: row[6] || 'pending',
                                    requestDate: row[7] || new Date().toISOString()
                                });
                            }
                        }
                        
                        if (importedLeaves.length > 0) {
                            leaveRequests = importedLeaves;
                        }
                    }
                    
                    // Import Schedule Data
                    if (workbook.SheetNames.includes('Generated Schedule')) {
                        const scheduleSheet = workbook.Sheets['Generated Schedule'];
                        const scheduleDataArray = XLSX.utils.sheet_to_json(scheduleSheet, { header: 1 });
                        
                        const importedSchedule = {};
                        for (let i = 1; i < scheduleDataArray.length; i++) {
                            const row = scheduleDataArray[i];
                            if (row.length >= 7) {
                                const date = row[0];
                                importedSchedule[date] = {
                                    'S1': {
                                        'Lead': row[1] ? row[1].split(', ').filter(name => name.trim()) : [],
                                        'Associate': row[2] ? row[2].split(', ').filter(name => name.trim()) : []
                                    },
                                    'S2': {
                                        'Lead': row[3] ? row[3].split(', ').filter(name => name.trim()) : [],
                                        'Associate': row[4] ? row[4].split(', ').filter(name => name.trim()) : []
                                    },
                                    'S3': {
                                        'Lead': row[5] ? row[5].split(', ').filter(name => name.trim()) : [],
                                        'Associate': row[6] ? row[6].split(', ').filter(name => name.trim()) : []
                                    }
                                };
                            }
                        }
                        
                        if (Object.keys(importedSchedule).length > 0) {
                            scheduleData = importedSchedule;
                        }
                    }
                    
                    autoSave();
                    alert('Excel backup imported successfully!\n\n' +
                          `‚Ä¢ Leave Requests: ${leaveRequests.length}\n` +
                          `‚Ä¢ Schedule Data: ${scheduleData ? Object.keys(scheduleData).length + ' days' : 'None'}`);
                    location.reload();
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing Excel file. Please check the file format and try again.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Add backup/restore functionality to UI
        function addBackupButtons() {
            const header = document.querySelector('.header');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '10px';
            
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-secondary';
            exportBtn.innerHTML = 'ÔøΩ Export Excel Backup';
            exportBtn.onclick = exportBackup;
            
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-secondary';
            importBtn.innerHTML = 'üìÇ Import Excel Backup';
            importBtn.style.marginLeft = '10px';
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls';
            fileInput.style.display = 'none';
            fileInput.onchange = importBackup;
            
            importBtn.onclick = () => fileInput.click();
            
            buttonContainer.appendChild(exportBtn);
            buttonContainer.appendChild(importBtn);
            buttonContainer.appendChild(fileInput);
            header.appendChild(buttonContainer);
        }

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            addBackupButtons();
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
        });
    </script>
</body>
</html>
