<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPE ShiftBot - AI Roster Management</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5fbf">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NPE ShiftBot">
    <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
    
    <!-- SEO & Social Meta Tags -->
    <meta name="description" content="AI-powered shift roster management with health-conscious scheduling for NPE teams">
    <meta name="keywords" content="shift management, roster, AI scheduling, work-life balance, NPE, team management">
    <meta name="author" content="NPE Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="NPE ShiftBot - AI Roster Management">
    <meta property="og:description" content="Health-conscious AI scheduling that prioritizes work-life balance while maintaining operational efficiency">
    <meta property="og:type" content="website">
    <meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIHZpZXdCb3g9IjAgMCAxMjAwIDYzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjOGI1ZmJmIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjYTM3NGQwIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjMwIiBmaWxsPSJ1cmwoI2JnKSIvPjx0ZXh0IHg9IjYwMCIgeT0iMjgwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn6SWIE5QRSBTaGlmdEJvdDwvdGV4dD48dGV4dCB4PSI2MDAiIHk9IjM2MCIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgb3BhY2l0eT0iMC45Ij5BSSBSb3N0ZXIgTWFuYWdlbWVudCB3aXRoIEhlYWx0aC1Db25zY2lvdXMgU2NoZWR1bGluZzwvdGV4dD48L3N2Zz4=">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NPE ShiftBot - AI Roster Management">
    <meta name="twitter:description" content="Health-conscious AI scheduling for teams">
    
    <!-- Performance & Security -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGI1ZmJmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIzIi8+PHBhdGggZD0iTTEyIDFWM20wIDE4djJtMTEtMTJoLTJNNSAxMkgzbTEwLjUtNi5MTDE2IDRNNy41IDE3LjVMNiAxOW0wLTEzTDcuNSA3LjVtMTEgMUwxNyAxNy41Ii8+PC9zdmc+"
    
    <!-- External Dependencies with integrity checks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Chennai timezone utilities - Ultimate rule awareness
        function getChennaiTime() {
            return new Date().toLocaleString("en-US", {timeZone: "Asia/Kolkata"});
        }
        
        function getChennaiDate() {
            const chennaiTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Kolkata"});
            return new Date(chennaiTime);
        }
        
        function isWeekendInChennai(date) {
            const chennaiDate = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            const dayOfWeek = chennaiDate.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
        }
        
        function countWeekendsInRange(startDate, endDate) {
            let count = 0;
            const current = new Date(startDate);
            while (current <= endDate) {
                if (isWeekendInChennai(current)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }
        
        // Ultimate rule: Count of Sat & Sun = Count of each employee OFF
        function validateEmployeeSchedule(employeeName, schedule, startDate, endDate) {
            const weekendCount = countWeekendsInRange(startDate, endDate);
            let offCount = 0;
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const daySchedule = schedule[dateStr] || {};
                
                // Check if employee is OFF this day
                let isWorking = false;
                Object.keys(daySchedule).forEach(shift => {
                    if (daySchedule[shift] && daySchedule[shift].includes(employeeName)) {
                        isWorking = true;
                    }
                });
                
                if (!isWorking) offCount++;
            }
            
            return {
                weekendCount,
                offCount,
                isValid: weekendCount === offCount,
                employeeName
            };
        }
    </script>
    
    <style>
        /* Google Sites Compatible CSS */
        :root {
            --primary-color: #8b5fbf;
            --secondary-color: #a374d0;
            --background-color: #f3f0f8;
            --card-bg: #ffffff;
            --text-color: #4a4a4a;
            --text-light: #888;
            --border-color: #d4c5e0;
            --shadow: 0 4px 6px rgba(139, 95, 191, 0.15);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f3f0f8 0%, #e8dff0 100%);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: var(--text-color);
            min-width: 120px;
        }

        .tab:hover {
            background: var(--background-color);
        }

        .tab.active {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f6fb 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(139, 95, 191, 0.25);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
            animation: fadeInScale 0.8s ease-out;
        }

        .stat-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(139, 95, 191, 0.3);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            animation: countUp 1.5s ease-out;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
            animation: fadeInLeft 0.8s ease-out;
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .compact-chart {
            height: 200px !important;
            margin: 10px 0;
            animation: fadeIn 1.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 95, 191, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e15662 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            font-weight: 600;
            color: var(--primary-color);
        }

        .table tr:hover {
            background-color: #f8f6fb;
        }

        .leave-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            padding: 3px;
            position: relative;
            min-height: 60px;
        }

        .calendar-day:hover {
            background-color: var(--background-color);
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
        }

        .calendar-day.has-leave {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            color: white;
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .leave-employees {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
            max-height: 45px;
            overflow-y: auto;
            font-size: 9px;
        }

        .leave-employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            padding: 1px 3px;
            margin: 1px 0;
        }

        .leave-employee-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 8px;
        }

        .cancel-leave-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 2px;
            width: 12px;
            height: 12px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 2px;
            flex-shrink: 0;
        }

        .cancel-leave-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 1px solid #b6e3ea;
            color: #0c5460;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: auto;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Modern Analytics Dashboard Styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Update body font */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        /* Analytics Header */
        .analytics-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 1rem;
        }

        .analytics-header h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .analytics-header p {
            font-size: 1.125rem;
            color: #6b7280;
            font-weight: 400;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color);
        }

        .kpi-card.primary { --accent-color: #8b5fbf; }
        .kpi-card.success { --accent-color: #10b981; }
        .kpi-card.warning { --accent-color: #f59e0b; }
        .kpi-card.info { --accent-color: #3b82f6; }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .kpi-icon {
            font-size: 2rem;
            min-width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-color);
            border-radius: 12px;
            color: white;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1.1;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .kpi-trend {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
        }

        .kpi-trend.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .kpi-trend.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .kpi-trend.neutral {
            background: #f3f4f6;
            color: #4b5563;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        .analytics-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
            grid-column: span 6;
        }

        .analytics-card.wide {
            grid-column: span 8;
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .ai-badge {
            background: linear-gradient(135deg, #8b5fbf, #a374d0);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Circular Progress Charts */
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .metric-item {
            padding: 1rem;
        }

        .metric-circle {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.5rem;
        }

        .circular-chart {
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: #f3f4f6;
            stroke-width: 2.8;
        }

        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            animation: progress 1s ease-out forwards;
        }

        .circular-chart.green .circle { stroke: #10b981; }
        .circular-chart.blue .circle { stroke: #3b82f6; }
        .circular-chart.orange .circle { stroke: #f59e0b; }

        .percentage {
            fill: #1a1a1a;
            font-family: 'Inter', sans-serif;
            font-size: 0.5em;
            font-weight: 600;
            text-anchor: middle;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        @keyframes progress {
            0% {
                stroke-dasharray: 0 100;
            }
        }

        /* AI Insights */
        .insights-list {
            margin-top: 1rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }

        .insight-item.positive {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .insight-item.warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
        }

        .insight-item.info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
        }

        .insight-icon {
            font-size: 1.25rem;
            min-width: 24px;
        }

        .insight-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .insight-description {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Activity Feed */
        .activity-feed {
            margin-top: 1rem;
        }

        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }

        .activity-content {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.4;
        }

        .activity-user {
            font-weight: 600;
            color: #8b5fbf;
        }

        .activity-highlight {
            background: #fef3c7;
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .analytics-card {
                grid-column: span 12;
            }
            
            .analytics-card.wide {
                grid-column: span 12;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .health-metrics {
                grid-template-columns: 1fr;
            }
            
            .analytics-header h2 {
                font-size: 1.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>🤖 NPE ShiftBot</h1>
                    <p>AI-Powered Roster Management with Health-Conscious Scheduling</p>
                </div>
                <div class="header-actions">
                    <button onclick="handleImportRoster()" class="import-btn">
                        <span class="icon">📥</span>
                        Import Roster
                    </button>
                </div>
            </div>
        </div>

        <style>
            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                padding: 0 20px;
            }
            .header-title {
                flex: 1;
            }
            .header-actions {
                display: flex;
                gap: 10px;
            }
            .import-btn {
                background: linear-gradient(135deg, #8b5fbf 0%, #6b46c1 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .import-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
                background: linear-gradient(135deg, #9d73d4 0%, #7c54d3 100%);
            }
            .import-btn .icon {
                font-size: 18px;
            }
        </style>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab('team')">👥 NPE Team</button>
            <button class="tab" onclick="showTab('leaves')">🏖️ Leave Management</button>
            <button class="tab" onclick="showTab('shifts')">⏰ Shifts</button>
            <button class="tab" onclick="showTab('generator')">🎯 Schedule Generator</button>
            <button class="tab" onclick="showTab('reports')">📈 Reports</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Modern Analytics Header -->
            <div class="analytics-header">
                <h2>Team Performance Analytics</h2>
                <p>Real-time insights into your workforce management</p>
            </div>

            <!-- Key Performance Indicators -->
            <div class="kpi-grid">
                <div class="kpi-card primary">
                    <div class="kpi-icon">�</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalEmployees">12</div>
                        <div class="kpi-label">Active Team Members</div>
                        <div class="kpi-trend positive">↗ +2 this month</div>
                    </div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-icon">⚡</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="efficiencyScore">94</div>
                        <div class="kpi-label">Efficiency Score</div>
                        <div class="kpi-trend positive">↗ +3% vs last month</div>
                    </div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-icon">🏖️</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="pendingLeaves">5</div>
                        <div class="kpi-label">Pending Requests</div>
                        <div class="kpi-trend neutral">→ Same as last week</div>
                    </div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-icon">🎯</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="coverageRate">98</div>
                        <div class="kpi-label">Shift Coverage</div>
                        <div class="kpi-trend positive">↗ +1% improvement</div>
                    </div>
                </div>
            </div>

            <!-- Modern Analytics Grid -->
            <div class="analytics-grid">
                <!-- Schedule Efficiency Metrics -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Schedule Health</h3>
                    </div>
                    <div class="health-metrics">
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="85">
                                <svg id="staffing-circle" viewBox="0 0 36 36" class="circular-chart green">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="85, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">85%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Staffing Efficiency</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="72">
                                <svg id="balance-circle" viewBox="0 0 36 36" class="circular-chart blue">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="72, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">72%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Work-Life Balance</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="91">
                                <svg id="satisfaction-circle" viewBox="0 0 36 36" class="circular-chart orange">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="91, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">91%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Team Satisfaction</div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>AI Insights</h3>
                        <span class="ai-badge">🧠 AI</span>
                    </div>
                    <div class="insights-list">
                        <div class="insight-item positive">
                            <div class="insight-icon">✅</div>
                            <div class="insight-content">
                                <div class="insight-title">Optimal Coverage</div>
                                <div class="insight-description">All shifts are properly staffed this week</div>
                            </div>
                        </div>
                        <div class="insight-item warning">
                            <div class="insight-icon">⚠️</div>
                            <div class="insight-content">
                                <div class="insight-title">Potential Burnout Risk</div>
                                <div class="insight-description">2 team members approaching 6-day limit</div>
                            </div>
                        </div>
                        <div class="insight-item info">
                            <div class="insight-icon">💡</div>
                            <div class="insight-content">
                                <div class="insight-title">Schedule Optimization</div>
                                <div class="insight-description">Rotating night shifts could improve fairness</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    <div class="activity-feed">
                        <div class="activity-item">
                            <div class="activity-time">2 min ago</div>
                            <div class="activity-content">
                                <span class="activity-user">Karthikeyan</span> submitted leave request for Aug 15
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">1 hour ago</div>
                            <div class="activity-content">
                                Schedule generated for <span class="activity-highlight">Week 32</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">3 hours ago</div>
                            <div class="activity-content">
                                <span class="activity-user">Jeeva</span> approved 2 leave requests
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">1 day ago</div>
                            <div class="activity-content">
                                AI optimization improved efficiency by <span class="activity-highlight">3%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                            <div class="stat-label">Avg Consecutive Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="burnoutAlerts">0</div>
                            <div class="stat-label">Burnout Alerts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPE Team Tab -->
        <div id="team" class="tab-content">
            <div class="card">
                <h3>👥 NPE Team Members</h3>
                <table class="table" id="teamTable">
                    <thead>
                        <tr>
                            <th>CTS ID</th>
                            <th>ESHC</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Preferred Days Off</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                        <!-- Team data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leave Management Tab -->
        <div id="leaves" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>🏖️ Request Leave</h3>
                    <form id="leaveRequestForm">
                        <div class="form-group">
                            <label for="employeeSelect">Employee</label>
                            <select id="employeeSelect" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveDate">Leave Date</label>
                            <input type="date" id="leaveDate" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveType">Leave Type</label>
                            <select id="leaveType" required>
                                <option value="">Select Type</option>
                                <option value="sick">Sick Leave</option>
                                <option value="vacation">Vacation</option>
                                <option value="personal">Personal</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">Reason (Optional)</label>
                            <textarea id="leaveReason" rows="3" placeholder="Brief reason for leave..."></textarea>
                        </div>
                        <button type="submit" class="btn">Submit Leave Request</button>
                    </form>
                </div>

                <div class="card">
                    <h3>📋 Pending Leave Requests</h3>
                    <div id="pendingLeavesList">
                        <!-- Pending leaves will be shown here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📅 Leave Calendar Overview</h3>
                <div id="leaveCalendar" class="leave-calendar">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- Shifts Tab -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h3>⏰ Shift Configuration</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Shift</th>
                            <th>Time</th>
                            <th>Required Roles</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>S1 - Morning</td>
                            <td>06:00 AM - 04:00 PM IST</td>
                            <td>Shift Leads, Associates</td>
                            <td><span style="color: green;">✓ Active</span></td>
                        </tr>
                        <tr>
                            <td>S2 - Afternoon</td>
                            <td>01:00 PM - 11:00 PM IST</td>
                            <td>Leads, Shift Leads, Associates</td>
                            <td><span style="color: green;">✓ Active</span></td>
                        </tr>
                        <tr>
                            <td>S3 - Night</td>
                            <td>10:00 PM - 08:00 AM IST</td>
                            <td>Shift Leads, Associates</td>
                            <td><span style="color: green;">✓ Active</span></td>
                        </tr>
                        <tr>
                            <td>S4 - Special</td>
                            <td>12:30 PM - 10:30 PM IST</td>
                            <td>Leads</td>
                            <td><span style="color: orange;">⚠ As Needed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Schedule Generator Tab -->
        <div id="generator" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>🎯 AI Schedule Generator</h3>
                    <div class="alert alert-info">
                        <strong>Health-Conscious Scheduling:</strong> Our AI considers work-life balance, prevents burnout (max 6 consecutive days), and ensures proper rest periods.
                    </div>
                    <form id="scheduleForm">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="numDays">Number of Days</label>
                            <select id="numDays" required>
                                <option value="7">1 Week</option>
                                <option value="14">2 Weeks</option>
                                <option value="30" selected>1 Month</option>
                                <option value="60">2 Months</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">🤖 Generate AI Schedule</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadSchedule()">📥 Download Excel</button>
                    </form>
                </div>

                <div class="card">
                    <h3>⚡ Health Rules Applied</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            🛡️ <strong>WORK_LIFE_BALANCE:</strong> 5 days work + 2 days rest cycle
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            🧠 <strong>STRESS_MANAGEMENT:</strong> Max 6 consecutive work days
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            💚 <strong>MENTAL_HEALTH:</strong> Respects preferred days off
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            ⚖️ <strong>FAIR_DISTRIBUTION:</strong> Equal workload across team
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>📊 Generated Schedule</h3>
                <div id="scheduleOutput">
                    <p style="text-align: center; color: var(--text-light); padding: 40px;">
                        Click "Generate AI Schedule" to create a health-conscious roster
                    </p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>📈 Workload Analytics</h3>
                    <canvas id="reportChart" class="compact-chart"></canvas>
                </div>
                <div class="card">
                    <h3>📊 Team Performance</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">98.5%</div>
                            <div class="stat-label">Schedule Adherence</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">4.2</div>
                            <div class="stat-label">Avg Days/Week</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">2.1</div>
                            <div class="stat-label">Avg Rest Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Violations</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Real NPE Team Data - August 2025
        const npeTeamData = [
            // Leads
            { id: '593300', name: 'Dinesh', role: 'Lead', status: 'Active', daysOff: [1, 2], cts: '593300', eshc: 'EH0647' },
            { id: '560008', name: 'Mano', role: 'Lead', status: 'Active', daysOff: [1, 2], cts: '560008', eshc: 'EG4208' },
            
            // Shift Leads
            { id: '410093', name: 'Jeyakaran', role: 'Shift Lead', status: 'Active', daysOff: [2, 3], cts: '410093', eshc: 'EH6832' },
            { id: '2167353', name: 'Karthikeyan', role: 'Shift Lead', status: 'Active', daysOff: [0, 3], cts: '2167353', eshc: 'C7H8KH' },
            { id: '2054459', name: 'Panner', role: 'Shift Lead', status: 'Active', daysOff: [0, 6], cts: '2054459', eshc: 'C6X8FS' },
            { id: '2240608', name: 'Sai Kumar', role: 'Shift Lead', status: 'Active', daysOff: [3, 6], cts: '2240608', eshc: 'C7T7SF' },
            { id: '2136623', name: 'Manoj', role: 'Shift Lead', status: 'Active', daysOff: [4, 5], cts: '2136623', eshc: 'C8G3CW' },
            
            // Associates
            { id: '2054433', name: 'Sai Krishna', role: 'Associate', status: 'Active', daysOff: [0, 6], cts: '2054433', eshc: 'C6X7K5' },
            { id: '2299004', name: 'Jeeva', role: 'Associate', status: 'Active', daysOff: [1, 2], cts: '2299004', eshc: 'C8N5H4' },
            { id: '2309236', name: 'Saran', role: 'Associate', status: 'Active', daysOff: [1, 2], cts: '2309236', eshc: 'C8S7B6' },
            { id: '2328010', name: 'Akshay', role: 'Associate', status: 'Active', daysOff: [0, 6], cts: '2328010', eshc: 'C8W2BD' },
            { id: '2378392', name: 'Murugan', role: 'Associate', status: 'Active', daysOff: [4, 5], cts: '2378392', eshc: 'C9B7ZT' },
            { id: '2411200', name: 'Sahana P', role: 'Associate', status: 'Active', daysOff: [1, 2], cts: '2411200', eshc: 'C9G7D2' },
            { id: '2389541', name: 'Rengadurai', role: 'Associate', status: 'Active', daysOff: [1, 2], cts: '2389541', eshc: 'C9H4JZ' }
        ];

        // Real August 2025 Schedule Data
        const realAugust2025Schedule = {
            '2025-08-01': { 'S1': ['Jeyakaran', 'Manoj', 'Sahana P'], 'S2': ['Sai Kumar', 'Murugan'], 'S3': ['Karthikeyan', 'Saran', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-02': { 'S1': ['Jeyakaran', 'Manoj'], 'S2': ['Sai Kumar', 'Murugan'], 'S3': ['Panner', 'Akshay'] },
            '2025-08-03': { 'S1': [], 'S2': ['Manoj', 'Sai Krishna'], 'S3': ['Panner', 'Akshay', 'Murugan'] },
            '2025-08-04': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S3': ['Panner', 'Akshay', 'Sahana P'] },
            '2025-08-05': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Dinesh', 'Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S3': ['Panner', 'Akshay', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-06': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Dinesh', 'Jeyakaran', 'Sai Krishna', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-07': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-08': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Akshay', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-09': { 'S1': ['Karthikeyan', 'Jeeva'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna'] },
            '2025-08-10': { 'S1': ['Karthikeyan'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna'] },
            '2025-08-11': { 'S1': ['Karthikeyan', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-12': { 'S1': ['Karthikeyan', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-13': { 'S1': ['Karthikeyan', 'Manoj', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-14': { 'S1': ['Karthikeyan', 'Manoj', 'Jeeva', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Rengadurai'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Murugan'], 'S4': ['Mano'] },
            '2025-08-15': { 'S1': ['Karthikeyan', 'Manoj', 'Jeeva'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-16': { 'S1': ['Karthikeyan', 'Manoj'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Panner'] },
            '2025-08-17': { 'S1': ['Manoj'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Panner'] },
            '2025-08-18': { 'S1': ['Jeyakaran', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-19': { 'S1': ['Jeyakaran', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-20': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-21': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-22': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Saran'], 'S4': ['Dinesh'] },
            '2025-08-23': { 'S1': ['Karthikeyan'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Saran'] },
            '2025-08-24': { 'S1': ['Karthikeyan'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Saran'] },
            '2025-08-25': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Sai Kumar', 'Sai Krishna'], 'S3': ['Panner', 'Jeeva', 'Saran', 'Rengadurai'] },
            '2025-08-26': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Sai Kumar', 'Sai Krishna'], 'S3': ['Panner', 'Jeeva', 'Saran', 'Rengadurai'] },
            '2025-08-27': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Dinesh', 'Sai Kumar', 'Sai Krishna'], 'S3': ['Saran', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-28': { 'S1': ['Jeyakaran', 'Karthikeyan', 'Murugan', 'Sahana P'], 'S2': ['Dinesh', 'Sai Kumar', 'Sai Krishna', 'Jeeva'], 'S3': ['Saran', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-29': { 'S1': ['Jeyakaran', 'Karthikeyan', 'Murugan', 'Jeeva'], 'S2': ['Dinesh', 'Akshay'], 'S3': ['Sai Kumar', 'Saran', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-30': { 'S1': ['Jeyakaran', 'Karthikeyan'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Saran', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-31': { 'S1': ['Jeyakaran', 'Karthikeyan'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Saran', 'Jeeva', 'Sahana P'], 'S4': ['Mano'] }
        };

        // Real leave data for August 2025
        const realLeaveData = [
            { id: 'leave001', employeeId: '593300', employeeName: 'Dinesh', date: '2025-08-07', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-07-25T10:00:00Z' },
            { id: 'leave002', employeeId: '593300', employeeName: 'Dinesh', date: '2025-08-08', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-07-25T10:00:00Z' },
            { id: 'leave003', employeeId: '2240608', employeeName: 'Sai Kumar', date: '2025-08-04', type: 'sick', reason: 'Medical appointment', status: 'approved', requestDate: '2025-08-01T09:00:00Z' },
            { id: 'leave004', employeeId: '410093', employeeName: 'Jeyakaran', date: '2025-08-23', type: 'vacation', reason: 'Family function', status: 'approved', requestDate: '2025-08-10T14:30:00Z' },
            { id: 'leave005', employeeId: '410093', employeeName: 'Jeyakaran', date: '2025-08-24', type: 'vacation', reason: 'Family function', status: 'approved', requestDate: '2025-08-10T14:30:00Z' },
            { id: 'leave006', employeeId: '2136623', employeeName: 'Manoj', date: '2025-08-13', type: 'sick', reason: 'Fever', status: 'approved', requestDate: '2025-08-12T08:00:00Z' },
            { id: 'leave007', employeeId: '2299004', employeeName: 'Jeeva', date: '2025-08-12', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-08-05T16:00:00Z' },
            { id: 'leave008', employeeId: '2328010', employeeName: 'Akshay', date: '2025-08-28', type: 'emergency', reason: 'Family emergency', status: 'approved', requestDate: '2025-08-27T20:00:00Z' }
        ];

        // Dynamic data storage
        let leaveRequests = [...realLeaveData];
        let scheduleData = {...realAugust2025Schedule};

        // Handle roster import
        function handleImportRoster() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    // Process the Excel file
                    processImportedRoster(workbook);
                    
                } catch (error) {
                    alert('Error processing the file. Please ensure it\'s a valid Excel roster file.');
                    console.error('Import error:', error);
                }
            };

            input.click();
        }

        // Excel Template Structure Definition
        const EXCEL_TEMPLATE = {
            SHEETS: {
                EMPLOYEES: {
                    name: 'Employees',
                    columns: [
                        { header: 'Name *', key: 'name', width: 20, required: true },
                        { header: 'Role *', key: 'role', width: 15, required: true },
                        { header: 'Employee ID', key: 'employeeId', width: 15 },
                        { header: 'ESHC', key: 'eshc', width: 15 },
                        { header: 'Preferred Days Off', key: 'daysOff', width: 20 },
                        { header: 'Skills', key: 'skills', width: 25 }
                    ]
                },
                SHIFTS: {
                    name: 'Shifts',
                    columns: [
                        { header: 'Shift Code *', key: 'code', width: 12, required: true },
                        { header: 'Start Time', key: 'startTime', width: 15 },
                        { header: 'End Time', key: 'endTime', width: 15 },
                        { header: 'Min Staff Required *', key: 'minStaff', width: 18, required: true },
                        { header: 'Required Leads', key: 'requiredLeads', width: 15 },
                        { header: 'Required Associates', key: 'requiredAssociates', width: 15 },
                        { header: 'Mandatory Members', key: 'mandatoryMembers', width: 30 },
                        { header: 'Preferred Shift Lead', key: 'preferredLead', width: 20 }
                    ]
                },
                ROSTER: {
                    name: 'Roster',
                    columns: [
                        { header: 'Date', key: 'date', width: 15 },
                        { header: 'S1 (06:00-14:00)', key: 'S1', width: 25 },
                        { header: 'S2 (13:00-21:00)', key: 'S2', width: 25 },
                        { header: 'S3 (20:00-04:00)', key: 'S3', width: 25 },
                        { header: 'S4 (12:30-20:30)', key: 'S4', width: 25 }
                    ]
                },
                LEAVES: {
                    name: 'Leaves',
                    columns: [
                        { header: 'Employee ID', key: 'employeeId', width: 15 },
                        { header: 'Employee Name', key: 'employeeName', width: 20 },
                        { header: 'Date', key: 'date', width: 15 },
                        { header: 'Leave Type', key: 'type', width: 15 },
                        { header: 'Status', key: 'status', width: 15 },
                        { header: 'Reason', key: 'reason', width: 30 }
                    ]
                }
            }
        };

        function processImportedRoster(workbook) {
            // Show loading state
            document.body.style.cursor = 'wait';
            const loadingAlert = document.createElement('div');
            loadingAlert.className = 'alert alert-info';
            loadingAlert.style.position = 'fixed';
            loadingAlert.style.top = '20px';
            loadingAlert.style.right = '20px';
            loadingAlert.style.zIndex = '1000';
            loadingAlert.innerHTML = '🔄 Analyzing roster data...';
            document.body.appendChild(loadingAlert);

            try {
                const sheetProcessors = {
                    [EXCEL_TEMPLATE.SHEETS.EMPLOYEES.name]: (sheet) => {
                        const employeeData = XLSX.utils.sheet_to_json(sheet);
                        npeTeamData.length = 0;
                        
                        employeeData.forEach(emp => {
                            // Check for required fields
                            if (!emp['Name'] || !emp['Role']) {
                                console.warn('Skipping employee record: Name and Role are required fields');
                                return;
                            }
                            
                            // Generate ID if not provided
                            const id = emp['Employee ID'] || Date.now().toString();
                            
                            npeTeamData.push({
                                id: id,
                                name: emp['Name'],
                                role: emp['Role'],
                                status: 'Active',
                                // All other fields are optional with defaults
                                daysOff: emp['Preferred Days Off'] ? 
                                    emp['Preferred Days Off'].split(',').map(d => parseInt(d.trim())) : 
                                    [0, 6], // Default weekend off
                                cts: emp['Employee ID'] || id, // Use ID as CTS if not provided
                                eshc: emp['ESHC'] || 'N/A',   // ESHC is optional
                                maxConsecutiveDays: 6,        // Default values for health rules
                                minRestHours: 12,
                                skills: emp['Skills'] ? emp['Skills'].split(',').map(s => s.trim()) : []
                            });
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.SHIFTS.name]: (sheet) => {
                        const shiftData = XLSX.utils.sheet_to_json(sheet);
                        window.shiftConfig = {};
                        
                        shiftData.forEach(shift => {
                            window.shiftConfig[shift['Shift Code']] = {
                                startTime: shift['Start Time'],
                                endTime: shift['End Time'],
                                minStaff: shift['Min Staff Required'],
                                requiredLeads: shift['Required Leads'] || 0,
                                requiredAssociates: shift['Required Associates'] || 0,
                                preferredLead: shift['Preferred Shift Lead'] || '',
                                mandatoryMembers: shift['Mandatory Members'] ? 
                                    shift['Mandatory Members'].split(',').map(s => s.trim()) : 
                                    [],
                                breakDuration: shift['Break Duration (mins)'] || 30
                            };
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.ROSTER.name]: (sheet) => {
                        const rosterData = XLSX.utils.sheet_to_json(sheet);
                        scheduleData = {};
                        
                        rosterData.forEach(row => {
                            if (row['Date']) {
                                scheduleData[row['Date']] = {
                                    'S1': row['S1 (06:00-14:00)'] ? 
                                        row['S1 (06:00-14:00)'].split(',').map(s => s.trim()) : [],
                                    'S2': row['S2 (13:00-21:00)'] ? 
                                        row['S2 (13:00-21:00)'].split(',').map(s => s.trim()) : [],
                                    'S3': row['S3 (20:00-04:00)'] ? 
                                        row['S3 (20:00-04:00)'].split(',').map(s => s.trim()) : [],
                                    'S4': row['S4 (12:30-20:30)'] ? 
                                        row['S4 (12:30-20:30)'].split(',').map(s => s.trim()) : []
                                };
                            }
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.LEAVES.name]: (sheet) => {
                        const leaveData = XLSX.utils.sheet_to_json(sheet);
                        leaveRequests.length = 0;
                        
                        leaveData.forEach(leave => {
                            leaveRequests.push({
                                id: Date.now().toString(),
                                employeeId: leave['Employee ID'],
                                employeeName: leave['Employee Name'],
                                date: leave['Date'],
                                type: leave['Leave Type'] || 'personal',
                                reason: leave['Reason'] || '',
                                status: leave['Status'] || 'approved',
                                requestDate: new Date().toISOString()
                            });
                        });
                    }
                };

                // Process each sheet if it exists
                Object.values(EXCEL_TEMPLATE.SHEETS).forEach(sheetConfig => {
                    if (workbook.SheetNames.includes(sheetConfig.name)) {
                        const sheet = workbook.Sheets[sheetConfig.name];
                        sheetProcessors[sheetConfig.name](sheet);
                    }
                });

                // Refresh all views
                initDashboard();
                loadTeamData();
                updateLeaveRequests();
                generateLeaveCalendar();

                // Show success message
                loadingAlert.className = 'alert alert-success';
                loadingAlert.innerHTML = '✅ Roster data imported successfully!';
                setTimeout(() => loadingAlert.remove(), 3000);

            } catch (error) {
                console.error('Processing error:', error);
                loadingAlert.className = 'alert alert-danger';
                loadingAlert.innerHTML = '❌ Error processing roster data. Please check the file format.';
                setTimeout(() => loadingAlert.remove(), 5000);
            }

            // Reset cursor
            document.body.style.cursor = 'default';
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Initialize tab-specific content
            if (tabName === 'dashboard') {
                initDashboard();
            } else if (tabName === 'team') {
                loadTeamData();
            } else if (tabName === 'leaves') {
                initLeaveManagement();
            } else if (tabName === 'reports') {
                initReports();
            } else if (tabName === 'shiftConfig') {
                initShiftConfiguration();
            }
        }

        // Initialize Shift Configuration
        function initShiftConfiguration() {
            // Populate shift leads dropdown
            const preferredLeadSelect = document.getElementById('preferredLead');
            const mandatoryMembersSelect = document.getElementById('mandatoryMembers');
            
            preferredLeadSelect.innerHTML = '<option value="">Select Shift Lead</option>';
            mandatoryMembersSelect.innerHTML = '';
            
            // Add shift leads to preferred lead dropdown
            npeTeamData.filter(member => member.role === 'Shift Lead').forEach(lead => {
                const option = document.createElement('option');
                option.value = lead.name;
                option.textContent = lead.name;
                preferredLeadSelect.appendChild(option);
            });
            
            // Add all team members to mandatory members multiselect
            npeTeamData.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = `${member.name} (${member.role})`;
                mandatoryMembersSelect.appendChild(option);
            });
            
            // Load existing shift configurations
            updateShiftConfigList();
        }

        // Handle Shift Configuration Form (if it exists)
        const shiftConfigForm = document.getElementById('shiftConfigForm');
        if (shiftConfigForm) {
            shiftConfigForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const shiftCode = document.getElementById('shiftCode').value;
                const startTime = document.getElementById('shiftStart').value;
                const endTime = document.getElementById('shiftEnd').value;
                const minStaff = parseInt(document.getElementById('minStaff').value);
                const requiredLeads = parseInt(document.getElementById('requiredLeads').value);
            const requiredAssociates = parseInt(document.getElementById('requiredAssociates').value);
            const preferredLead = document.getElementById('preferredLead').value;
            
            // Get selected mandatory members
            const mandatorySelect = document.getElementById('mandatoryMembers');
            const mandatoryMembers = Array.from(mandatorySelect.selectedOptions).map(opt => opt.value);
            
            // Update shift configuration
            window.shiftConfig[shiftCode] = {
                startTime,
                endTime,
                minStaff,
                requiredLeads,
                requiredAssociates,
                preferredLead,
                mandatoryMembers,
                breakDuration: 30 // Default break duration
            };
            
            updateShiftConfigList();
            this.reset();
            alert('Shift configuration saved successfully!');
        });
        }

        // Update Shift Configuration List
        function updateShiftConfigList() {
            const container = document.getElementById('shiftConfigList');
            container.innerHTML = '';
            
            Object.entries(window.shiftConfig).forEach(([code, config]) => {
                const card = document.createElement('div');
                card.className = 'shift-config-card';
                
                card.innerHTML = `
                    <h4>${code}</h4>
                    <div class="details">
                        <p><strong>Time:</strong> ${config.startTime || 'Not set'} - ${config.endTime || 'Not set'}</p>
                        <p><strong>Staff Requirements:</strong> Min ${config.minStaff} (${config.requiredLeads} Leads, ${config.requiredAssociates} Associates)</p>
                        <p><strong>Preferred Lead:</strong> ${config.preferredLead || 'None'}</p>
                        <p><strong>Mandatory Members:</strong> ${config.mandatoryMembers.join(', ') || 'None'}</p>
                    </div>
                    <div class="actions">
                        <button onclick="editShiftConfig('${code}')" class="btn-secondary">Edit</button>
                        <button onclick="deleteShiftConfig('${code}')" class="btn-danger">Delete</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Edit Shift Configuration
        function editShiftConfig(code) {
            const config = window.shiftConfig[code];
            if (!config) return;
            
            document.getElementById('shiftCode').value = code;
            document.getElementById('shiftStart').value = config.startTime || '';
            document.getElementById('shiftEnd').value = config.endTime || '';
            document.getElementById('minStaff').value = config.minStaff || '';
            document.getElementById('requiredLeads').value = config.requiredLeads || 0;
            document.getElementById('requiredAssociates').value = config.requiredAssociates || 0;
            document.getElementById('preferredLead').value = config.preferredLead || '';
            
            // Set mandatory members
            const mandatorySelect = document.getElementById('mandatoryMembers');
            Array.from(mandatorySelect.options).forEach(opt => {
                opt.selected = config.mandatoryMembers.includes(opt.value);
            });
        }

        // Delete Shift Configuration
        function deleteShiftConfig(code) {
            if (confirm(`Are you sure you want to delete shift ${code}?`)) {
                delete window.shiftConfig[code];
                updateShiftConfigList();
            }
        }

        // Initialize Dashboard
        function initDashboard() {
            // Workload Distribution Chart with Enhanced Animations
            const ctx1 = document.getElementById('workloadChart').getContext('2d');
            
            // Create gradient backgrounds
            const gradient1 = ctx1.createLinearGradient(0, 0, 0, 200);
            gradient1.addColorStop(0, 'rgba(139, 95, 191, 0.9)');
            gradient1.addColorStop(0.5, 'rgba(163, 116, 208, 0.9)');
            gradient1.addColorStop(1, 'rgba(183, 148, 209, 0.9)');
            
            const gradient2 = ctx1.createLinearGradient(0, 0, 0, 200);
            gradient2.addColorStop(0, 'rgba(79, 172, 254, 0.9)');
            gradient2.addColorStop(0.5, 'rgba(0, 242, 254, 0.9)');
            gradient2.addColorStop(1, 'rgba(67, 233, 123, 0.9)');
            
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['👨‍💼 Team Leads', '👥 Team Members'],
                    datasets: [{
                        data: [2, 12],  // 2 Leads, 12 Shift Leads + Associates
                        backgroundColor: [gradient1, gradient2],
                        borderColor: ['rgba(255, 255, 255, 0.8)', 'rgba(255, 255, 255, 0.8)'],
                        borderWidth: 4,
                        hoverBorderWidth: 6,
                        hoverBorderColor: ['rgba(255, 215, 0, 0.8)', 'rgba(255, 215, 0, 0.8)'],
                        hoverBackgroundColor: [
                            'rgba(157, 115, 212, 0.9)', // Lighter purple for leads with transparency
                            'rgba(91, 192, 222, 0.9)'   // Lighter blue for associates with transparency
                        ],
                        borderRadius: 20,
                        spacing: 10,
                        offset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    layout: {
                        padding: 20
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 2500,
                        easing: 'easeOutCubic',
                        delay: (context) => context.dataIndex * 300
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                padding: 25,
                                font: {
                                    family: "'Segoe UI', system-ui, sans-serif",
                                    size: 14,
                                    weight: 600,
                                    lineHeight: 1.5
                                },
                                color: '#2d3748',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: label,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        lineWidth: 2,
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#1a202c',
                            titleFont: {
                                family: "'Segoe UI', system-ui, sans-serif",
                                size: 16,
                                weight: 600
                            },
                            bodyColor: '#4a5568',
                            bodyFont: {
                                family: "'Segoe UI', system-ui, sans-serif",
                                size: 14
                            },
                            bodySpacing: 8,
                            padding: 16,
                            borderColor: 'rgba(139, 95, 191, 0.5)',
                            borderWidth: 2,
                            cornerRadius: 12,
                            displayColors: true,
                            boxWidth: 8,
                            boxHeight: 8,
                            boxPadding: 4,
                            usePointStyle: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Team Distribution';
                                },
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return ` ${context.label}: ${context.parsed} members (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // Leave Status Chart with Enhanced Animations
            const ctx2 = document.getElementById('leaveStatusChart').getContext('2d');
            
            // Create gradients for bar chart
            const pendingGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            pendingGradient.addColorStop(0, 'rgba(255, 217, 61, 0.85)');
            pendingGradient.addColorStop(0.5, 'rgba(255, 182, 25, 0.85)');
            pendingGradient.addColorStop(1, 'rgba(255, 149, 0, 0.85)');
            
            const approvedGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            approvedGradient.addColorStop(0, 'rgba(67, 233, 123, 0.85)');
            approvedGradient.addColorStop(0.5, 'rgba(56, 208, 110, 0.85)');
            approvedGradient.addColorStop(1, 'rgba(56, 193, 114, 0.85)');
            
            const availableGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            availableGradient.addColorStop(0, 'rgba(139, 95, 191, 0.85)');
            availableGradient.addColorStop(0.5, 'rgba(118, 81, 163, 0.85)');
            availableGradient.addColorStop(1, 'rgba(107, 70, 193, 0.85)');
            
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['⏳ Pending Requests', '✅ Approved Leaves', '👥 Team Available'],
                    datasets: [{
                        data: [0, 8, 14],  // 0 Pending, 8 Approved leaves, 14 Available team members
                        backgroundColor: [pendingGradient, approvedGradient, availableGradient],
                        borderColor: ['rgba(255, 149, 0, 0.8)', 'rgba(56, 193, 114, 0.8)', 'rgba(107, 70, 193, 0.8)'],
                        borderWidth: 2,
                        borderRadius: 12,
                        borderSkipped: false,
                        hoverBackgroundColor: ['rgba(255, 184, 77, 0.9)', 'rgba(74, 222, 128, 0.9)', 'rgba(139, 95, 191, 0.9)'],
                        hoverBorderWidth: 3,
                        maxBarThickness: 50,
                        minBarLength: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 25,
                            bottom: 20,
                            left: 25
                        }
                    },
                    animation: {
                        duration: 2500,
                        easing: 'easeOutQuart',
                        delay: (context) => {
                            return context.dataIndex * 350; // Stagger animation
                        },
                        animations: {
                            y: {
                                from: 500
                            },
                            opacity: {
                                from: 0
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#8b5fbf',
                            borderWidth: 2,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label.replace(/[⏳✅👥]/g, '').trim();
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const suffix = context.label.includes('Available') ? ' team members' : ' requests';
                                    return `${value}${suffix}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(139, 95, 191, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            updateDashboardStats();
        }

        // Update Dashboard Statistics with real data
        function updateDashboardStats() {
            document.getElementById('totalEmployees').textContent = npeTeamData.length; // 14 total
            document.getElementById('activeShifts').textContent = '4'; // S1, S2, S3, S4
            document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'pending').length;
            document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'approved').length;
            
            // Update health metrics with real calculations
            const avgConsecutiveDays = calculateAverageConsecutiveDays();
            document.getElementById('avgConsecutiveDays').textContent = avgConsecutiveDays.toFixed(1);
            document.getElementById('burnoutAlerts').textContent = '0'; // No burnout alerts in current schedule
            
            // Update modern analytics dashboard
            updateModernDashboard();
        }

        // Initialize Modern Analytics Dashboard
        function updateModernDashboard() {
            updateKPICards();
            updateHealthMetrics();
            updateAIInsights();
            updateActivityFeed();
        }

        // Update KPI Cards with real data
        function updateKPICards() {
            // Team Strength
            const teamStrengthEl = document.querySelector('.kpi-card.primary .kpi-value');
            if (teamStrengthEl) teamStrengthEl.textContent = npeTeamData.length;

            // Schedule Efficiency
            const efficiencyEl = document.querySelector('.kpi-card.success .kpi-value');
            if (efficiencyEl) efficiencyEl.textContent = '94%';

            // Pending Requests
            const pendingEl = document.querySelector('.kpi-card.warning .kpi-value');
            if (pendingEl) pendingEl.textContent = leaveRequests.filter(l => l.status === 'pending').length;

            // AI Predictions
            const aiEl = document.querySelector('.kpi-card.info .kpi-value');
            if (aiEl) aiEl.textContent = '8';
        }

        // Update Health Metrics with circular progress
        function updateHealthMetrics() {
            updateCircularProgress('staffing-circle', 85, '#10b981');
            updateCircularProgress('balance-circle', 72, '#3b82f6');
            updateCircularProgress('satisfaction-circle', 91, '#f59e0b');
        }

        function updateCircularProgress(id, percentage, color) {
            const chart = document.getElementById(id);
            if (!chart) return;

            const circle = chart.querySelector('.circle');
            const percentageText = chart.querySelector('.percentage');
            
            if (circle && percentageText) {
                const radius = 30;
                const circumference = 2 * Math.PI * radius;
                const strokeDasharray = circumference;
                const strokeDashoffset = circumference - (percentage / 100) * circumference;
                
                circle.style.strokeDasharray = strokeDasharray;
                circle.style.strokeDashoffset = strokeDashoffset;
                circle.style.stroke = color;
                
                percentageText.textContent = `${percentage}%`;
            }
        }

        // Update AI Insights
        function updateAIInsights() {
            const insightsContainer = document.querySelector('.insights-list');
            if (!insightsContainer) return;

            const insights = [
                {
                    type: 'positive',
                    icon: '✅',
                    title: 'Optimal Coverage Detected',
                    description: 'All shifts are properly staffed with minimal overtime requirements.'
                },
                {
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Weekend Coverage Opportunity',
                    description: 'Consider rotating weekend assignments to improve work-life balance.'
                },
                {
                    type: 'info',
                    icon: '💡',
                    title: 'AI Recommendation',
                    description: 'Pattern analysis suggests reducing consecutive night shifts for better rest periods.'
                }
            ];

            insightsContainer.innerHTML = insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <span class="insight-icon">${insight.icon}</span>
                    <div>
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update Activity Feed
        function updateActivityFeed() {
            const feedContainer = document.querySelector('.activity-feed');
            if (!feedContainer) return;

            const activities = [
                {
                    time: '2 minutes ago',
                    content: '<span class="activity-user">System</span> generated new roster for <span class="activity-highlight">August 2025</span>'
                },
                {
                    time: '15 minutes ago',
                    content: '<span class="activity-user">AI Assistant</span> analyzed workload patterns and identified optimization opportunities'
                },
                {
                    time: '1 hour ago',
                    content: '<span class="activity-user">Manager</span> approved leave request for <span class="activity-highlight">Weekend Coverage</span>'
                },
                {
                    time: '3 hours ago',
                    content: '<span class="activity-user">System</span> imported team data and updated <span class="activity-highlight">14 employee profiles</span>'
                }
            ];

            feedContainer.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-time">${activity.time}</div>
                    <div class="activity-content">${activity.content}</div>
                </div>
            `).join('');
        }

        // Calculate average consecutive working days from real schedule
        function calculateAverageConsecutiveDays() {
            let totalConsecutiveDays = 0;
            let employeeCount = 0;
            
            npeTeamData.forEach(employee => {
                let consecutiveDays = 0;
                let maxConsecutive = 0;
                
                // Check each day in August 2025
                for (let day = 1; day <= 31; day++) {
                    const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                    const daySchedule = scheduleData[dateStr];
                    
                    if (daySchedule) {
                        let isWorking = false;
                        Object.values(daySchedule).forEach(shift => {
                            if (shift.includes(employee.name)) {
                                isWorking = true;
                            }
                        });
                        
                        if (isWorking) {
                            consecutiveDays++;
                            maxConsecutive = Math.max(maxConsecutive, consecutiveDays);
                        } else {
                            consecutiveDays = 0;
                        }
                    }
                }
                
                totalConsecutiveDays += maxConsecutive;
                employeeCount++;
            });
            
            return employeeCount > 0 ? totalConsecutiveDays / employeeCount : 0;
        }

        // Load Team Data with real employee information
        function loadTeamData() {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';
            
            npeTeamData.forEach(member => {
                const row = document.createElement('tr');
                const daysOffText = member.daysOff.map(day => {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    return days[day];
                }).join(', ');
                
                let roleColor = '#8b5fbf'; // Default purple
                if (member.role === 'Lead') roleColor = '#dc3545'; // Red for leads
                else if (member.role === 'Shift Lead') roleColor = '#ffc107'; // Orange for shift leads
                else if (member.role === 'Associate') roleColor = '#28a745'; // Green for associates
                
                row.innerHTML = `
                    <td><strong>${member.cts}</strong></td>
                    <td><code>${member.eshc}</code></td>
                    <td><strong>${member.name}</strong></td>
                    <td><span style="padding: 3px 8px; border-radius: 12px; font-size: 12px; background: ${roleColor}; color: white;">${member.role}</span></td>
                    <td><span style="color: green;">✓ ${member.status}</span></td>
                    <td>${daysOffText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize Leave Management
        function initLeaveManagement() {
            // Populate employee select
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">Select Employee</option>';
            npeTeamData.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').value = today;

            updateLeaveRequests();
            generateLeaveCalendar();
        }

        // Handle Leave Request Form (if it exists)
        const leaveRequestForm = document.getElementById('leaveRequestForm');
        if (leaveRequestForm) {
            leaveRequestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const employeeId = document.getElementById('employeeSelect').value;
                const leaveDate = document.getElementById('leaveDate').value;
                const leaveType = document.getElementById('leaveType').value;
                const leaveReason = document.getElementById('leaveReason').value;
            
            if (!employeeId || !leaveDate || !leaveType) {
                alert('Please fill all required fields!');
                return;
            }

            const employee = npeTeamData.find(e => e.id === employeeId);
            const request = {
                id: Date.now().toString(),
                employeeId: employeeId,
                employeeName: employee.name,
                date: leaveDate,
                type: leaveType,
                reason: leaveReason,
                status: 'pending',
                requestDate: new Date().toISOString()
            };

            leaveRequests.push(request);
            updateLeaveRequests();
            updateDashboardStats();
            
            // Reset form
            this.reset();
            document.getElementById('leaveDate').value = new Date().toISOString().split('T')[0];
            
            alert('Leave request submitted successfully!');
        });
        }

        // Update Leave Requests Display
        function updateLeaveRequests() {
            const container = document.getElementById('pendingLeavesList');
            const pendingLeaves = leaveRequests.filter(l => l.status === 'pending');
            
            if (pendingLeaves.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No pending leave requests</p>';
                return;
            }
            
            container.innerHTML = pendingLeaves.map(leave => `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${leave.employeeName}</strong>
                        <span style="font-size: 12px; color: var(--text-light);">${leave.date}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #ffc107; color: white;">${leave.type}</span>
                    </div>
                    ${leave.reason ? `<p style="font-size: 14px; margin-bottom: 10px;">${leave.reason}</p>` : ''}
                    <div>
                        <button class="btn btn-success" style="padding: 5px 12px; margin-right: 5px;" onclick="approveLeave('${leave.id}')">✓ Approve</button>
                        <button class="btn btn-danger" style="padding: 5px 12px;" onclick="rejectLeave('${leave.id}')">✗ Reject</button>
                    </div>
                </div>
            `).join('');
        }

        // Approve Leave Request
        function approveLeave(leaveId) {
            const leave = leaveRequests.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'approved';
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                alert(`Leave approved for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Reject Leave Request
        function rejectLeave(leaveId) {
            const index = leaveRequests.findIndex(l => l.id === leaveId);
            if (index !== -1) {
                const leave = leaveRequests[index];
                leaveRequests.splice(index, 1);
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                alert(`Leave rejected for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Generate Leave Calendar
        function generateLeaveCalendar() {
            const container = document.getElementById('leaveCalendar');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear calendar
            container.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.fontWeight = 'bold';
                header.style.textAlign = 'center';
                header.style.padding = '10px 5px';
                header.style.background = 'var(--primary-color)';
                header.style.color = 'white';
                header.style.borderRadius = '5px';
                header.style.fontSize = '12px';
                header.textContent = day;
                container.appendChild(header);
            });
            
            // Add empty cells for days before month start
            const firstDay = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                container.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const leavesForDay = leaveRequests.filter(l => l.date === dateStr && l.status === 'approved');
                
                if (leavesForDay.length > 0) {
                    dayElement.classList.add('has-leave');
                    
                    // Create employees container
                    const employeesContainer = document.createElement('div');
                    employeesContainer.className = 'leave-employees';
                    
                    leavesForDay.forEach(leave => {
                        const employeeItem = document.createElement('div');
                        employeeItem.className = 'leave-employee-item';
                        
                        const employeeName = document.createElement('span');
                        employeeName.className = 'leave-employee-name';
                        employeeName.textContent = leave.employeeName;
                        employeeItem.appendChild(employeeName);
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-leave-btn';
                        cancelBtn.innerHTML = '×';
                        cancelBtn.title = `Cancel leave for ${leave.employeeName}`;
                        cancelBtn.onclick = (e) => {
                            e.stopPropagation();
                            cancelLeave(leave.employeeName, dateStr);
                        };
                        employeeItem.appendChild(cancelBtn);
                        
                        employeesContainer.appendChild(employeeItem);
                    });
                    
                    dayElement.appendChild(employeesContainer);
                }
                
                container.appendChild(dayElement);
            }
        }

        // Function to cancel leave
        function cancelLeave(employeeName, dateStr) {
            const confirmation = confirm(`Cancel leave for ${employeeName} on ${dateStr}?`);
            if (confirmation) {
                // Remove the leave from the array
                const leaveIndex = leaveRequests.findIndex(l => 
                    l.employeeName === employeeName && 
                    l.date === dateStr && 
                    l.status === 'approved'
                );
                
                if (leaveIndex !== -1) {
                    leaveRequests.splice(leaveIndex, 1);
                    
                    // Update the leave calendar
                    generateLeaveCalendar();
                    
                    // Update the leave requests display
                    updateLeaveRequests();
                    
                    // Show success message
                    showNotification(`Leave cancelled for ${employeeName} on ${dateStr}`, 'success');
                }
            }
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#28a745';
                    break;
                case 'error':
                    notification.style.background = '#dc3545';
                    break;
                default:
                    notification.style.background = '#17a2b8';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Schedule Generation
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('startDate').value;
            const numDays = parseInt(document.getElementById('numDays').value);
            
            if (!startDate) {
                alert('Please select a start date!');
                return;
            }
            
            generateSchedule(startDate, numDays);
        });

        // Generate AI Schedule
        function generateSchedule(startDate, numDays) {
            const output = document.getElementById('scheduleOutput');
            output.innerHTML = '<p style="text-align: center;">🤖 AI is generating health-conscious schedule...</p>';
            
            // Simulate AI processing
            setTimeout(() => {
                const schedule = createHealthConsciousSchedule(startDate, numDays);
                displaySchedule(schedule);
            }, 2000);
        }

        // Create Health-Conscious Schedule
        function createHealthConsciousSchedule(startDate, numDays) {
            const schedule = {};
            const shifts = ['S1', 'S2', 'S3'];
            const requirements = {
                'S1': { 'Lead': 2, 'Associate': 4 },
                'S2': { 'Lead': 2, 'Associate': 4 },
                'S3': { 'Lead': 1, 'Associate': 2 }
            };
            
            // Track consecutive days for each employee
            const consecutiveDays = {};
            npeTeamData.forEach(emp => consecutiveDays[emp.id] = 0);
            
            for (let i = 0; i < numDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay();
                
                schedule[dateStr] = {};
                
                // Check for approved leaves
                const approvedLeaves = leaveRequests.filter(l => l.date === dateStr && l.status === 'approved');
                const employeesOnLeave = approvedLeaves.map(l => l.employeeId);
                
                shifts.forEach(shift => {
                    schedule[dateStr][shift] = {};
                    
                    Object.keys(requirements[shift]).forEach(role => {
                        const needed = requirements[shift][role];
                        const availableEmployees = npeTeamData.filter(emp => 
                            emp.role === role && 
                            !employeesOnLeave.includes(emp.id) &&
                            consecutiveDays[emp.id] < 6 && // Health rule: max 6 consecutive days
                            !emp.daysOff.includes(dayOfWeek) // Respect preferred days off
                        ).sort((a, b) => consecutiveDays[a.id] - consecutiveDays[b.id]); // Prioritize those with fewer consecutive days
                        
                        schedule[dateStr][shift][role] = availableEmployees.slice(0, needed).map(emp => {
                            consecutiveDays[emp.id]++;
                            return emp.name;
                        });
                    });
                });
                
                // Reset consecutive days counter for employees who get a day off
                npeTeamData.forEach(emp => {
                    const isWorking = shifts.some(shift => 
                        Object.values(schedule[dateStr][shift]).some(roleAssignments => 
                            roleAssignments.includes(emp.name)
                        )
                    );
                    if (!isWorking) {
                        consecutiveDays[emp.id] = 0;
                    }
                });
            }
            
            scheduleData = schedule;
            return schedule;
        }

        // Display Generated Schedule
        function displaySchedule(schedule) {
            const output = document.getElementById('scheduleOutput');
            let html = '<div class="alert alert-success">✅ Health-conscious schedule generated successfully!</div>';
            
            html += '<table class="table" style="font-size: 12px;"><thead><tr><th>Date</th><th>S1 (Morning)</th><th>S2 (Afternoon)</th><th>S3 (Night)</th></tr></thead><tbody>';
            
            Object.keys(schedule).forEach(date => {
                const daySchedule = schedule[date];
                html += `<tr><td><strong>${date}</strong></td>`;
                
                ['S1', 'S2', 'S3'].forEach(shift => {
                    const shiftData = daySchedule[shift];
                    let shiftText = '';
                    
                    Object.keys(shiftData).forEach(role => {
                        const employees = shiftData[role];
                        if (employees.length > 0) {
                            shiftText += `<div><strong>${role}s:</strong> ${employees.join(', ')}</div>`;
                        }
                    });
                    
                    html += `<td>${shiftText || 'No assignments'}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            output.innerHTML = html;
        }

        // Download Schedule as Excel in SharePoint Format with FULL FORMATTING
        async function downloadSchedule() {
            try {
                // Create new workbook with ExcelJS (supports formatting!)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Shift Roster - Format');
                
                // Set up basic worksheet properties
                worksheet.properties.defaultRowHeight = 20;
                
                // Row 1: Header with QA&DOD, UAT sections
                const row1 = worksheet.getRow(1);
                row1.getCell(8).value = 'QA&DOD';
                row1.getCell(9).value = 'UAT';
                
                // Style the header row
                row1.getCell(8).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                row1.getCell(9).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(9).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                
                // Row 3: Date headers
                const row3 = worksheet.getRow(3);
                row3.getCell(4).value = 'Date/Month/Year';
                row3.getCell(4).font = { bold: true };
                
                for (let day = 1; day <= 31; day++) {
                    const formattedDate = String(day).padStart(2, '0') + '-Aug-25';
                    const cell = row3.getCell(5 + day);
                    cell.value = formattedDate;
                    cell.font = { bold: true, size: 10 };
                    cell.alignment = { horizontal: 'center' };
                }
                
                // Row 4: Column headers and day names
                const row4 = worksheet.getRow(4);
                row4.getCell(4).value = 'CTS';
                row4.getCell(5).value = 'ESHC';
                row4.getCell(6).value = 'Name';
                
                // Style column headers
                [4, 5, 6].forEach(col => {
                    const cell = row4.getCell(col);
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' }, bottom: { style: 'thin' },
                        left: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
                
                for (let day = 1; day <= 31; day++) {
                    const date = new Date(2025, 7, day);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    const cell = row4.getCell(6 + day);
                    cell.value = dayName;
                    cell.font = { bold: true, size: 9 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                }
                
                // Employee rows with formatting
                let currentRow = 5;
                npeTeamData.forEach((employee, empIndex) => {
                    const row = worksheet.getRow(currentRow);
                    
                    // Employee info columns
                    row.getCell(4).value = employee.cts;
                    row.getCell(5).value = employee.eshc;
                    row.getCell(6).value = employee.name;
                    
                    // Style employee info
                    [4, 5, 6].forEach(col => {
                        const cell = row.getCell(col);
                        cell.font = { bold: col === 6 }; // Bold name only
                        cell.alignment = { horizontal: col === 6 ? 'left' : 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    });
                    
                    // Daily assignments with color coding
                    for (let day = 1; day <= 31; day++) {
                        const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                        const daySchedule = realAugust2025Schedule[dateStr] || {};
                        
                        let assignment = 'OFF';
                        
                        // Check which shift the employee is assigned to
                        Object.keys(daySchedule).forEach(shift => {
                            if (daySchedule[shift] && daySchedule[shift].includes(employee.name)) {
                                assignment = shift;
                            }
                        });
                        
                        // Check for leaves
                        const leave = realLeaveData.find(l => 
                            l.employeeName === employee.name && 
                            l.date === dateStr && 
                            l.status === 'approved'
                        );
                        
                        if (leave) {
                            assignment = 'Leave';
                        }
                        
                        const cell = row.getCell(6 + day);
                        cell.value = assignment;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: assignment !== 'OFF', size: 10 };
                        
                        // Color coding based on assignment and WFO policy using Chennai timezone
                        if (assignment === 'Leave') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Bright red
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else if (assignment === 'OFF') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF808080' } }; // Gray
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else {
                            // Check if it's weekend using Chennai timezone
                            const currentDate = new Date(2025, 7, day);
                            const isWeekend = isWeekendInChennai(currentDate);
                            
                            if (isWeekend) {
                                // Weekend work = WFH (Strong Blue highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0066CC' } }; // Strong blue
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            } else {
                                // Weekday work = WFO (Strong Green highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00AA00' } }; // Strong green
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            }
                        }
                        
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    
                    currentRow++;
                });
                
                // Add summary rows for shift counts
                currentRow += 1; // Add space
                
                ['S1', 'S2', 'S3'].forEach(shiftType => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(6).value = shiftType;
                    row.getCell(6).font = { bold: true };
                    row.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                    
                    for (let day = 1; day <= 31; day++) {
                        const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                        const daySchedule = realAugust2025Schedule[dateStr] || {};
                        const count = (daySchedule[shiftType] || []).length;
                        
                        const cell = row.getCell(6 + day);
                        cell.value = count;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: true };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    currentRow++;
                });
                
                // Add shift timing legend
                currentRow += 2;
                const legendData = [
                    ['S1', '06:00 AM TO 04:00 PM IST'],
                    ['S2', '01:00 PM TO 11:00 PM IST'],
                    ['S3', '10:00 PM TO 08:00 AM IST'],
                    ['S4', '12:30 PM TO 10:30 PM IST'],
                    ['G', '09:00 AM TO 07:00 PM IST'],
                    ['P', '06:30 PM TO 04:30 AM IST'],
                    ['HIH', '11:30 AM TO 08:30 PM IST']
                ];
                
                legendData.forEach(([shift, time]) => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(2).value = shift;
                    row.getCell(3).value = time;
                    
                    row.getCell(2).font = { bold: true };
                    row.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9EAD3' } };
                    currentRow++;
                });
                
                // Add team structure
                currentRow += 2;
                const teamData = [
                    ['LeadS'],
                    ['593300', 'EH0647', 'Dinesh Anbalagan'],
                    ['560008', 'EG4208', 'Mano'],
                    ['Shift Leads'],
                    ['410093', 'EH6832', 'Jeyakaran'],
                    ['2167353', 'C7H8KH', 'Karthikeyan'],
                    ['2054459', 'C6X8FS', 'Panner'],
                    ['2240608', 'C7T7SF', 'Sai Kumar'],
                    ['2136623', 'C8G3CW', 'Manoj']
                ];
                
                teamData.forEach(rowData => {
                    const row = worksheet.getRow(currentRow);
                    rowData.forEach((value, colIndex) => {
                        const cell = row.getCell(colIndex + 1);
                        cell.value = value;
                        if (rowData.length === 1) { // Headers
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                        }
                    });
                    currentRow++;
                });
                
                // Set column widths
                worksheet.getColumn(4).width = 10; // CTS
                worksheet.getColumn(5).width = 8;  // ESHC
                worksheet.getColumn(6).width = 15; // Name
                for (let i = 7; i <= 37; i++) {
                    worksheet.getColumn(i).width = 7; // Date columns
                }
                
                // Generate and download the file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const fileName = `Shift_Roster_Format_August_2025_WITH_COLORS.xlsx`;
                saveAs(blob, fileName);
                
                // Show success message
                alert(`🎨 Excel exported with FULL FORMATTING!\n\nFile: ${fileName}\n\n✅ Features:\n🟢 GREEN highlighting for WFO assignments\n� RED highlighting for leaves\n⚪ GRAY for OFF days\n📊 Professional borders and fonts\n� Ready for SharePoint!`);
                
            } catch (error) {
                console.error('Excel export error:', error);
                alert(`❌ Export failed: ${error.message}`);
            }
        }

        // Export AI-generated roster to SharePoint Excel format with FULL FORMATTING
        async function exportGeneratedRosterToSharePoint(startDate, endDate) {
            try {
                // Create new workbook with ExcelJS (supports full formatting!)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('AI Generated Roster');
                
                // Set up basic worksheet properties
                worksheet.properties.defaultRowHeight = 20;
                
                // Row 1: Header with QA&DOD, UAT sections
                const row1 = worksheet.getRow(1);
                row1.getCell(8).value = 'QA&DOD';
                row1.getCell(9).value = 'UAT';
                
                // Style the header row
                row1.getCell(8).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                row1.getCell(9).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(9).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                
                // Calculate date range for export
                const start = new Date(startDate);
                const end = new Date(endDate);
                const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // Row 3: Date headers
                const row3 = worksheet.getRow(3);
                row3.getCell(4).value = 'Date/Month/Year';
                row3.getCell(4).font = { bold: true };
                
                for (let i = 0; i < totalDays && i < 31; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    const day = currentDate.getDate();
                    const formattedDate = String(day).padStart(2, '0') + '-Aug-25';
                    const cell = row3.getCell(7 + i);
                    cell.value = formattedDate;
                    cell.font = { bold: true, size: 10 };
                    cell.alignment = { horizontal: 'center' };
                }
                
                // Row 4: Column headers and day names
                const row4 = worksheet.getRow(4);
                row4.getCell(4).value = 'CTS';
                row4.getCell(5).value = 'ESHC';
                row4.getCell(6).value = 'Name';
                
                // Style column headers
                [4, 5, 6].forEach(col => {
                    const cell = row4.getCell(col);
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' }, bottom: { style: 'thin' },
                        left: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
                
                for (let i = 0; i < totalDays && i < 31; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const cell = row4.getCell(7 + i);
                    cell.value = dayName;
                    cell.font = { bold: true, size: 9 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                }
                
                // Employee rows with AI-generated data and formatting
                let currentRow = 5;
                npeTeamData.forEach((employee, empIndex) => {
                    const row = worksheet.getRow(currentRow);
                    
                    // Employee info columns
                    row.getCell(4).value = employee.cts;
                    row.getCell(5).value = employee.eshc;
                    row.getCell(6).value = employee.name;
                    
                    // Style employee info
                    [4, 5, 6].forEach(col => {
                        const cell = row.getCell(col);
                        cell.font = { bold: col === 6 }; // Bold name only
                        cell.alignment = { horizontal: col === 6 ? 'left' : 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    });
                    
                    // Daily assignments with color coding
                    for (let i = 0; i < totalDays && i < 31; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        // Get assignment from AI-generated schedule or fall back to real data
                        const daySchedule = lastGeneratedSchedule && lastGeneratedSchedule[dateStr] 
                            ? lastGeneratedSchedule[dateStr] 
                            : realAugust2025Schedule[dateStr] || {};
                        
                        let assignment = 'OFF';
                        
                        // Check which shift the employee is assigned to
                        Object.keys(daySchedule).forEach(shift => {
                            if (daySchedule[shift] && daySchedule[shift].includes(employee.name)) {
                                assignment = shift;
                            }
                        });
                        
                        // Check for leaves
                        const leave = realLeaveData.find(l => 
                            l.employeeName === employee.name && 
                            l.date === dateStr && 
                            l.status === 'approved'
                        );
                        
                        if (leave) {
                            assignment = 'Leave';
                        }
                        
                        const cell = row.getCell(7 + i);
                        cell.value = assignment;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: assignment !== 'OFF', size: 10 };
                        
                        // Color coding based on assignment and WFO policy using Chennai timezone
                        if (assignment === 'Leave') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Bright red
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else if (assignment === 'OFF') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF808080' } }; // Gray
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else {
                            // Check if it's weekend using Chennai timezone
                            const currentDate = new Date(start);
                            currentDate.setDate(start.getDate() + i);
                            const isWeekend = isWeekendInChennai(currentDate);
                            
                            if (isWeekend) {
                                // Weekend work = WFH (Strong Blue highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0066CC' } }; // Strong blue
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            } else {
                                // Weekday work = WFO (Strong Green highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00AA00' } }; // Strong green
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            }
                        }
                        
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    
                    currentRow++;
                });
                
                // Add summary rows for shift counts
                currentRow += 1; // Add space
                
                ['S1', 'S2', 'S3'].forEach(shiftType => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(6).value = shiftType;
                    row.getCell(6).font = { bold: true };
                    row.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                    
                    for (let i = 0; i < totalDays && i < 31; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        const daySchedule = lastGeneratedSchedule && lastGeneratedSchedule[dateStr] 
                            ? lastGeneratedSchedule[dateStr] 
                            : realAugust2025Schedule[dateStr] || {};
                        
                        const count = (daySchedule[shiftType] || []).length;
                        
                        const cell = row.getCell(7 + i);
                        cell.value = count;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: true };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    currentRow++;
                });
                
                // Add shift timing legend
                currentRow += 2;
                const legendData = [
                    ['S1', '06:00 AM TO 04:00 PM IST'],
                    ['S2', '01:00 PM TO 11:00 PM IST'],
                    ['S3', '10:00 PM TO 08:00 AM IST'],
                    ['S4', '12:30 PM TO 10:30 PM IST'],
                    ['G', '09:00 AM TO 07:00 PM IST'],
                    ['P', '06:30 PM TO 04:30 AM IST'],
                    ['HIH', '11:30 AM TO 08:30 PM IST']
                ];
                
                legendData.forEach(([shift, time]) => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(2).value = shift;
                    row.getCell(3).value = time;
                    
                    row.getCell(2).font = { bold: true };
                    row.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9EAD3' } };
                    currentRow++;
                });
                
                // Add team structure
                currentRow += 2;
                const teamData = [
                    ['LeadS'],
                    ['593300', 'EH0647', 'Dinesh Anbalagan'],
                    ['560008', 'EG4208', 'Mano'],
                    ['Shift Leads'],
                    ['410093', 'EH6832', 'Jeyakaran'],
                    ['2167353', 'C7H8KH', 'Karthikeyan'],
                    ['2054459', 'C6X8FS', 'Panner'],
                    ['2240608', 'C7T7SF', 'Sai Kumar'],
                    ['2136623', 'C8G3CW', 'Manoj']
                ];
                
                teamData.forEach(rowData => {
                    const row = worksheet.getRow(currentRow);
                    rowData.forEach((value, colIndex) => {
                        const cell = row.getCell(colIndex + 1);
                        cell.value = value;
                        if (rowData.length === 1) { // Headers
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                        }
                    });
                    currentRow++;
                });
                
                // Set column widths
                worksheet.getColumn(4).width = 10; // CTS
                worksheet.getColumn(5).width = 8;  // ESHC
                worksheet.getColumn(6).width = 15; // Name
                for (let i = 7; i <= 37; i++) {
                    worksheet.getColumn(i).width = 7; // Date columns
                }
                
                // Generate and download the file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const fileName = `AI_Generated_Roster_${startDate}_to_${endDate}_WITH_COLORS.xlsx`;
                saveAs(blob, fileName);
                
                // Show success message
                alert(`🤖 AI-Generated Roster exported with FULL FORMATTING!\n\nFile: ${fileName}\n\n✅ Features:\n🟢 GREEN highlighting for WFO assignments\n� RED highlighting for leaves\n⚪ GRAY for OFF days\n📊 Professional borders and fonts\n🎯 Generated using your custom rules!\n✨ Ready for SharePoint!`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`❌ Export failed: ${error.message}`);
            }
        }

        // Store the last generated schedule for export
        let lastGeneratedSchedule = null;

        // Initialize Reports
        function initReports() {
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            // Create gradient for line chart
            const lineGradient = ctx.createLinearGradient(0, 0, 0, 200);
            lineGradient.addColorStop(0, 'rgba(139, 95, 191, 0.8)');
            lineGradient.addColorStop(0.5, 'rgba(139, 95, 191, 0.4)');
            lineGradient.addColorStop(1, 'rgba(139, 95, 191, 0.1)');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['📅 Week 1', '📅 Week 2', '📅 Week 3', '📅 Week 4'],
                    datasets: [{
                        label: 'Average Working Days',
                        data: [4.2, 4.1, 4.3, 4.0],
                        borderColor: '#8b5fbf',
                        backgroundColor: lineGradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#8b5fbf',
                        pointBorderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#ffd700',
                        pointHoverBorderColor: '#8b5fbf',
                        pointHoverBorderWidth: 4,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2500,
                        easing: 'easeInOutCubic',
                        delay: (context) => {
                            return context.dataIndex * 200;
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#8b5fbf',
                            borderWidth: 2,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label.replace('📅 ', '');
                                },
                                label: function(context) {
                                    return `Average: ${context.parsed.y} days per week`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 7,
                            grid: {
                                color: 'rgba(139, 95, 191, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value + ' days';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initDashboard();
                
                // Set default start date to today
                const startDateElement = document.getElementById('startDate');
                if (startDateElement) {
                    const today = new Date().toISOString().split('T')[0];
                    startDateElement.value = today;
                }
                
                // Register Service Worker for PWA functionality
                registerServiceWorker();
            
            // Add install app prompt
            setupInstallPrompt();
            } catch (error) {
                console.error('Error during app initialization:', error);
                // Continue with basic functionality even if some features fail
            }
        });

        // PWA Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('NPE ShiftBot: Service Worker registered successfully', registration);
                } catch (error) {
                    console.log('NPE ShiftBot: Service Worker registration failed', error);
                }
            }
        }

        // PWA Install Prompt
        let deferredPrompt;
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                showInstallButton();
            });
        }

        function showInstallButton() {
            // Create install button
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-success';
            installBtn.innerHTML = '📱 Install App';
            installBtn.style.position = 'fixed';
            installBtn.style.bottom = '20px';
            installBtn.style.right = '20px';
            installBtn.style.zIndex = '1000';
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`NPE ShiftBot: User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
        }

        // Enhanced Local Storage with compression
        const Storage = {
            set: (key, value) => {
                try {
                    const compressed = JSON.stringify(value);
                    localStorage.setItem(`npe-shiftbot-${key}`, compressed);
                } catch (error) {
                    console.error('Storage error:', error);
                }
            },
            get: (key) => {
                try {
                    const item = localStorage.getItem(`npe-shiftbot-${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error('Storage error:', error);
                    return null;
                }
            },
            remove: (key) => {
                localStorage.removeItem(`npe-shiftbot-${key}`);
            }
        };

        // Auto-save functionality
        function autoSave() {
            Storage.set('leaveRequests', leaveRequests);
            Storage.set('scheduleData', scheduleData);
            Storage.set('lastSaved', new Date().toISOString());
        }

        // Load saved data on startup
        function loadSavedData() {
            const savedLeaves = Storage.get('leaveRequests');
            const savedSchedule = Storage.get('scheduleData');
            
            if (savedLeaves) {
                leaveRequests = savedLeaves;
            }
            
            if (savedSchedule) {
                scheduleData = savedSchedule;
            }
        }

        // OpenAI API Key Management (Session-based, secure)
        let sessionApiKey = null;

        function getApiKey() {
            if (sessionApiKey) {
                return sessionApiKey;
            }
            
            const key = prompt('🔑 Please enter your OpenAI API Key for AI-powered analysis:\n(This will be stored securely in this session only)');
            if (key && key.trim()) {
                sessionApiKey = key.trim();
                return sessionApiKey;
            }
            return null;
        }

        function saveApiKey(key) {
            sessionApiKey = key;
        }

        function clearApiKey() {
            sessionApiKey = null;
            alert('🔑 API Key cleared from session.');
        }

        // Custom Rules Management
        let userCustomRules = {
            shiftRules: [],
            teamRules: [],
            timingRules: [],
            restrictionRules: [],
            priorityRules: []
        };

        // Get Custom Rules from User
        function getCustomRulesFromUser() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                margin: 20px;
            `;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">📋 Define Your Custom Roster Rules</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    OpenAI will <strong>strictly follow only these rules</strong> - no other patterns will be applied.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <h4>🔄 Shift Rules & Patterns:</h4>
                    <textarea id="shiftRules" placeholder="Example:
- S1 shift requires 1 Lead + 2 Associates
- S2 shift requires 1 Lead + 1 Associate  
- Night shifts (S3) require experienced staff only
- Weekend shifts need reduced staffing" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>👥 Team & Role Rules:</h4>
                    <textarea id="teamRules" placeholder="Example:
- Karthikeyan must work S1 shifts only
- Leads cannot work consecutive night shifts
- Associates should rotate between S1 and S2
- Specific employees for specific shifts" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>⏰ Timing & Schedule Rules:</h4>
                    <textarea id="timingRules" placeholder="Example:
- Maximum 6 consecutive working days
- Minimum 12 hours rest between shifts
- No S3 to S1 consecutive shifts (night to morning)
- Weekends have reduced requirements" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>🚫 Restrictions & Constraints:</h4>
                    <textarea id="restrictionRules" placeholder="Example:
- Certain employees cannot work together
- Some staff unavailable on specific days
- Holiday restrictions
- Leave considerations" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>⭐ Priority Rules:</h4>
                    <textarea id="priorityRules" placeholder="Example:
- Senior staff gets first preference for preferred shifts
- Equal distribution of weekend duties
- Maintain work-life balance priorities
- Fair overtime distribution" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;"></textarea>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="saveCustomRules()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">💾 Save Rules & Continue</button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">Cancel</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Load existing rules if any
            const savedRules = Storage.get('userCustomRules');
            if (savedRules) {
                document.getElementById('shiftRules').value = savedRules.shiftRules.join('\n');
                document.getElementById('teamRules').value = savedRules.teamRules.join('\n');
                document.getElementById('timingRules').value = savedRules.timingRules.join('\n');
                document.getElementById('restrictionRules').value = savedRules.restrictionRules.join('\n');
                document.getElementById('priorityRules').value = savedRules.priorityRules.join('\n');
            }
            
            window.saveCustomRules = function() {
                const shiftRules = document.getElementById('shiftRules').value.split('\n').filter(rule => rule.trim());
                const teamRules = document.getElementById('teamRules').value.split('\n').filter(rule => rule.trim());
                const timingRules = document.getElementById('timingRules').value.split('\n').filter(rule => rule.trim());
                const restrictionRules = document.getElementById('restrictionRules').value.split('\n').filter(rule => rule.trim());
                const priorityRules = document.getElementById('priorityRules').value.split('\n').filter(rule => rule.trim());
                
                userCustomRules = {
                    shiftRules,
                    teamRules,
                    timingRules,
                    restrictionRules,
                    priorityRules
                };
                
                Storage.set('userCustomRules', userCustomRules);
                modal.remove();
                
                alert('✅ Custom rules saved! OpenAI will now strictly follow these rules for roster generation.');
            };
        }

        // OpenAI Integration for Custom Rule-Based Roster Generation
        async function generateRosterWithCustomRules(teamData, scheduleData, startDate, endDate, apiKey) {
            if (!apiKey) {
                throw new Error('OpenAI API key is required');
            }

            const chennaiTime = getChennaiTime();
            const chennaiDate = getChennaiDate();
            const weekendCount = countWeekendsInRange(new Date(startDate), new Date(endDate));

            const customRulesText = `
STRICT CUSTOM RULES - FOLLOW THESE EXACTLY:

ULTIMATE RULE (MOST IMPORTANT):
- Count of Saturday & Sunday = Count of each employee OFF days
- Weekend count in this period: ${weekendCount} days
- Each employee must have exactly ${weekendCount} OFF days

CHENNAI TIMEZONE AWARENESS:
- Current Chennai time: ${chennaiTime}
- All calculations must respect Asia/Kolkata timezone
- Saturday/Sunday work = WFH ONLY (Blue highlighting in Excel)
- Weekday work = WFO ONLY (Green highlighting in Excel)
- Maximum 3 WFO days per employee per week

SHIFT RULES:
${userCustomRules.shiftRules.map(rule => `- ${rule}`).join('\n')}

TEAM & ROLE RULES:
${userCustomRules.teamRules.map(rule => `- ${rule}`).join('\n')}

TIMING & SCHEDULE RULES:
${userCustomRules.timingRules.map(rule => `- ${rule}`).join('\n')}

RESTRICTIONS & CONSTRAINTS:
${userCustomRules.restrictionRules.map(rule => `- ${rule}`).join('\n')}

PRIORITY RULES:
${userCustomRules.priorityRules.map(rule => `- ${rule}`).join('\n')}
            `;

            const prompt = `You are a shift roster generator. You must STRICTLY follow the custom rules provided below. Do not apply any other patterns or rules.

TEAM DATA:
${JSON.stringify(teamData, null, 2)}

EXISTING SCHEDULE DATA (for reference):
${JSON.stringify(scheduleData, null, 2)}

SCHEDULE PERIOD: ${startDate} to ${endDate}

${customRulesText}

IMPORTANT INSTRUCTIONS:
1. ULTIMATE RULE: Each employee must have exactly ${weekendCount} OFF days (matching weekend count)
2. Chennai timezone awareness: Use Asia/Kolkata for all date calculations
3. Follow ONLY the custom rules provided above
4. Saturday/Sunday assignments = WFH, Weekday assignments = WFO
5. Maximum 3 WFO days per employee per week
6. Do not apply any standard workforce management patterns
7. Strictly adhere to the user's specific requirements
8. Generate a detailed roster that meets all stated rules
9. If rules conflict, prioritize: ULTIMATE RULE > Restrictions > Timing > Team > Shift > Priority
10. Validate that weekend count equals OFF count for each employee

Generate a complete shift roster in JSON format:
{
  "YYYY-MM-DD": {
    "S1": ["employee1", "employee2"],
    "S2": ["employee3"],
    "S3": ["employee4", "employee5"],
    "S4": []
  }
}

Also provide:
1. Explanation of how each rule was applied
2. Validation that ULTIMATE RULE is satisfied for each employee
3. WFO/WFH breakdown for each employee`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',  // Using GPT-4 for better rule following
                        messages: [
                            {
                                role: 'system',
                                content: `You are a precise shift roster generator with Chennai timezone awareness that STRICTLY follows user-defined rules. Current Chennai time: ${chennaiTime}. 

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days.

You never deviate from the provided rules, always respect Asia/Kolkata timezone, ensure weekend count equals OFF count for each employee, and always explain your decisions with validation.`
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.1  // Low temperature for consistent rule following
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const content = result.choices[0]?.message?.content;
                
                if (!content) {
                    throw new Error('No response from OpenAI');
                }

                // Extract JSON and explanation from the response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const generatedSchedule = JSON.parse(jsonMatch[0]);
                        const explanation = content.replace(jsonMatch[0], '').trim();
                        
                        // Store the generated schedule for export
                        lastGeneratedSchedule = generatedSchedule;
                        
                        return {
                            schedule: generatedSchedule,
                            explanation: explanation,
                            rulesApplied: userCustomRules
                        };
                    } catch (parseError) {
                        throw new Error('Failed to parse generated schedule');
                    }
                } else {
                    throw new Error('No valid schedule found in OpenAI response');
                }
            } catch (error) {
                console.error('OpenAI Custom Rules Error:', error);
                throw error;
            }
        }

        // OpenAI Integration for Smart Excel Analysis
        async function analyzeWithOpenAI(excelData, apiKey) {
            if (!apiKey) {
                throw new Error('OpenAI API key is required');
            }

            const chennaiTime = getChennaiTime();
            const chennaiDate = getChennaiDate();
            
            const prompt = `Analyze this Excel shift roster data with Chennai timezone awareness (Current Chennai time: ${chennaiTime}):

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days (Weekend count must equal OFF count for each employee)

Excel Data Summary:
- Team Members: ${excelData.teamData?.length || 0}
- Schedule Entries: ${excelData.schedulePatterns?.length || 0}
- Leave Requests: ${excelData.leavePatterns?.length || 0}

Sample Team Data: ${JSON.stringify(excelData.teamData?.slice(0, 3) || [])}
Sample Schedule: ${JSON.stringify(excelData.schedulePatterns?.slice(0, 3) || [])}
Sample Leave: ${JSON.stringify(excelData.leavePatterns?.slice(0, 3) || [])}

CRITICAL RULES TO FOLLOW:
1. Chennai timezone awareness - All dates/times must respect Asia/Kolkata timezone
2. ULTIMATE RULE: Weekend count (Sat + Sun) = OFF count for each employee
3. Maximum 3 WFO (Work From Office) days per week per employee
4. Saturday and Sunday work = WFH (Work From Home) ONLY
5. Weekday work = WFO (Work From Office) with green highlighting in Excel
6. Weekend work = WFH with blue highlighting in Excel

Please analyze and provide:
1. Work patterns (shift preferences, rotation cycles) with Chennai timezone consideration
2. Health & wellbeing rules (consecutive days, rest periods)
3. Fairness criteria (workload distribution, weekend OFF enforcement)
4. Optimization suggestions respecting ULTIMATE RULE
5. Specific rules extracted from the data with weekend/weekday distinction

Respond in JSON format with these keys: workPatterns, healthRules, fairnessRules, optimizations, extractedRules, weekendRules, ultimateRuleCompliance`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are an AI specialist in workforce management and shift scheduling with Chennai timezone awareness. Current Chennai time: ${chennaiTime}. 

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days.

CRITICAL CONSTRAINTS:
- Always consider Asia/Kolkata timezone for all date/time calculations
- Maximum 3 WFO days per employee per week
- Saturday/Sunday work = WFH ONLY
- Weekday work = WFO
- Weekend count must equal OFF count for each employee
- Analyze data to extract patterns that promote work-life balance and operational efficiency while strictly following the ULTIMATE RULE.`
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const content = result.choices[0]?.message?.content;
                
                if (!content) {
                    throw new Error('No response from OpenAI');
                }

                try {
                    return JSON.parse(content);
                } catch (parseError) {
                    // If JSON parsing fails, create a structured response from the text
                    return {
                        workPatterns: [content.includes('shift') ? 'Flexible shift patterns detected' : 'Standard rotation cycles'],
                        healthRules: [content.includes('consecutive') ? 'Limit consecutive days' : 'Ensure adequate rest periods'],
                        fairnessRules: [content.includes('distribution') ? 'Fair workload distribution' : 'Accommodate preferences when possible'],
                        optimizations: ['AI-powered schedule optimization', 'Work-life balance enhancement'],
                        extractedRules: ['Auto-extracted from Excel data'],
                        rawResponse: content
                    };
                }
            } catch (error) {
                console.error('OpenAI Analysis Error:', error);
                throw error;
            }
        }

        // Fallback rule extraction for when OpenAI is not available
        function extractRulesFromData(excelData) {
            const rules = {
                workPatterns: [],
                healthRules: [],
                fairnessRules: [],
                optimizations: [],
                extractedRules: []
            };

            // Analyze team data
            if (excelData.teamData && excelData.teamData.length > 0) {
                const roles = [...new Set(excelData.teamData.map(t => t.role))];
                rules.workPatterns.push(`Supports ${roles.length} different roles: ${roles.join(', ')}`);
                rules.fairnessRules.push(`Ensure fair distribution across ${excelData.teamData.length} team members`);
            }

            // Analyze schedule patterns
            if (excelData.schedulePatterns && excelData.schedulePatterns.length > 0) {
                const daysWithSchedule = excelData.schedulePatterns.filter(s => 
                    s.s1_leads || s.s2_leads || s.s3_leads
                ).length;
                const coverage = ((daysWithSchedule / excelData.schedulePatterns.length) * 100).toFixed(1);
                rules.workPatterns.push(`Maintains ${coverage}% schedule coverage`);
                rules.healthRules.push('Ensure adequate rest between shifts');
            }

            // Analyze leave patterns
            if (excelData.leavePatterns && excelData.leavePatterns.length > 0) {
                const leaveTypes = [...new Set(excelData.leavePatterns.map(l => l.type))];
                rules.fairnessRules.push(`Accommodate various leave types: ${leaveTypes.join(', ')}`);
                rules.optimizations.push('Consider leave patterns in scheduling');
            }

            // Default health and optimization rules
            rules.healthRules.push('Limit consecutive working days to 6');
            rules.healthRules.push('Ensure minimum 12 hours between shifts');
            rules.optimizations.push('Balance workload across team members');
            rules.optimizations.push('Prioritize work-life balance');
            rules.extractedRules.push('Data-driven scheduling rules applied');

            return rules;
        }

        // Enhanced Schedule Generation with AI Rules
        function createAIGuidedSchedule(rules, startDate, endDate) {
            const schedule = {};
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Track consecutive days and last shift for each employee
            const employeeTracker = {};
            npeTeamData.forEach(emp => {
                employeeTracker[emp.name] = {
                    consecutiveDays: 0,
                    lastShift: null,
                    totalShifts: 0,
                    lastShiftDate: null
                };
            });

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayOfWeek = d.getDay();
                
                schedule[dateStr] = { S1: [], S2: [], S3: [], S4: [] };
                
                // Apply AI-guided scheduling rules
                Object.keys(schedule[dateStr]).forEach(shift => {
                    const availableEmployees = npeTeamData.filter(emp => {
                        // Check if employee is available (not on preferred day off)
                        if (emp.daysOff && emp.daysOff.includes(dayOfWeek)) {
                            return false;
                        }
                        
                        // Check consecutive days rule (from AI health rules)
                        const tracker = employeeTracker[emp.name];
                        if (tracker.consecutiveDays >= 6) {
                            return false;
                        }
                        
                        // Check rest period between shifts
                        if (tracker.lastShiftDate) {
                            const daysSinceLastShift = Math.floor((d - new Date(tracker.lastShiftDate)) / (1000 * 60 * 60 * 24));
                            if (daysSinceLastShift === 1 && tracker.lastShift === 'S3' && shift === 'S1') {
                                return false; // Not enough rest between night and morning shift
                            }
                        }
                        
                        return emp.status === 'Active';
                    });
                    
                    // Prioritize employees with fewer total shifts (fairness rule)
                    availableEmployees.sort((a, b) => {
                        const aShifts = employeeTracker[a.name].totalShifts;
                        const bShifts = employeeTracker[b.name].totalShifts;
                        return aShifts - bShifts;
                    });
                    
                    // Assign employees to shift based on requirements
                    const requiredCount = getShiftRequirement(shift, dayOfWeek);
                    const assignedEmployees = availableEmployees.slice(0, requiredCount);
                    
                    schedule[dateStr][shift] = assignedEmployees.map(emp => emp.name);
                    
                    // Update employee trackers
                    assignedEmployees.forEach(emp => {
                        const tracker = employeeTracker[emp.name];
                        tracker.consecutiveDays++;
                        tracker.lastShift = shift;
                        tracker.totalShifts++;
                        tracker.lastShiftDate = dateStr;
                    });
                });
                
                // Reset consecutive days for employees not working today
                Object.keys(employeeTracker).forEach(empName => {
                    const isWorkingToday = Object.values(schedule[dateStr]).some(shiftEmps => 
                        shiftEmps.includes(empName)
                    );
                    if (!isWorkingToday) {
                        employeeTracker[empName].consecutiveDays = 0;
                    }
                });
            }
            
            return schedule;
        }

        function getShiftRequirement(shift, dayOfWeek) {
            // Weekend reduced staffing
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return shift === 'S1' || shift === 'S2' ? 2 : 1;
            }
            // Weekday full staffing
            return shift === 'S1' || shift === 'S2' ? 3 : shift === 'S3' ? 2 : 1;
        }

        // Enhanced Schedule Display with AI Insights
        function displayEnhancedSchedule(schedule, rules) {
            // Show the schedule in the generator tab
            showTab('generator');
            
            // Display the schedule in the output area
            const scheduleOutput = document.getElementById('scheduleOutput');
            if (scheduleOutput) {
                scheduleOutput.innerHTML = `
                    <div class="alert alert-success">✅ AI-guided schedule generated successfully!</div>
                `;
            }
            
            // Add AI insights panel
            const insightsPanel = document.createElement('div');
            insightsPanel.style.cssText = `
                margin: 20px 0;
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 10px;
                border-left: 4px solid #8b5fbf;
            `;
            
            insightsPanel.innerHTML = `
                <h4 style="color: #8b5fbf; margin-bottom: 15px;">🧠 AI Scheduling Insights</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <h5>Work Patterns</h5>
                        <ul>${rules.workPatterns.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Health Rules</h5>
                        <ul>${rules.healthRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Fairness Criteria</h5>
                        <ul>${rules.fairnessRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Optimizations</h5>
                        <ul>${rules.optimizations.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
            
            const scheduleContainer = document.getElementById('schedule-display');
            if (scheduleContainer) {
                scheduleContainer.insertBefore(insightsPanel, scheduleContainer.firstChild);
            }
        }

        // Train AI with Excel data import
        async function trainAIWithExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('🧠 AI Training: Please select an Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show AI training indicator
            const trainingIndicator = document.createElement('div');
            trainingIndicator.innerHTML = '🧠 AI Learning from Excel...';
            trainingIndicator.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1001;
                animation: pulse 1.5s infinite;
            `;
            document.body.appendChild(trainingIndicator);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // First try to process with the existing import logic
                    try {
                        processImportedRoster(workbook);
                        trainingIndicator.innerHTML = '✅ Excel data imported successfully!';
                        setTimeout(() => trainingIndicator.remove(), 2000);
                        return;
                    } catch (importError) {
                        console.log('Standard import failed, using AI-powered analysis:', importError);
                    }
                    
                    // If standard import fails, use AI-powered flexible analysis
                    trainingIndicator.innerHTML = '🧠 Using AI for flexible Excel analysis...';
                    
                    let trainingData = {
                        teamData: [],
                        schedulePatterns: [],
                        leavePatterns: [],
                        insights: []
                    };
                    
                    // Extract data from any sheet structure
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Auto-detect data type based on content
                        if (jsonData.length > 1) {
                            const headers = jsonData[0];
                            const rows = jsonData.slice(1);
                            
                            // Check if it's team/employee data
                            if (headers.some(h => h && h.toString().toLowerCase().includes('name')) &&
                                headers.some(h => h && h.toString().toLowerCase().includes('role'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 2 && row[0] && row[1]) {
                                        const nameIdx = headers.findIndex(h => h && h.toString().toLowerCase().includes('name'));
                                        const roleIdx = headers.findIndex(h => h && h.toString().toLowerCase().includes('role'));
                                        
                                        trainingData.teamData.push({
                                            id: row[0] || Date.now().toString(),
                                            name: row[nameIdx] || row[1],
                                            role: row[roleIdx] || row[2] || 'Associate',
                                            status: 'Active',
                                            preferences: row[3] || '',
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                            
                            // Check if it's schedule data
                            else if (headers.some(h => h && h.toString().toLowerCase().includes('date')) ||
                                     headers.some(h => h && h.toString().toLowerCase().includes('shift'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 2 && row[0]) {
                                        trainingData.schedulePatterns.push({
                                            date: row[0],
                                            data: row.slice(1),
                                            headers: headers.slice(1),
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                            
                            // Check if it's leave data
                            else if (headers.some(h => h && h.toString().toLowerCase().includes('leave')) ||
                                     headers.some(h => h && h.toString().toLowerCase().includes('absence'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 3 && row[0]) {
                                        trainingData.leavePatterns.push({
                                            employee: row[0],
                                            date: row[1],
                                            type: row[2],
                                            status: row[3] || 'Approved',
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                        }
                    });
                    
                    // Use OpenAI for intelligent analysis if API key is available
                    const apiKey = getApiKey();
                    let aiRules;
                    
                    if (apiKey) {
                        try {
                            trainingIndicator.innerHTML = '🧠 OpenAI analyzing patterns...';
                            aiRules = await analyzeWithOpenAI(trainingData, apiKey);
                        } catch (aiError) {
                            console.error('OpenAI analysis failed:', aiError);
                            aiRules = extractRulesFromData(trainingData);
                            trainingIndicator.innerHTML = '🧠 Using fallback analysis...';
                        }
                    } else {
                        aiRules = extractRulesFromData(trainingData);
                    }
                    
                    // Store AI learning results
                    trainingData.insights = aiRules;
                    Storage.set('aiTrainingData', trainingData);
                    Storage.set('aiLastTrained', new Date().toISOString());
                    Storage.set('aiRules', aiRules);
                    
                    // Apply learned data to current system
                    if (trainingData.teamData.length > 0) {
                        // Update team data if we learned about employees
                        const shouldUpdateTeam = confirm(
                            `🧠 AI found ${trainingData.teamData.length} team members in your Excel file.\n\n` +
                            `Would you like to update the current team data with this information?`
                        );
                        
                        if (shouldUpdateTeam) {
                            npeTeamData.length = 0;
                            trainingData.teamData.forEach(emp => {
                                npeTeamData.push({
                                    id: emp.id,
                                    name: emp.name,
                                    role: emp.role,
                                    status: emp.status,
                                    daysOff: [0, 6], // Default weekend off
                                    cts: emp.id,
                                    eshc: 'N/A',
                                    maxConsecutiveDays: 6,
                                    minRestHours: 12,
                                    skills: []
                                });
                            });
                            updateTeamDisplay();
                        }
                    }
                    
                    if (trainingData.schedulePatterns.length > 0) {
                        // Generate AI-guided schedule with custom rules
                        const shouldGenerateSchedule = confirm(
                            `🧠 AI analyzed ${trainingData.schedulePatterns.length} schedule patterns.\n\n` +
                            `Would you like to generate a new roster using YOUR CUSTOM RULES with OpenAI?`
                        );
                        
                        if (shouldGenerateSchedule) {
                            // First, get custom rules from user
                            const hasCustomRules = Storage.get('userCustomRules');
                            if (!hasCustomRules || !hasCustomRules.shiftRules.length) {
                                const shouldDefineRules = confirm(
                                    '📋 To ensure OpenAI follows YOUR specific requirements, you need to define custom rules.\n\n' +
                                    'Would you like to define your roster rules now?'
                                );
                                
                                if (shouldDefineRules) {
                                    getCustomRulesFromUser();
                                    // Wait for rules to be saved before continuing
                                    setTimeout(() => {
                                        proceedWithCustomRosterGeneration(trainingData, aiRules);
                                    }, 1000);
                                } else {
                                    alert('⚠️ Custom rules are required for OpenAI to follow your specific requirements. Using fallback generation.');
                                    const startDate = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
                                    const endDate = prompt('Enter end date (YYYY-MM-DD):', 
                                        new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                                    
                                    if (startDate && endDate) {
                                        const aiSchedule = createAIGuidedSchedule(aiRules, startDate, endDate);
                                        scheduleData = { ...scheduleData, ...aiSchedule };
                                        displayEnhancedSchedule(aiSchedule, aiRules);
                                    }
                                }
                            } else {
                                proceedWithCustomRosterGeneration(trainingData, aiRules);
                            }
                        }
                    }
                    
                    // Remove training indicator and show results
                    trainingIndicator.remove();
                    showAITrainingResults(trainingData, aiRules);
                    
                } catch (error) {
                    console.error('AI Training error:', error);
                    trainingIndicator.remove();
                    alert(`🧠 AI Training encountered an error: ${error.message}\n\nPlease check the Excel file format or try again.`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Proceed with custom roster generation using OpenAI
        async function proceedWithCustomRosterGeneration(trainingData, aiRules) {
            console.log('📅 Starting proceedWithCustomRosterGeneration...');
            
            const startDate = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            const endDate = prompt('Enter end date (YYYY-MM-DD):', 
                new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            
            if (!startDate || !endDate) {
                alert('❌ Start and end dates are required for roster generation.');
                return;
            }
            
            console.log(`📅 Dates selected: ${startDate} to ${endDate}`);
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.innerHTML = '🤖 OpenAI generating roster with your custom rules...';
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                padding: 20px 30px;
                border-radius: 25px;
                font-size: 16px;
                z-index: 4000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: pulse 2s infinite;
            `;
            document.body.appendChild(loadingIndicator);
            
            try {
                console.log('🔑 Getting API key...');
                const apiKey = getApiKey();
                if (!apiKey) {
                    loadingIndicator.remove();
                    alert('❌ OpenAI API key is required for custom rule-based generation.');
                    return;
                }
                
                console.log('📋 Loading custom rules...');
                // Get saved custom rules
                const savedRules = Storage.get('userCustomRules');
                if (savedRules) {
                    userCustomRules = savedRules;
                }
                
                console.log('🤖 Calling OpenAI for roster generation...');
                // Generate roster using OpenAI with custom rules
                const result = await generateRosterWithCustomRules(
                    npeTeamData, 
                    scheduleData, 
                    startDate, 
                    endDate, 
                    apiKey
                );
                
                console.log('✅ OpenAI generation successful!', result);
                
                // Apply the generated schedule
                scheduleData = { ...scheduleData, ...result.schedule };
                
                // Show results with custom rules explanation
                loadingIndicator.remove();
                displayCustomRosterResults(result, startDate, endDate);
                
                console.log('📊 Updating schedule display...');
                // Show the generated schedule in the reports tab or schedule generator
                showTab('generator');
                
                // Scroll to schedule output
                const scheduleOutput = document.getElementById('scheduleOutput');
                if (scheduleOutput) {
                    scheduleOutput.scrollIntoView({ behavior: 'smooth' });
                    scheduleOutput.innerHTML = `
                        <div class="alert alert-success">✅ Custom roster generated successfully with OpenAI!</div>
                        <p>Check the modal for detailed results and rule explanations.</p>
                    `;
                }
                
            } catch (error) {
                console.error('Custom roster generation error:', error);
                loadingIndicator.remove();
                alert(`❌ Failed to generate roster with custom rules: ${error.message}\n\nFalling back to standard generation.`);
                
                // Fallback to standard generation
                const aiSchedule = createAIGuidedSchedule(aiRules, startDate, endDate);
                scheduleData = { ...scheduleData, ...aiSchedule };
                displayEnhancedSchedule(aiSchedule, aiRules);
            }
        }

        // Display custom roster generation results
        function displayCustomRosterResults(result, startDate, endDate) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                margin: 20px;
            `;
            
            const scheduleCount = Object.keys(result.schedule).length;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">🤖 Custom Rule-Based Roster Generated!</h3>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2d5a2d; margin-bottom: 10px;">✅ Success!</h4>
                    <p>OpenAI has generated a roster for <strong>${scheduleCount} days</strong> (${startDate} to ${endDate}) 
                    following YOUR custom rules strictly.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>📋 Your Custom Rules Applied:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">🔄 Shift Rules (${result.rulesApplied.shiftRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.shiftRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">👥 Team Rules (${result.rulesApplied.teamRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.teamRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">⏰ Timing Rules (${result.rulesApplied.timingRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.timingRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">🚫 Restrictions (${result.rulesApplied.restrictionRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.restrictionRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold;">⭐ Priority Rules (${result.rulesApplied.priorityRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.priorityRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>🧠 OpenAI Explanation:</h4>
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto;">
${result.explanation}
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="exportGeneratedRosterToSharePoint('${startDate}', '${endDate}'); this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #28a745, #34ce57);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">📊 Export SharePoint Excel</button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">✅ Perfect!</button>
                    <button onclick="getCustomRulesFromUser(); this.closest('[style*=fixed]').remove()" style="
                        background: #f39c12;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">📝 Modify Rules</button>
                    <button onclick="clearApiKey(); this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">🔑 Clear API Key</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Generate AI insights from training data
        function generateAIInsights(data) {
            const insights = [];
            
            // Analyze team patterns
            if (data.teamData.length > 0) {
                const roles = data.teamData.map(t => t.role);
                const roleCount = roles.reduce((acc, role) => {
                    acc[role] = (acc[role] || 0) + 1;
                    return acc;
                }, {});
                
                insights.push(`Team composition: ${Object.entries(roleCount).map(([role, count]) => `${count} ${role}s`).join(', ')}`);
            }
            
            // Analyze schedule patterns
            if (data.schedulePatterns.length > 0) {
                const avgDaysWithSchedule = data.schedulePatterns.filter(s => s.s1_leads || s.s2_leads || s.s3_leads).length;
                insights.push(`Schedule coverage: ${((avgDaysWithSchedule / data.schedulePatterns.length) * 100).toFixed(1)}% of days scheduled`);
            }
            
            // Analyze leave patterns
            if (data.leavePatterns.length > 0) {
                const leaveTypes = data.leavePatterns.map(l => l.type);
                const typeCount = leaveTypes.reduce((acc, type) => {
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                const mostCommonLeave = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0];
                insights.push(`Most common leave type: ${mostCommonLeave[0]} (${mostCommonLeave[1]} requests)`);
            }
            
            insights.push(`AI processed ${data.teamData.length} team members, ${data.schedulePatterns.length} schedule entries, ${data.leavePatterns.length} leave records`);
            
            return insights;
        }
        
        // Show AI training results
        function showAITrainingResults(data, rules) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">🧠 AI Training Complete!</h3>
                <div style="margin-bottom: 20px;">
                    <h4>Data Processed:</h4>
                    <ul>
                        <li>📊 Team Members: ${data.teamData.length}</li>
                        <li>📅 Schedule Patterns: ${data.schedulePatterns.length}</li>
                        <li>🏖️ Leave Records: ${data.leavePatterns.length}</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>AI-Extracted Rules:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Work Patterns:</h5>
                        <ul>${rules.workPatterns.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Health & Wellbeing Rules:</h5>
                        <ul>${rules.healthRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Fairness Criteria:</h5>
                        <ul>${rules.fairnessRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h5>Optimizations:</h5>
                        <ul>${rules.optimizations.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">Got it!</button>
                    <button onclick="clearApiKey(); this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">Clear API Key</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Apply AI learning to current data
        function applyAILearning(data) {
            // This function would apply learned patterns to improve scheduling
            // For now, we'll just show a confirmation
            alert('🧠 AI patterns applied! The system will now use learned preferences for future scheduling.');
            
            // Update dashboard to reflect AI learning
            updateDashboardStats();
        }

        // Add small import button in corner for AI training
        function addSmartImportButton() {
            const importBtn = document.createElement('button');
            importBtn.innerHTML = '🧠';
            importBtn.title = 'Train AI with Excel data';
            importBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(139, 95, 191, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls';
            fileInput.style.display = 'none';
            fileInput.onchange = trainAIWithExcel;
            
            importBtn.onmouseover = () => {
                importBtn.style.transform = 'scale(1.1)';
                importBtn.style.boxShadow = '0 6px 16px rgba(139, 95, 191, 0.4)';
            };
            
            importBtn.onmouseout = () => {
                importBtn.style.transform = 'scale(1)';
                importBtn.style.boxShadow = '0 4px 12px rgba(139, 95, 191, 0.3)';
            };
            
            importBtn.onclick = () => fileInput.click();
            
            document.body.appendChild(importBtn);
            document.body.appendChild(fileInput);
        }

        // Add custom rules button
        function addCustomRulesButton() {
            const rulesBtn = document.createElement('button');
            rulesBtn.innerHTML = '📋';
            rulesBtn.title = 'Define Custom Roster Rules for OpenAI';
            rulesBtn.style.cssText = `
                position: fixed;
                top: 65px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #e67e22, #f39c12);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            rulesBtn.onmouseover = () => {
                rulesBtn.style.transform = 'scale(1.1)';
                rulesBtn.style.boxShadow = '0 6px 16px rgba(230, 126, 34, 0.4)';
            };
            
            rulesBtn.onmouseout = () => {
                rulesBtn.style.transform = 'scale(1)';
                rulesBtn.style.boxShadow = '0 4px 12px rgba(230, 126, 34, 0.3)';
            };
            
            rulesBtn.onclick = () => getCustomRulesFromUser();
            
            document.body.appendChild(rulesBtn);
        }

        // Add generate custom roster button
        function addGenerateRosterButton() {
            const generateBtn = document.createElement('button');
            generateBtn.innerHTML = '🤖';
            generateBtn.title = 'Generate Roster with Custom Rules using OpenAI';
            generateBtn.style.cssText = `
                position: fixed;
                top: 110px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            generateBtn.onmouseover = () => {
                generateBtn.style.transform = 'scale(1.1)';
                generateBtn.style.boxShadow = '0 6px 16px rgba(39, 174, 96, 0.4)';
            };
            
            generateBtn.onmouseout = () => {
                generateBtn.style.transform = 'scale(1)';
                generateBtn.style.boxShadow = '0 4px 12px rgba(39, 174, 96, 0.3)';
            };
            
            generateBtn.onclick = (event) => {
                console.log('🤖 Generate button clicked!');
                
                // Prevent any form submission or navigation
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                try {
                    // Check if custom rules exist
                    const savedRules = Storage.get('userCustomRules');
                    if (!savedRules || !savedRules.shiftRules.length) {
                        const shouldDefineRules = confirm(
                            '📋 No custom rules found!\n\n' +
                            'OpenAI needs your specific rules to generate the roster exactly as you want.\n\n' +
                            'Would you like to define your rules now?'
                        );
                        
                        if (shouldDefineRules) {
                            getCustomRulesFromUser();
                        }
                    } else {
                        console.log('🚀 Starting custom roster generation...');
                        proceedWithCustomRosterGeneration({teamData: npeTeamData, schedulePatterns: [], leavePatterns: []}, {});
                    }
                } catch (error) {
                    console.error('Generate button error:', error);
                    alert(`❌ Error: ${error.message}`);
                }
            };
            
            document.body.appendChild(generateBtn);
        }

        // Add backup/restore functionality to UI
        function addBackupButtons() {
        // Legacy backup/restore UI removed. Only smart import button remains.
        }

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            addSmartImportButton();
            addCustomRulesButton();
            addGenerateRosterButton();
            
            // Load existing custom rules
            const savedRules = Storage.get('userCustomRules');
            if (savedRules) {
                userCustomRules = savedRules;
            }
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
        });
    </script>
</body>
</html>
