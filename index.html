<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPE ShiftBot - AI Roster Management</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5fbf">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NPE ShiftBot">
    <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
    
    <!-- SEO & Social Meta Tags -->
    <meta name="description" content="AI-powered shift roster management with health-conscious scheduling for NPE teams">
    <meta name="keywords" content="shift management, roster, AI scheduling, work-life balance, NPE, team management">
    <meta name="author" content="NPE Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="NPE ShiftBot - AI Roster Management">
    <meta property="og:description" content="Health-conscious AI scheduling that prioritizes work-life balance while maintaining operational efficiency">
    <meta property="og:type" content="website">
    <meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIHZpZXdCb3g9IjAgMCAxMjAwIDYzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjOGI1ZmJmIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjYTM3NGQwIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjMwIiBmaWxsPSJ1cmwoI2JnKSIvPjx0ZXh0IHg9IjYwMCIgeT0iMjgwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn6SWIE5QRSBTaGlmdEJvdDwvdGV4dD48dGV4dCB4PSI2MDAiIHk9IjM2MCIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgb3BhY2l0eT0iMC45Ij5BSSBSb3N0ZXIgTWFuYWdlbWVudCB3aXRoIEhlYWx0aC1Db25zY2lvdXMgU2NoZWR1bGluZzwvdGV4dD48L3N2Zz4=">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NPE ShiftBot - AI Roster Management">
    <meta name="twitter:description" content="Health-conscious AI scheduling for teams">
    
    <!-- Performance & Security -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGI1ZmJmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIzIi8+PHBhdGggZD0iTTEyIDFWM20wIDE4djJtMTEtMTJoLTJNNSAxMkgzbTEwLjUtNi5MTDE2IDRNNy41IDE3LjVMNiAxOW0wLTEzTDcuNSA3LjVtMTEgMUwxNyAxNy41Ii8+PC9zdmc+"
    
    <!-- External Dependencies with integrity checks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Chennai timezone utilities - Ultimate rule awareness
        function getChennaiTime() {
            return new Date().toLocaleString("en-US", {timeZone: "Asia/Kolkata"});
        }
        
        function getChennaiDate() {
            const chennaiTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Kolkata"});
            return new Date(chennaiTime);
        }
        
        function isWeekendInChennai(date) {
            const chennaiDate = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            const dayOfWeek = chennaiDate.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
        }
        
        function countWeekendsInRange(startDate, endDate) {
            let count = 0;
            const current = new Date(startDate);
            while (current <= endDate) {
                if (isWeekendInChennai(current)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }
        
        // Ultimate rule: Count of Sat & Sun = Count of each employee OFF
        function validateEmployeeSchedule(employeeName, schedule, startDate, endDate) {
            const weekendCount = countWeekendsInRange(startDate, endDate);
            let offCount = 0;
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const daySchedule = schedule[dateStr] || {};
                
                // Check if employee is OFF this day
                let isWorking = false;
                Object.keys(daySchedule).forEach(shift => {
                    if (daySchedule[shift] && daySchedule[shift].includes(employeeName)) {
                        isWorking = true;
                    }
                });
                
                if (!isWorking) offCount++;
            }
            
            return {
                weekendCount,
                offCount,
                isValid: weekendCount === offCount,
                employeeName
            };
        }
    </script>
    
    <style>
        /* Google Sites Compatible CSS */
        :root {
            --primary-color: #8b5fbf;
            --secondary-color: #a374d0;
            --background-color: #f3f0f8;
            --card-bg: #ffffff;
            --text-color: #4a4a4a;
            --text-light: #888;
            --border-color: #d4c5e0;
            --shadow: 0 4px 6px rgba(139, 95, 191, 0.15);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #f3f0f8 0%, #e8dff0 100%);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: var(--text-color);
            min-width: 120px;
        }

        .tab:hover {
            background: var(--background-color);
        }

        .tab.active {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f6fb 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(139, 95, 191, 0.25);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
            animation: fadeInScale 0.8s ease-out;
        }

        .stat-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(139, 95, 191, 0.3);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            animation: countUp 1.5s ease-out;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
            animation: fadeInLeft 0.8s ease-out;
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .compact-chart {
            height: 200px !important;
            margin: 10px 0;
            animation: fadeIn 1.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: linear-gradient(135deg, #8b5fbf 0%, #a374d0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 95, 191, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e15662 100%);
        }

        /* Date range input styles */
        .date-range-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f6fb 0%, #f3f0f8 100%);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .date-range-inputs {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .date-input-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .date-input-group input[type="date"] {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .date-range-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .date-range-inputs {
                flex-direction: column;
                gap: 10px;
            }
            
            .date-input-group {
                min-width: 100%;
            }
            
            .date-range-buttons {
                flex-direction: column;
            }
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: linear-gradient(135deg, #e8dff0 0%, #d4c5e0 100%);
            font-weight: 600;
            color: var(--primary-color);
        }

        .table tr:hover {
            background-color: #f8f6fb;
        }

        .leave-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            padding: 3px;
            position: relative;
            min-height: 60px;
        }

        .calendar-day:hover {
            background-color: var(--background-color);
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
        }

        .calendar-day.has-leave {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            color: white;
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .leave-employees {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
            max-height: 45px;
            overflow-y: auto;
            font-size: 9px;
        }

        .leave-employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            padding: 1px 3px;
            margin: 1px 0;
        }

        .leave-employee-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 8px;
        }

        .cancel-leave-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 2px;
            width: 12px;
            height: 12px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 2px;
            flex-shrink: 0;
        }

        .cancel-leave-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 1px solid #b6e3ea;
            color: #0c5460;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: auto;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Modern Analytics Dashboard Styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Update body font */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        /* Analytics Header */
        .analytics-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 1rem;
        }

        .analytics-header h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .analytics-header p {
            font-size: 1.125rem;
            color: #6b7280;
            font-weight: 400;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color);
        }

        .kpi-card.primary { --accent-color: #8b5fbf; }
        .kpi-card.success { --accent-color: #10b981; }
        .kpi-card.warning { --accent-color: #f59e0b; }
        .kpi-card.info { --accent-color: #3b82f6; }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .kpi-icon {
            font-size: 2rem;
            min-width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-color);
            border-radius: 12px;
            color: white;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1.1;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .kpi-trend {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
        }

        .kpi-trend.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .kpi-trend.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .kpi-trend.neutral {
            background: #f3f4f6;
            color: #4b5563;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        .analytics-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
            grid-column: span 6;
        }

        .analytics-card.wide {
            grid-column: span 8;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .activity-indicator {
            font-size: 0.875rem;
            font-weight: 500;
            color: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .activity-item {
            transition: all 0.3s ease;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f9fafb;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item.new-activity {
            animation: slideInLeft 0.5s ease, highlightFade 3s ease;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes highlightFade {
            0% { background: linear-gradient(90deg, rgba(16, 185, 129, 0.2) 0%, transparent 100%); }
            100% { background: transparent; }
        }

        .ai-badge {
            background: linear-gradient(135deg, #8b5fbf, #a374d0);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Circular Progress Charts */
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .metric-item {
            padding: 1rem;
        }

        .metric-circle {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.5rem;
        }

        .circular-chart {
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: #f3f4f6;
            stroke-width: 2.8;
        }

        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            animation: progress 1s ease-out forwards;
        }

        .circular-chart.green .circle { stroke: #10b981; }
        .circular-chart.blue .circle { stroke: #3b82f6; }
        .circular-chart.orange .circle { stroke: #f59e0b; }

        .percentage {
            fill: #1a1a1a;
            font-family: 'Inter', sans-serif;
            font-size: 0.5em;
            font-weight: 600;
            text-anchor: middle;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        @keyframes progress {
            0% {
                stroke-dasharray: 0 100;
            }
        }

        /* AI Insights */
        .insights-list {
            margin-top: 1rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }

        .insight-item.positive {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .insight-item.warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
        }

        .insight-item.info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
        }

        .insight-icon {
            font-size: 1.25rem;
            min-width: 24px;
        }

        .insight-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .insight-description {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Activity Feed */
        .activity-feed {
            margin-top: 1rem;
        }

        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }

        .activity-content {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.4;
        }

        .activity-user {
            font-weight: 600;
            color: #8b5fbf;
        }

        .activity-highlight {
            background: #fef3c7;
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .analytics-card {
                grid-column: span 12;
            }
            
            .analytics-card.wide {
                grid-column: span 12;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .health-metrics {
                grid-template-columns: 1fr;
            }
            
            .analytics-header h2 {
                font-size: 1.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>ü§ñ NPE ShiftBot</h1>
                    <p>AI-Powered Roster Management with Health-Conscious Scheduling</p>
                </div>
                <div class="header-actions">
                    <button onclick="handleImportRoster()" class="import-btn">
                        <span class="icon">üì•</span>
                        Import Roster
                    </button>
                </div>
            </div>
        </div>

        <style>
            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                padding: 0 20px;
            }
            .header-title {
                flex: 1;
            }
            .header-actions {
                display: flex;
                gap: 10px;
            }
            .import-btn {
                background: linear-gradient(135deg, #8b5fbf 0%, #6b46c1 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .import-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
                background: linear-gradient(135deg, #9d73d4 0%, #7c54d3 100%);
            }
            .import-btn .icon {
                font-size: 18px;
            }
        </style>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" data-tab="team" onclick="showTab('team')">üë• NPE Team</button>
            <button class="tab" data-tab="leaves" onclick="showTab('leaves')">üèñÔ∏è Leave Management</button>
            <button class="tab" data-tab="shifts" onclick="showTab('shifts')">‚è∞ Shifts</button>
            <button class="tab" data-tab="generator" onclick="showTab('generator')">üéØ Schedule Generator</button>
            <button class="tab" data-tab="reports" onclick="showTab('reports')">üìà Reports</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Modern Analytics Header -->
            <div class="analytics-header">
                <h2>Team Performance Analytics</h2>
                <p>Real-time insights into your workforce management</p>
            </div>

            <!-- Key Performance Indicators -->
            <div class="kpi-grid">
                <div class="kpi-card primary">
                    <div class="kpi-icon">ÔøΩ</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalEmployees">12</div>
                        <div class="kpi-label">Active Team Members</div>
                        <div class="kpi-trend positive">‚Üó +2 this month</div>
                    </div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-icon">‚ö°</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="efficiencyScore">94</div>
                        <div class="kpi-label">Efficiency Score</div>
                        <div class="kpi-trend positive">‚Üó +3% vs last month</div>
                    </div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-icon">üèñÔ∏è</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="pendingLeaves">5</div>
                        <div class="kpi-label">Pending Requests</div>
                        <div class="kpi-trend neutral">‚Üí Same as last week</div>
                    </div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="coverageRate">98</div>
                        <div class="kpi-label">Shift Coverage</div>
                        <div class="kpi-trend positive">‚Üó +1% improvement</div>
                    </div>
                </div>
            </div>

            <!-- Modern Analytics Grid -->
            <div class="analytics-grid">
                <!-- Schedule Efficiency Metrics -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Schedule Health</h3>
                    </div>
                    <div class="health-metrics">
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="85">
                                <svg id="staffing-circle" viewBox="0 0 36 36" class="circular-chart green">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="85, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">85%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Staffing Efficiency</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="72">
                                <svg id="balance-circle" viewBox="0 0 36 36" class="circular-chart blue">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="72, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">72%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Work-Life Balance</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-circle" data-percentage="91">
                                <svg id="satisfaction-circle" viewBox="0 0 36 36" class="circular-chart orange">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circle" stroke-dasharray="91, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <text x="18" y="20.35" class="percentage">91%</text>
                                </svg>
                            </div>
                            <div class="metric-label">Team Satisfaction</div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>AI Insights</h3>
                        <span class="ai-badge">üß† AI</span>
                    </div>
                    <div class="insights-list">
                        <div class="insight-item positive">
                            <div class="insight-icon">‚úÖ</div>
                            <div class="insight-content">
                                <div class="insight-title">Optimal Coverage</div>
                                <div class="insight-description">All shifts are properly staffed this week</div>
                            </div>
                        </div>
                        <div class="insight-item warning">
                            <div class="insight-icon">‚ö†Ô∏è</div>
                            <div class="insight-content">
                                <div class="insight-title">Potential Burnout Risk</div>
                                <div class="insight-description">2 team members approaching 6-day limit</div>
                            </div>
                        </div>
                        <div class="insight-item info">
                            <div class="insight-icon">üí°</div>
                            <div class="insight-content">
                                <div class="insight-title">Schedule Optimization</div>
                                <div class="insight-description">Rotating night shifts could improve fairness</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                        <span class="activity-indicator">üü¢ Live</span>
                    </div>
                    <div class="activity-feed" id="activityFeed">
                        <div class="activity-item">
                            <div class="activity-time">2 min ago</div>
                            <div class="activity-content">
                                <span class="activity-user">Karthikeyan</span> submitted leave request for Aug 15
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">1 hour ago</div>
                            <div class="activity-content">
                                Schedule generated for <span class="activity-highlight">Week 32</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">3 hours ago</div>
                            <div class="activity-content">
                                <span class="activity-user">Jeeva</span> approved 2 leave requests
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">1 day ago</div>
                            <div class="activity-content">
                                AI optimization improved efficiency by <span class="activity-highlight">3%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                            <div class="stat-label">Avg Consecutive Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="burnoutAlerts">0</div>
                            <div class="stat-label">Burnout Alerts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPE Team Tab -->
        <div id="team" class="tab-content">
            <div class="card">
                <h3>üë• NPE Team Members</h3>
                <table class="table" id="teamTable">
                    <thead>
                        <tr>
                            <th>CTS ID</th>
                            <th>ESHC</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Preferred Days Off</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                        <!-- Team data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leave Management Tab -->
        <div id="leaves" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üèñÔ∏è Request Leave</h3>
                    <form id="leaveRequestForm">
                        <div class="form-group">
                            <label for="employeeSelect">Employee</label>
                            <select id="employeeSelect" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveDate">Leave Date</label>
                            <input type="date" id="leaveDate" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveType">Leave Type</label>
                            <select id="leaveType" required>
                                <option value="">Select Type</option>
                                <option value="sick">Sick Leave</option>
                                <option value="vacation">Vacation</option>
                                <option value="personal">Personal</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">Reason (Optional)</label>
                            <textarea id="leaveReason" rows="3" placeholder="Brief reason for leave..."></textarea>
                        </div>
                        <button type="submit" class="btn">Submit Leave Request</button>
                    </form>
                </div>

                <div class="card">
                    <h3>üìã Pending Leave Requests</h3>
                    <div id="pendingLeavesList">
                        <!-- Pending leaves will be shown here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìÖ Leave Calendar Overview</h3>
                <div id="leaveCalendar" class="leave-calendar">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- Shifts Tab -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h3>‚è∞ Shift Configuration</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Shift</th>
                            <th>Time</th>
                            <th>Required Roles</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>S1 - Morning</td>
                            <td>06:00 AM - 04:00 PM IST</td>
                            <td>Shift Leads, Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S2 - Afternoon</td>
                            <td>01:00 PM - 11:00 PM IST</td>
                            <td>Leads, Shift Leads, Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S3 - Night</td>
                            <td>10:00 PM - 08:00 AM IST</td>
                            <td>Shift Leads, Associates</td>
                            <td><span style="color: green;">‚úì Active</span></td>
                        </tr>
                        <tr>
                            <td>S4 - Special</td>
                            <td>12:30 PM - 10:30 PM IST</td>
                            <td>Leads</td>
                            <td><span style="color: orange;">‚ö† As Needed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Schedule Generator Tab -->
        <div id="generator" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üéØ AI Schedule Generator</h3>
                    <div class="alert alert-info">
                        <strong>Health-Conscious Scheduling:</strong> Our AI considers work-life balance, prevents burnout (max 6 consecutive days), and ensures proper rest periods.
                    </div>
                    <form id="scheduleForm">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="numDays">Number of Days</label>
                            <select id="numDays" required>
                                <option value="7">1 Week</option>
                                <option value="14">2 Weeks</option>
                                <option value="30" selected>1 Month</option>
                                <option value="60">2 Months</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">ü§ñ Generate AI Schedule</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadSchedule()">üì• Download Excel</button>
                    </form>
                </div>

                <div class="card">
                    <h3>üèñÔ∏è Extra Off Management</h3>
                    <div class="alert alert-warning">
                        <strong>Extra Offs:</strong> Add additional off days for team members. These are separate from regular week offs and will be respected during schedule generation.
                    </div>
                    <form id="extraOffForm">
                        <div class="form-group">
                            <label for="extraOffEmployee">Select Employee</label>
                            <div style="display: flex; gap: 10px; align-items: end;">
                                <select id="extraOffEmployee" required style="flex: 1;">
                                    <option value="">Choose employee...</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="initializeExtraOffManagement()" title="Refresh employee list">
                                    üîÑ
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="extraOffDateRange">Date Range (Optional - uses main schedule dates if not specified)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label for="extraOffStartDate" style="font-size: 12px; color: #666;">From Date</label>
                                    <input type="date" id="extraOffStartDate" class="form-control">
                                </div>
                                <div>
                                    <label for="extraOffEndDate" style="font-size: 12px; color: #666;">To Date</label>
                                    <input type="date" id="extraOffEndDate" class="form-control">
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateExtraOffDatePicker()" title="Update date range">
                                    üìÖ Update
                                </button>
                            </div>
                            <small class="text-muted">Leave blank to use the main schedule's start date and duration</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="extraOffDates">Select Off Days (Multiple selection allowed)</label>
                            <div id="extraOffDatePicker" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">
                                <p class="text-muted" style="text-align: center; padding: 20px;">
                                    üìÖ Please set a date range above or use the main schedule dates to see available days
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-info" onclick="addExtraOffs()">‚ûï Add Extra Offs</button>
                            <button type="button" class="btn btn-secondary" onclick="clearAllExtraOffs()">üóëÔ∏è Clear All</button>
                            <button type="button" class="btn btn-outline-info" onclick="useMainScheduleDates()">üìã Use Main Schedule Dates</button>
                            <button type="button" class="btn btn-outline-primary" onclick="updateExtraOffDatePicker()" title="Force refresh date picker">üîÑ Refresh Dates</button>
                        </div>
                    </form>
                    
                    <div id="extraOffsList" class="mt-3">
                        <h5>Current Extra Offs:</h5>
                        <div id="extraOffsDisplay">
                            <p class="text-muted">No extra offs scheduled</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö° NPE ShiftBot Requirements</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            ÔøΩ <strong>SHIFT_LEADS:</strong> One of first 5 members (Jeyakaran, Karthikeyan, Manoj, Panner, SaiKumar) must be in every shift
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üö´ <strong>S2_ONLY:</strong> Dinesh and Mano only work S2 (no shift coverage)
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            ÔøΩ <strong>WEEKDAY_RULES:</strong> Mon-Fri: 3 in S1&S3, 2 in S2 | Sat: 2 in each shift | Sun: Only S2&S3 with 2 each
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üîÑ <strong>WEEK_OFF_RULE:</strong> Total off days ‚â§ number of Saturdays + Sundays in the month
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">
                            üèñÔ∏è <strong>EXTRA_OFFS:</strong> Additional off days with multiple day selection (counted in total offs)
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>üìä Generated Schedule</h3>
                <div id="scheduleOutput">
                    <p style="text-align: center; color: var(--text-light); padding: 40px;">
                        Click "Generate AI Schedule" to create a health-conscious roster
                    </p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="cards-grid">
                <div class="card">
                    <h3>üìà Workload Analytics</h3>
                    <canvas id="reportChart" class="compact-chart"></canvas>
                </div>
                <div class="card">
                    <h3>üìä Team Performance</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">98.5%</div>
                            <div class="stat-label">Schedule Adherence</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">4.2</div>
                            <div class="stat-label">Avg Days/Week</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">2.1</div>
                            <div class="stat-label">Avg Rest Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Violations</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Real NPE Team Data - August 2025
        const npeTeamData = [
            // S2 Only Members (No shift coverage, only S2)
            { id: '593300', name: 'Dinesh', role: 'S2Only', status: 'Active', daysOff: [], cts: '593300', eshc: 'EH0647' },
            { id: '560008', name: 'Mano', role: 'S2Only', status: 'Active', daysOff: [], cts: '560008', eshc: 'EG4208' },
            
            // First 5 Members (One must be in every shift)
            { id: '410093', name: 'Jeyakaran', role: 'ShiftLead', status: 'Active', daysOff: [], cts: '410093', eshc: 'EH6832' },
            { id: '2167353', name: 'Karthikeyan', role: 'ShiftLead', status: 'Active', daysOff: [], cts: '2167353', eshc: 'C7H8KH' },
            { id: '2136623', name: 'Manoj', role: 'ShiftLead', status: 'Active', daysOff: [], cts: '2136623', eshc: 'C8G3CW' },
            { id: '2054459', name: 'Panner', role: 'ShiftLead', status: 'Active', daysOff: [], cts: '2054459', eshc: 'C6X8FS' },
            { id: '2240608', name: 'SaiKumar', role: 'ShiftLead', status: 'Active', daysOff: [], cts: '2240608', eshc: 'C7T7SF' },
            
            // Other Team Members
            { id: '2054433', name: 'Sai Krishna', role: 'Associate', status: 'Active', daysOff: [], cts: '2054433', eshc: 'C6X7K5' },
            { id: '2299004', name: 'Jeeva', role: 'Associate', status: 'Active', daysOff: [], cts: '2299004', eshc: 'C8N5H4' },
            { id: '2309236', name: 'Saran', role: 'Associate', status: 'Active', daysOff: [], cts: '2309236', eshc: 'C8S7B6' },
            { id: '2328010', name: 'Akshay', role: 'Associate', status: 'Active', daysOff: [], cts: '2328010', eshc: 'C8W2BD' },
            { id: '2378392', name: 'Murugan', role: 'Associate', status: 'Active', daysOff: [], cts: '2378392', eshc: 'C9B7ZT' }
            ,
            { id: '2400001', name: 'Sahana', role: 'Associate', status: 'Active', daysOff: [], cts: '2400001', eshc: 'C9S8SA' },
            { id: '2400002', name: 'Rengadurai', role: 'Associate', status: 'Active', daysOff: [], cts: '2400002', eshc: 'C9R8RD' }
        ];

        // Real August 2025 Schedule Data
        const realAugust2025Schedule = {
            '2025-08-01': { 'S1': ['Jeyakaran', 'Manoj', 'Sahana P'], 'S2': ['Sai Kumar', 'Murugan'], 'S3': ['Karthikeyan', 'Saran', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-02': { 'S1': ['Jeyakaran', 'Manoj'], 'S2': ['Sai Kumar', 'Murugan'], 'S3': ['Panner', 'Akshay'] },
            '2025-08-03': { 'S1': [], 'S2': ['Manoj', 'Sai Krishna'], 'S3': ['Panner', 'Akshay', 'Murugan'] },
            '2025-08-04': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S3': ['Panner', 'Akshay', 'Sahana P'] },
            '2025-08-05': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Dinesh', 'Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S3': ['Panner', 'Akshay', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-06': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Dinesh', 'Jeyakaran', 'Sai Krishna', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-07': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-08': { 'S1': ['Karthikeyan', 'Jeeva', 'Saran'], 'S2': ['Jeyakaran', 'Sai Kumar', 'Rengadurai'], 'S3': ['Panner', 'Manoj', 'Akshay', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-09': { 'S1': ['Karthikeyan', 'Jeeva'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna'] },
            '2025-08-10': { 'S1': ['Karthikeyan'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna'] },
            '2025-08-11': { 'S1': ['Karthikeyan', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-12': { 'S1': ['Karthikeyan', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Panner', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-13': { 'S1': ['Karthikeyan', 'Manoj', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-14': { 'S1': ['Karthikeyan', 'Manoj', 'Jeeva', 'Sahana P'], 'S2': ['Dinesh', 'Saran', 'Rengadurai'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Murugan'], 'S4': ['Mano'] },
            '2025-08-15': { 'S1': ['Karthikeyan', 'Manoj', 'Jeeva'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Sai Krishna', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-16': { 'S1': ['Karthikeyan', 'Manoj'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Panner'] },
            '2025-08-17': { 'S1': ['Manoj'], 'S2': ['Akshay', 'Murugan'], 'S3': ['Jeyakaran', 'Panner'] },
            '2025-08-18': { 'S1': ['Jeyakaran', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-19': { 'S1': ['Jeyakaran', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-20': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-21': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Rengadurai'], 'S4': ['Dinesh'] },
            '2025-08-22': { 'S1': ['Karthikeyan', 'Sai Krishna'], 'S2': ['Sahana P', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Panner', 'Jeeva', 'Saran'], 'S4': ['Dinesh'] },
            '2025-08-23': { 'S1': ['Karthikeyan'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Saran'] },
            '2025-08-24': { 'S1': ['Karthikeyan'], 'S2': ['Sahana P', 'Akshay'], 'S3': ['Sai Kumar', 'Panner', 'Saran'] },
            '2025-08-25': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Sai Kumar', 'Sai Krishna'], 'S3': ['Panner', 'Jeeva', 'Saran', 'Rengadurai'] },
            '2025-08-26': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Sai Kumar', 'Sai Krishna'], 'S3': ['Panner', 'Jeeva', 'Saran', 'Rengadurai'] },
            '2025-08-27': { 'S1': ['Jeyakaran', 'Murugan'], 'S2': ['Dinesh', 'Sai Kumar', 'Sai Krishna'], 'S3': ['Saran', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-28': { 'S1': ['Jeyakaran', 'Karthikeyan', 'Murugan', 'Sahana P'], 'S2': ['Dinesh', 'Sai Kumar', 'Sai Krishna', 'Jeeva'], 'S3': ['Saran', 'Rengadurai'], 'S4': ['Mano'] },
            '2025-08-29': { 'S1': ['Jeyakaran', 'Karthikeyan', 'Murugan', 'Jeeva'], 'S2': ['Dinesh', 'Akshay'], 'S3': ['Sai Kumar', 'Saran', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-30': { 'S1': ['Jeyakaran', 'Karthikeyan'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Saran', 'Sahana P'], 'S4': ['Mano'] },
            '2025-08-31': { 'S1': ['Jeyakaran', 'Karthikeyan'], 'S2': ['Dinesh', 'Akshay', 'Murugan'], 'S3': ['Sai Kumar', 'Saran', 'Jeeva', 'Sahana P'], 'S4': ['Mano'] }
        };

        // Real leave data for August 2025
        const realLeaveData = [
            { id: 'leave001', employeeId: '593300', employeeName: 'Dinesh', date: '2025-08-07', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-07-25T10:00:00Z' },
            { id: 'leave002', employeeId: '593300', employeeName: 'Dinesh', date: '2025-08-08', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-07-25T10:00:00Z' },
            { id: 'leave003', employeeId: '2240608', employeeName: 'Sai Kumar', date: '2025-08-04', type: 'sick', reason: 'Medical appointment', status: 'approved', requestDate: '2025-08-01T09:00:00Z' },
            { id: 'leave004', employeeId: '410093', employeeName: 'Jeyakaran', date: '2025-08-23', type: 'vacation', reason: 'Family function', status: 'approved', requestDate: '2025-08-10T14:30:00Z' },
            { id: 'leave005', employeeId: '410093', employeeName: 'Jeyakaran', date: '2025-08-24', type: 'vacation', reason: 'Family function', status: 'approved', requestDate: '2025-08-10T14:30:00Z' },
            { id: 'leave006', employeeId: '2136623', employeeName: 'Manoj', date: '2025-08-13', type: 'sick', reason: 'Fever', status: 'approved', requestDate: '2025-08-12T08:00:00Z' },
            { id: 'leave007', employeeId: '2299004', employeeName: 'Jeeva', date: '2025-08-12', type: 'personal', reason: 'Personal work', status: 'approved', requestDate: '2025-08-05T16:00:00Z' },
            { id: 'leave008', employeeId: '2328010', employeeName: 'Akshay', date: '2025-08-28', type: 'emergency', reason: 'Family emergency', status: 'approved', requestDate: '2025-08-27T20:00:00Z' }
        ];

        // Dynamic data storage
        let leaveRequests = [...realLeaveData];
        let scheduleData = {...realAugust2025Schedule};

        // Handle roster import
        function handleImportRoster() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    // Process the Excel file
                    processImportedRoster(workbook);
                    
                } catch (error) {
                    alert('Error processing the file. Please ensure it\'s a valid Excel roster file.');
                    console.error('Import error:', error);
                }
            };

            input.click();
        }

        // Excel Template Structure Definition
        const EXCEL_TEMPLATE = {
            SHEETS: {
                EMPLOYEES: {
                    name: 'Employees',
                    columns: [
                        { header: 'Name *', key: 'name', width: 20, required: true },
                        { header: 'Role *', key: 'role', width: 15, required: true },
                        { header: 'Employee ID', key: 'employeeId', width: 15 },
                        { header: 'ESHC', key: 'eshc', width: 15 },
                        { header: 'Preferred Days Off', key: 'daysOff', width: 20 },
                        { header: 'Skills', key: 'skills', width: 25 }
                    ]
                },
                SHIFTS: {
                    name: 'Shifts',
                    columns: [
                        { header: 'Shift Code *', key: 'code', width: 12, required: true },
                        { header: 'Start Time', key: 'startTime', width: 15 },
                        { header: 'End Time', key: 'endTime', width: 15 },
                        { header: 'Min Staff Required *', key: 'minStaff', width: 18, required: true },
                        { header: 'Required Leads', key: 'requiredLeads', width: 15 },
                        { header: 'Required Associates', key: 'requiredAssociates', width: 15 },
                        { header: 'Mandatory Members', key: 'mandatoryMembers', width: 30 },
                        { header: 'Preferred Shift Lead', key: 'preferredLead', width: 20 }
                    ]
                },
                ROSTER: {
                    name: 'Roster',
                    columns: [
                        { header: 'Date', key: 'date', width: 15 },
                        { header: 'S1 (06:00-14:00)', key: 'S1', width: 25 },
                        { header: 'S2 (13:00-21:00)', key: 'S2', width: 25 },
                        { header: 'S3 (20:00-04:00)', key: 'S3', width: 25 },
                        { header: 'S4 (12:30-20:30)', key: 'S4', width: 25 }
                    ]
                },
                LEAVES: {
                    name: 'Leaves',
                    columns: [
                        { header: 'Employee ID', key: 'employeeId', width: 15 },
                        { header: 'Employee Name', key: 'employeeName', width: 20 },
                        { header: 'Date', key: 'date', width: 15 },
                        { header: 'Leave Type', key: 'type', width: 15 },
                        { header: 'Status', key: 'status', width: 15 },
                        { header: 'Reason', key: 'reason', width: 30 }
                    ]
                }
            }
        };

        function processImportedRoster(workbook) {
            // Show loading state
            document.body.style.cursor = 'wait';
            const loadingAlert = document.createElement('div');
            loadingAlert.className = 'alert alert-info';
            loadingAlert.style.position = 'fixed';
            loadingAlert.style.top = '20px';
            loadingAlert.style.right = '20px';
            loadingAlert.style.zIndex = '1000';
            loadingAlert.innerHTML = 'üîÑ Analyzing roster data...';
            document.body.appendChild(loadingAlert);

            try {
                const sheetProcessors = {
                    [EXCEL_TEMPLATE.SHEETS.EMPLOYEES.name]: (sheet) => {
                        const employeeData = XLSX.utils.sheet_to_json(sheet);
                        npeTeamData.length = 0;
                        
                        employeeData.forEach(emp => {
                            // Check for required fields
                            if (!emp['Name'] || !emp['Role']) {
                                console.warn('Skipping employee record: Name and Role are required fields');
                                return;
                            }
                            
                            // Generate ID if not provided
                            const id = emp['Employee ID'] || Date.now().toString();
                            
                            npeTeamData.push({
                                id: id,
                                name: emp['Name'],
                                role: emp['Role'],
                                status: 'Active',
                                // All other fields are optional with defaults
                                daysOff: emp['Preferred Days Off'] ? 
                                    emp['Preferred Days Off'].split(',').map(d => parseInt(d.trim())) : 
                                    [0, 6], // Default weekend off
                                cts: emp['Employee ID'] || id, // Use ID as CTS if not provided
                                eshc: emp['ESHC'] || 'N/A',   // ESHC is optional
                                maxConsecutiveDays: 6,        // Default values for health rules
                                minRestHours: 12,
                                skills: emp['Skills'] ? emp['Skills'].split(',').map(s => s.trim()) : []
                            });
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.SHIFTS.name]: (sheet) => {
                        const shiftData = XLSX.utils.sheet_to_json(sheet);
                        window.shiftConfig = {};
                        
                        shiftData.forEach(shift => {
                            window.shiftConfig[shift['Shift Code']] = {
                                startTime: shift['Start Time'],
                                endTime: shift['End Time'],
                                minStaff: shift['Min Staff Required'],
                                requiredLeads: shift['Required Leads'] || 0,
                                requiredAssociates: shift['Required Associates'] || 0,
                                preferredLead: shift['Preferred Shift Lead'] || '',
                                mandatoryMembers: shift['Mandatory Members'] ? 
                                    shift['Mandatory Members'].split(',').map(s => s.trim()) : 
                                    [],
                                breakDuration: shift['Break Duration (mins)'] || 30
                            };
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.ROSTER.name]: (sheet) => {
                        const rosterData = XLSX.utils.sheet_to_json(sheet);
                        scheduleData = {};
                        
                        rosterData.forEach(row => {
                            if (row['Date']) {
                                scheduleData[row['Date']] = {
                                    'S1': row['S1 (06:00-14:00)'] ? 
                                        row['S1 (06:00-14:00)'].split(',').map(s => s.trim()) : [],
                                    'S2': row['S2 (13:00-21:00)'] ? 
                                        row['S2 (13:00-21:00)'].split(',').map(s => s.trim()) : [],
                                    'S3': row['S3 (20:00-04:00)'] ? 
                                        row['S3 (20:00-04:00)'].split(',').map(s => s.trim()) : [],
                                    'S4': row['S4 (12:30-20:30)'] ? 
                                        row['S4 (12:30-20:30)'].split(',').map(s => s.trim()) : []
                                };
                            }
                        });
                    },

                    [EXCEL_TEMPLATE.SHEETS.LEAVES.name]: (sheet) => {
                        const leaveData = XLSX.utils.sheet_to_json(sheet);
                        leaveRequests.length = 0;
                        
                        leaveData.forEach(leave => {
                            leaveRequests.push({
                                id: Date.now().toString(),
                                employeeId: leave['Employee ID'],
                                employeeName: leave['Employee Name'],
                                date: leave['Date'],
                                type: leave['Leave Type'] || 'personal',
                                reason: leave['Reason'] || '',
                                status: leave['Status'] || 'approved',
                                requestDate: new Date().toISOString()
                            });
                        });
                    }
                };

                // Process each sheet if it exists
                Object.values(EXCEL_TEMPLATE.SHEETS).forEach(sheetConfig => {
                    if (workbook.SheetNames.includes(sheetConfig.name)) {
                        const sheet = workbook.Sheets[sheetConfig.name];
                        sheetProcessors[sheetConfig.name](sheet);
                    }
                });

                // Refresh all views
                initDashboard();
                loadTeamData();
                updateLeaveRequests();
                generateLeaveCalendar();

                // Show success message
                loadingAlert.className = 'alert alert-success';
                loadingAlert.innerHTML = '‚úÖ Roster data imported successfully!';
                setTimeout(() => loadingAlert.remove(), 3000);

            } catch (error) {
                console.error('Processing error:', error);
                loadingAlert.className = 'alert alert-danger';
                loadingAlert.innerHTML = '‚ùå Error processing roster data. Please check the file format.';
                setTimeout(() => loadingAlert.remove(), 5000);
            }

            // Reset cursor
            document.body.style.cursor = 'default';
        }

        // Tab Management
        function showTab(tabName) {
    // Stop activity feed when leaving dashboard
    if (tabName !== 'dashboard') {
        stopActivityFeed();
    }


    // Hide all tab contents and remove active from all tabs
    const tabContents = document.querySelectorAll('.tab-content');
    const tabButtons = document.querySelectorAll('.tab');
    tabContents.forEach(content => content.classList.remove('active'));
    tabButtons.forEach(tab => tab.classList.remove('active'));

    // Show selected tab content
    const selectedContent = document.getElementById(tabName);
    if (selectedContent) {
        selectedContent.classList.add('active');
    }

    // Activate the correct tab button robustly
    tabButtons.forEach(tab => {
        // Use a data-tab attribute for reliable matching
        if (tab.dataset.tab === tabName) {
            tab.classList.add('active');
        }
    });

    // Initialize tab-specific content
    if (tabName === 'dashboard') {
        initDashboard();
        addRealActivity('üìä Viewed dashboard', 'Analytics and activity overview');
    } else if (tabName === 'team') {
        loadTeamData();
        addRealActivity('üë• Viewed team', 'Team member management');
    } else if (tabName === 'leaves') {
        initLeaveManagement();
        addRealActivity('üèñÔ∏è Viewed leaves', 'Leave management and calendar');
    } else if (tabName === 'generator') {
        // Removed Extra Off Management logic
        addRealActivity('ü§ñ Opened generator', 'Schedule generation');
    } else if (tabName === 'reports') {
        initReports();
        addRealActivity('üìà Viewed reports', 'Performance analytics and insights');
    } else if (tabName === 'shiftConfig') {
        initShiftConfiguration();
        addRealActivity('‚öôÔ∏è Opened config', 'Shift configuration settings');
    }
        }

        // Real Activity Tracking System
        const realActivities = [];
        let activityId = 0;

        function addRealActivity(action, details = '') {
            const timestamp = new Date();
            const activity = {
                id: ++activityId,
                action: action,
                details: details,
                timestamp: timestamp,
                timeAgo: 'Just now'
            };
            
            realActivities.unshift(activity); // Add to beginning
            
            // Keep only last 10 activities
            if (realActivities.length > 10) {
                realActivities.pop();
            }
            
            updateRealActivityFeed();
            updateActivityTimestamps();
        }

        function updateRealActivityFeed() {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;

            // Clear existing activities
            activityFeed.innerHTML = '';

            // Show only top 5 activities
            const displayActivities = realActivities.slice(0, 5);
            
            if (displayActivities.length === 0) {
                activityFeed.innerHTML = '<div class="activity-item"><div class="activity-content" style="text-align: center; color: #888;">No recent activity</div></div>';
                return;
            }

            displayActivities.forEach((activity, index) => {
                const activityEl = document.createElement('div');
                activityEl.className = 'activity-item';
                if (index === 0) {
                    activityEl.classList.add('new-activity');
                }
                
                activityEl.innerHTML = `
                    <div class="activity-time">${activity.timeAgo}</div>
                    <div class="activity-content">
                        ${activity.action}${activity.details ? ` - ${activity.details}` : ''}
                    </div>
                `;
                
                activityFeed.appendChild(activityEl);
            });

            // Remove animation class after animation completes
            setTimeout(() => {
                const newItems = activityFeed.querySelectorAll('.new-activity');
                newItems.forEach(item => item.classList.remove('new-activity'));
            }, 3000);
        }

        function updateActivityTimestamps() {
            const now = new Date();
            
            realActivities.forEach(activity => {
                const diffMs = now - activity.timestamp;
                const diffSeconds = Math.floor(diffMs / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffSeconds < 60) {
                    activity.timeAgo = 'Just now';
                } else if (diffMinutes < 60) {
                    activity.timeAgo = `${diffMinutes} min ago`;
                } else if (diffHours < 24) {
                    activity.timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else {
                    activity.timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                }
            });
            
            updateRealActivityFeed();
        }

        function startActivityFeed() {
            // Update timestamps every minute
            activityTimer = setInterval(() => {
                updateActivityTimestamps();
            }, 60000); // Update every minute
        }

        function stopActivityFeed() {
            if (activityTimer) {
                clearInterval(activityTimer);
                activityTimer = null;
            }
        }

        // Initialize Shift Configuration
        function initShiftConfiguration() {
            // Populate shift leads dropdown
            const preferredLeadSelect = document.getElementById('preferredLead');
            const mandatoryMembersSelect = document.getElementById('mandatoryMembers');
            
            preferredLeadSelect.innerHTML = '<option value="">Select Shift Lead</option>';
            mandatoryMembersSelect.innerHTML = '';
            
            // Add shift leads to preferred lead dropdown
            npeTeamData.filter(member => member.role === 'Shift Lead').forEach(lead => {
                const option = document.createElement('option');
                option.value = lead.name;
                option.textContent = lead.name;
                preferredLeadSelect.appendChild(option);
            });
            
            // Add all team members to mandatory members multiselect
            npeTeamData.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = `${member.name} (${member.role})`;
                mandatoryMembersSelect.appendChild(option);
            });
            
            // Load existing shift configurations
            updateShiftConfigList();
        }

        // Handle Shift Configuration Form (if it exists)
        const shiftConfigForm = document.getElementById('shiftConfigForm');
        if (shiftConfigForm) {
            shiftConfigForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const shiftCode = document.getElementById('shiftCode').value;
                const startTime = document.getElementById('shiftStart').value;
                const endTime = document.getElementById('shiftEnd').value;
                const minStaff = parseInt(document.getElementById('minStaff').value);
                const requiredLeads = parseInt(document.getElementById('requiredLeads').value);
            const requiredAssociates = parseInt(document.getElementById('requiredAssociates').value);
            const preferredLead = document.getElementById('preferredLead').value;
            
            // Get selected mandatory members
            const mandatorySelect = document.getElementById('mandatoryMembers');
            const mandatoryMembers = Array.from(mandatorySelect.selectedOptions).map(opt => opt.value);
            
            // Update shift configuration
            window.shiftConfig[shiftCode] = {
                startTime,
                endTime,
                minStaff,
                requiredLeads,
                requiredAssociates,
                preferredLead,
                mandatoryMembers,
                breakDuration: 30 // Default break duration
            };
            
            updateShiftConfigList();
            this.reset();
            alert('Shift configuration saved successfully!');
        });
        }

        // Update Shift Configuration List
        function updateShiftConfigList() {
            const container = document.getElementById('shiftConfigList');
            container.innerHTML = '';
            
            Object.entries(window.shiftConfig).forEach(([code, config]) => {
                const card = document.createElement('div');
                card.className = 'shift-config-card';
                
                card.innerHTML = `
                    <h4>${code}</h4>
                    <div class="details">
                        <p><strong>Time:</strong> ${config.startTime || 'Not set'} - ${config.endTime || 'Not set'}</p>
                        <p><strong>Staff Requirements:</strong> Min ${config.minStaff} (${config.requiredLeads} Leads, ${config.requiredAssociates} Associates)</p>
                        <p><strong>Preferred Lead:</strong> ${config.preferredLead || 'None'}</p>
                        <p><strong>Mandatory Members:</strong> ${config.mandatoryMembers.join(', ') || 'None'}</p>
                    </div>
                    <div class="actions">
                        <button onclick="editShiftConfig('${code}')" class="btn-secondary">Edit</button>
                        <button onclick="deleteShiftConfig('${code}')" class="btn-danger">Delete</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Edit Shift Configuration
        function editShiftConfig(code) {
            const config = window.shiftConfig[code];
            if (!config) return;
            
            document.getElementById('shiftCode').value = code;
            document.getElementById('shiftStart').value = config.startTime || '';
            document.getElementById('shiftEnd').value = config.endTime || '';
            document.getElementById('minStaff').value = config.minStaff || '';
            document.getElementById('requiredLeads').value = config.requiredLeads || 0;
            document.getElementById('requiredAssociates').value = config.requiredAssociates || 0;
            document.getElementById('preferredLead').value = config.preferredLead || '';
            
            // Set mandatory members
            const mandatorySelect = document.getElementById('mandatoryMembers');
            Array.from(mandatorySelect.options).forEach(opt => {
                opt.selected = config.mandatoryMembers.includes(opt.value);
            });
        }

        // Delete Shift Configuration
        function deleteShiftConfig(code) {
            if (confirm(`Are you sure you want to delete shift ${code}?`)) {
                delete window.shiftConfig[code];
                updateShiftConfigList();
            }
        }

        // Initialize Dashboard
        function initDashboard() {
            // Start activity feed auto-refresh
            stopActivityFeed(); // Stop any existing timer
            startActivityFeed(); // Start new timer
            
            // Workload Distribution Chart with Enhanced Animations
            const ctx1 = document.getElementById('workloadChart').getContext('2d');
            
            // Create gradient backgrounds
            const gradient1 = ctx1.createLinearGradient(0, 0, 0, 200);
            gradient1.addColorStop(0, 'rgba(139, 95, 191, 0.9)');
            gradient1.addColorStop(0.5, 'rgba(163, 116, 208, 0.9)');
            gradient1.addColorStop(1, 'rgba(183, 148, 209, 0.9)');
            
            const gradient2 = ctx1.createLinearGradient(0, 0, 0, 200);
            gradient2.addColorStop(0, 'rgba(79, 172, 254, 0.9)');
            gradient2.addColorStop(0.5, 'rgba(0, 242, 254, 0.9)');
            gradient2.addColorStop(1, 'rgba(67, 233, 123, 0.9)');
            
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['üë®‚Äçüíº Team Leads', 'üë• Team Members'],
                    datasets: [{
                        data: [2, 12],  // 2 Leads, 12 Shift Leads + Associates
                        backgroundColor: [gradient1, gradient2],
                        borderColor: ['rgba(255, 255, 255, 0.8)', 'rgba(255, 255, 255, 0.8)'],
                        borderWidth: 4,
                        hoverBorderWidth: 6,
                        hoverBorderColor: ['rgba(255, 215, 0, 0.8)', 'rgba(255, 215, 0, 0.8)'],
                        hoverBackgroundColor: [
                            'rgba(157, 115, 212, 0.9)', // Lighter purple for leads with transparency
                            'rgba(91, 192, 222, 0.9)'   // Lighter blue for associates with transparency
                        ],
                        borderRadius: 20,
                        spacing: 10,
                        offset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    layout: {
                        padding: 20
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 2500,
                        easing: 'easeOutCubic',
                        delay: (context) => context.dataIndex * 300
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                padding: 25,
                                font: {
                                    family: "'Segoe UI', system-ui, sans-serif",
                                    size: 14,
                                    weight: 600,
                                    lineHeight: 1.5
                                },
                                color: '#2d3748',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: label,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        lineWidth: 2,
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#1a202c',
                            titleFont: {
                                family: "'Segoe UI', system-ui, sans-serif",
                                size: 16,
                                weight: 600
                            },
                            bodyColor: '#4a5568',
                            bodyFont: {
                                family: "'Segoe UI', system-ui, sans-serif",
                                size: 14
                            },
                            bodySpacing: 8,
                            padding: 16,
                            borderColor: 'rgba(139, 95, 191, 0.5)',
                            borderWidth: 2,
                            cornerRadius: 12,
                            displayColors: true,
                            boxWidth: 8,
                            boxHeight: 8,
                            boxPadding: 4,
                            usePointStyle: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Team Distribution';
                                },
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return ` ${context.label}: ${context.parsed} members (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // Leave Status Chart with Enhanced Animations
            const ctx2 = document.getElementById('leaveStatusChart').getContext('2d');
            
            // Create gradients for bar chart
            const pendingGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            pendingGradient.addColorStop(0, 'rgba(255, 217, 61, 0.85)');
            pendingGradient.addColorStop(0.5, 'rgba(255, 182, 25, 0.85)');
            pendingGradient.addColorStop(1, 'rgba(255, 149, 0, 0.85)');
            
            const approvedGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            approvedGradient.addColorStop(0, 'rgba(67, 233, 123, 0.85)');
            approvedGradient.addColorStop(0.5, 'rgba(56, 208, 110, 0.85)');
            approvedGradient.addColorStop(1, 'rgba(56, 193, 114, 0.85)');
            
            const availableGradient = ctx2.createLinearGradient(0, 0, 0, 200);
            availableGradient.addColorStop(0, 'rgba(139, 95, 191, 0.85)');
            availableGradient.addColorStop(0.5, 'rgba(118, 81, 163, 0.85)');
            availableGradient.addColorStop(1, 'rgba(107, 70, 193, 0.85)');
            
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['‚è≥ Pending Requests', '‚úÖ Approved Leaves', 'üë• Team Available'],
                    datasets: [{
                        data: [0, 8, 14],  // 0 Pending, 8 Approved leaves, 14 Available team members
                        backgroundColor: [pendingGradient, approvedGradient, availableGradient],
                        borderColor: ['rgba(255, 149, 0, 0.8)', 'rgba(56, 193, 114, 0.8)', 'rgba(107, 70, 193, 0.8)'],
                        borderWidth: 2,
                        borderRadius: 12,
                        borderSkipped: false,
                        hoverBackgroundColor: ['rgba(255, 184, 77, 0.9)', 'rgba(74, 222, 128, 0.9)', 'rgba(139, 95, 191, 0.9)'],
                        hoverBorderWidth: 3,
                        maxBarThickness: 50,
                        minBarLength: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 25,
                            bottom: 20,
                            left: 25
                        }
                    },
                    animation: {
                        duration: 2500,
                        easing: 'easeOutQuart',
                        delay: (context) => {
                            return context.dataIndex * 350; // Stagger animation
                        },
                        animations: {
                            y: {
                                from: 500
                            },
                            opacity: {
                                from: 0
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#8b5fbf',
                            borderWidth: 2,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label.replace(/[‚è≥‚úÖüë•]/g, '').trim();
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const suffix = context.label.includes('Available') ? ' team members' : ' requests';
                                    return `${value}${suffix}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(139, 95, 191, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            updateDashboardStats();
        }

        // Update Dashboard Statistics with real data
        function updateDashboardStats() {
            document.getElementById('totalEmployees').textContent = npeTeamData.length; // 14 total
            document.getElementById('activeShifts').textContent = '4'; // S1, S2, S3, S4
            document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'pending').length;
            document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'approved').length;
            
            // Update health metrics with real calculations
            const avgConsecutiveDays = calculateAverageConsecutiveDays();
            document.getElementById('avgConsecutiveDays').textContent = avgConsecutiveDays.toFixed(1);
            document.getElementById('burnoutAlerts').textContent = '0'; // No burnout alerts in current schedule
            
            // Update modern analytics dashboard
            updateModernDashboard();
        }

        // Initialize Modern Analytics Dashboard
        function updateModernDashboard() {
            updateKPICards();
            updateHealthMetrics();
            updateAIInsights();
            updateActivityFeed();
        }

        // Update KPI Cards with real data
        function updateKPICards() {
            updateKPIAnalytics();
        }

        // KPI Analytics Functions
        function getEfficiencyScore() {
            // Example: ratio of filled shifts to total possible shifts
            let totalShifts = 0, filledShifts = 0;
            Object.values(scheduleData).forEach(day => {
                Object.values(day).forEach(shiftArr => {
                    totalShifts++;
                    if (shiftArr && shiftArr.length > 0) filledShifts++;
                });
            });
            if (totalShifts === 0) return '0%';
            return Math.round((filledShifts / totalShifts) * 100) + '%';
        }
        function getEfficiencyTrend() {
            // Example: compare to previous month (dummy logic)
            return '‚Üó +2% vs last month';
        }
        function getCoverageRate() {
            // Example: days with all shifts covered
            let daysWithFullCoverage = 0;
            let totalDays = Object.keys(scheduleData).length;
            Object.values(scheduleData).forEach(day => {
                let allCovered = ['S1', 'S2', 'S3'].every(s => day[s] && day[s].length > 0);
                if (allCovered) daysWithFullCoverage++;
            });
            if (totalDays === 0) return '0%';
            return Math.round((daysWithFullCoverage / totalDays) * 100) + '%';
        }
        function getCoverageTrend() {
            // Example: compare to previous period (dummy logic)
            return '‚Üí Stable';
        }
        function getPendingLeavesCount() {
            return leaveRequests.filter(l => l.status === 'pending').length;
        }
        function getPendingLeavesTrend() {
            // Example: compare to previous week (dummy logic)
            return '‚Üò -1 vs last week';
        }
        function updateKPIAnalytics() {
            // Team size
            document.getElementById('totalEmployees').textContent = npeTeamData.length;
            // Team trend (change this month)
            const teamTrend = document.getElementById('teamTrend');
            teamTrend.textContent = (npeTeamData.length - 10 > 0) ? `‚Üó +${npeTeamData.length - 10} this month` : '‚Üí No change';
            // Efficiency (calculated from schedule stats)
            document.getElementById('efficiencyScore').textContent = getEfficiencyScore();
            document.getElementById('efficiencyTrend').textContent = getEfficiencyTrend();
            // Coverage (calculated from schedule stats)
            document.getElementById('coverageRate').textContent = getCoverageRate();
            document.getElementById('coverageTrend').textContent = getCoverageTrend();
            // Pending leaves
            document.getElementById('pendingLeaves').textContent = getPendingLeavesCount();
            document.getElementById('pendingTrend').textContent = getPendingLeavesTrend();
        }
        // Call on dashboard load and after any update
        updateKPIAnalytics();

        // Update Health Metrics with circular progress
        function updateHealthMetrics() {
            updateCircularProgress('staffing-circle', 85, '#10b981');
            updateCircularProgress('balance-circle', 72, '#3b82f6');
            updateCircularProgress('satisfaction-circle', 91, '#f59e0b');
        }

        function updateCircularProgress(id, percentage, color) {
            const chart = document.getElementById(id);
            if (!chart) return;

            const circle = chart.querySelector('.circle');
            const percentageText = chart.querySelector('.percentage');
            
            if (circle && percentageText) {
                const radius = 30;
                const circumference = 2 * Math.PI * radius;
                const strokeDasharray = circumference;
                const strokeDashoffset = circumference - (percentage / 100) * circumference;
                
                circle.style.strokeDasharray = strokeDasharray;
                circle.style.strokeDashoffset = strokeDashoffset;
                circle.style.stroke = color;
                
                percentageText.textContent = `${percentage}%`;
            }
        }

        // Update AI Insights
        function updateAIInsights() {
            const insightsContainer = document.querySelector('.insights-list');
            if (!insightsContainer) return;

            const insights = [
                {
                    type: 'positive',
                    icon: '‚úÖ',
                    title: 'Optimal Coverage Detected',
                    description: 'All shifts are properly staffed with minimal overtime requirements.'
                },
                {
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Weekend Coverage Opportunity',
                    description: 'Consider rotating weekend assignments to improve work-life balance.'
                },
                {
                    type: 'info',
                    icon: 'üí°',
                    title: 'AI Recommendation',
                    description: 'Pattern analysis suggests reducing consecutive night shifts for better rest periods.'
                }
            ];

            insightsContainer.innerHTML = insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <span class="insight-icon">${insight.icon}</span>
                    <div>
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update Activity Feed
        function updateActivityFeed() {
            const feedContainer = document.querySelector('.activity-feed');
            if (!feedContainer) return;

            const activities = [
                {
                    time: '2 minutes ago',
                    content: '<span class="activity-user">System</span> generated new roster for <span class="activity-highlight">August 2025</span>'
                },
                {
                    time: '15 minutes ago',
                    content: '<span class="activity-user">AI Assistant</span> analyzed workload patterns and identified optimization opportunities'
                },
                {
                    time: '1 hour ago',
                    content: '<span class="activity-user">Manager</span> approved leave request for <span class="activity-highlight">Weekend Coverage</span>'
                },
                {
                    time: '3 hours ago',
                    content: '<span class="activity-user">System</span> imported team data and updated <span class="activity-highlight">14 employee profiles</span>'
                }
            ];

            feedContainer.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-time">${activity.time}</div>
                    <div class="activity-content">${activity.content}</div>
                </div>
            `).join('');
        }

        // Calculate average consecutive working days from real schedule
        function calculateAverageConsecutiveDays() {
            let totalConsecutiveDays = 0;
            let employeeCount = 0;
            
            npeTeamData.forEach(employee => {
                let consecutiveDays = 0;
                let maxConsecutive = 0;
                
                // Check each day in August 2025
                for (let day = 1; day <= 31; day++) {
                    const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                    const daySchedule = scheduleData[dateStr];
                    
                    if (daySchedule) {
                        let isWorking = false;
                        Object.values(daySchedule).forEach(shift => {
                            if (shift.includes(employee.name)) {
                                isWorking = true;
                            }
                        });
                        
                        if (isWorking) {
                            consecutiveDays++;
                            maxConsecutive = Math.max(maxConsecutive, consecutiveDays);
                        } else {
                            consecutiveDays = 0;
                        }
                    }
                }
                
                totalConsecutiveDays += maxConsecutive;
                employeeCount++;
            });
            
            return employeeCount > 0 ? totalConsecutiveDays / employeeCount : 0;
        }

        // Load Team Data with real employee information
        function loadTeamData() {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';
            
            npeTeamData.forEach(member => {
                const row = document.createElement('tr');
                const daysOffText = member.daysOff.map(day => {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    return days[day];
                }).join(', ');
                
                let roleColor = '#8b5fbf'; // Default purple
                if (member.role === 'Lead') roleColor = '#dc3545'; // Red for leads
                else if (member.role === 'Shift Lead') roleColor = '#ffc107'; // Orange for shift leads
                else if (member.role === 'Associate') roleColor = '#28a745'; // Green for associates
                
                row.innerHTML = `
                    <td><strong>${member.cts}</strong></td>
                    <td><code>${member.eshc}</code></td>
                    <td><strong>${member.name}</strong></td>
                    <td><span style="padding: 3px 8px; border-radius: 12px; font-size: 12px; background: ${roleColor}; color: white;">${member.role}</span></td>
                    <td><span style="color: green;">‚úì ${member.status}</span></td>
                    <td>${daysOffText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize Leave Management
        function initLeaveManagement() {
            // Populate employee select
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">Select Employee</option>';
            npeTeamData.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').value = today;

            updateLeaveRequests();
            generateLeaveCalendar();
            updateMonthlyLeavesList();
        }

        // Handle Leave Request Form (if it exists)
        const leaveRequestForm = document.getElementById('leaveRequestForm');
        if (leaveRequestForm) {
            leaveRequestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const employeeId = document.getElementById('employeeSelect').value;
                const leaveDate = document.getElementById('leaveDate').value;
                const leaveType = document.getElementById('leaveType').value;
                const leaveReason = document.getElementById('leaveReason').value;
            
            if (!employeeId || !leaveDate || !leaveType) {
                alert('Please fill all required fields!');
                return;
            }

            const employee = npeTeamData.find(e => e.id === employeeId);
            const request = {
                id: Date.now().toString(),
                employeeId: employeeId,
                employeeName: employee.name,
                date: leaveDate,
                type: leaveType,
                reason: leaveReason,
                status: 'pending',
                requestDate: new Date().toISOString()
            };

            leaveRequests.push(request);
            updateLeaveRequests();
            updateDashboardStats();
            
            // Reset form
            this.reset();
            document.getElementById('leaveDate').value = new Date().toISOString().split('T')[0];
            
            alert('Leave request submitted successfully!');
        });
        }

        // Update Leave Requests Display
        function updateLeaveRequests() {
            const container = document.getElementById('pendingLeavesList');
            const pendingLeaves = leaveRequests.filter(l => l.status === 'pending');
            
            if (pendingLeaves.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No pending leave requests</p>';
                return;
            }
            
            container.innerHTML = pendingLeaves.map(leave => `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${leave.employeeName}</strong>
                        <span style="font-size: 12px; color: var(--text-light);">${leave.date}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #ffc107; color: white;">${leave.type}</span>
                    </div>
                    ${leave.reason ? `<p style="font-size: 14px; margin-bottom: 10px;">${leave.reason}</p>` : ''}
                    <div>
                        <button class="btn btn-success" style="padding: 5px 12px; margin-right: 5px;" onclick="approveLeave('${leave.id}')">‚úì Approve</button>
                        <button class="btn btn-danger" style="padding: 5px 12px;" onclick="rejectLeave('${leave.id}')">‚úó Reject</button>
                    </div>
                </div>
            `).join('');
        }

        // Approve Leave Request
        function approveLeave(leaveId) {
            const leave = leaveRequests.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'approved';
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                
                // Track this activity
                addRealActivity('‚úÖ Leave approved', `${leave.employeeName} for ${leave.date}`);
                
                alert(`Leave approved for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Reject Leave Request
        function rejectLeave(leaveId) {
            const index = leaveRequests.findIndex(l => l.id === leaveId);
            if (index !== -1) {
                const leave = leaveRequests[index];
                leaveRequests.splice(index, 1);
                updateLeaveRequests();
                updateDashboardStats();
                generateLeaveCalendar();
                
                // Track this activity
                addRealActivity('‚ùå Leave rejected', `${leave.employeeName} for ${leave.date}`);
                
                alert(`Leave rejected for ${leave.employeeName} on ${leave.date}`);
            }
        }

        // Generate Leave Calendar
        function generateLeaveCalendar() {
            const container = document.getElementById('leaveCalendar');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear calendar
            container.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.fontWeight = 'bold';
                header.style.textAlign = 'center';
                header.style.padding = '10px 5px';
                header.style.background = 'var(--primary-color)';
                header.style.color = 'white';
                header.style.borderRadius = '5px';
                header.style.fontSize = '12px';
                header.textContent = day;
                container.appendChild(header);
            });
            
            // Add empty cells for days before month start
            const firstDay = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                container.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const leavesForDay = leaveRequests.filter(l => l.date === dateStr && l.status === 'approved');
                
                if (leavesForDay.length > 0) {
                    dayElement.classList.add('has-leave');
                    
                    // Create employees container
                    const employeesContainer = document.createElement('div');
                    employeesContainer.className = 'leave-employees';
                    
                    leavesForDay.forEach(leave => {
                        const employeeItem = document.createElement('div');
                        employeeItem.className = 'leave-employee-item';
                        
                        const employeeName = document.createElement('span');
                        employeeName.className = 'leave-employee-name';
                        employeeName.textContent = leave.employeeName;
                        employeeItem.appendChild(employeeName);
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-leave-btn';
                        cancelBtn.innerHTML = '√ó';
                        cancelBtn.title = `Cancel leave for ${leave.employeeName}`;
                        cancelBtn.onclick = (e) => {
                            e.stopPropagation();
                            cancelLeave(leave.employeeName, dateStr);
                        };
                        employeeItem.appendChild(cancelBtn);
                        
                        employeesContainer.appendChild(employeeItem);
                    });
                    
                    dayElement.appendChild(employeesContainer);
                }
                
                container.appendChild(dayElement);
            }
        }

        // Function to cancel leave
        function cancelLeave(employeeName, dateStr) {
            const confirmation = confirm(`Cancel leave for ${employeeName} on ${dateStr}?`);
            if (confirmation) {
                // Remove the leave from the array
                const leaveIndex = leaveRequests.findIndex(l => 
                    l.employeeName === employeeName && 
                    l.date === dateStr && 
                    l.status === 'approved'
                );
                
                if (leaveIndex !== -1) {
                    leaveRequests.splice(leaveIndex, 1);
                    
                    // Update the leave calendar
                    generateLeaveCalendar();
                    
                    // Update the leave requests display
                    updateLeaveRequests();
                    
                    // Show success message
                    showNotification(`Leave cancelled for ${employeeName} on ${dateStr}`, 'success');
                }
            }
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#28a745';
                    break;
                case 'error':
                    notification.style.background = '#dc3545';
                    break;
                default:
                    notification.style.background = '#17a2b8';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Schedule Generation
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('startDate').value;
            const numDays = parseInt(document.getElementById('numDays').value);
            
            if (!startDate) {
                alert('Please select a start date!');
                return;
            }
            
            generateSchedule(startDate, numDays);
        });

        // Generate AI Schedule
        function generateSchedule(startDate, numDays) {
            const output = document.getElementById('scheduleOutput');
            output.innerHTML = '<p style="text-align: center;">ü§ñ AI is generating health-conscious schedule...</p>';
            
            // Simulate AI processing
            setTimeout(() => {
                const schedule = createHealthConsciousSchedule(startDate, numDays);
                displaySchedule(schedule);
            }, 2000);
        }

        // Create Health-Conscious Schedule with New Requirements
        function createHealthConsciousSchedule(startDate, numDays) {
            const schedule = {};
            
            // Track consecutive work days and week offs for each employee
            const consecutiveDays = {};
            const weekOffsGiven = {};
            const lastWorkDate = {};
            
            // Initialize tracking for all team members
            npeTeamData.forEach(emp => {
                consecutiveDays[emp.name] = 0;
                weekOffsGiven[emp.name] = 0;
                lastWorkDate[emp.name] = null;
            });
            
            // Get first 5 members (ShiftLeads) who must cover all shifts
            const shiftLeads = npeTeamData.filter(emp => emp.role === 'ShiftLead');
            const s2OnlyMembers = npeTeamData.filter(emp => emp.role === 'S2Only');
            const associates = npeTeamData.filter(emp => emp.role === 'Associate');
            
            // Calculate total weekends (Saturdays + Sundays) in the period for week off validation
            let totalWeekends = 0;
            for (let i = 0; i < numDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) totalWeekends++; // 0 = Sunday, 6 = Saturday
            }
            
            // Week Off Rule: Each employee's total off days should not exceed total weekends
            console.log(`Total weekends (Sat+Sun) in schedule period: ${totalWeekends}`);
            
            for (let i = 0; i < numDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                
                schedule[dateStr] = {};
                
                // Check for extra offs
                const membersOnExtraOff = npeTeamData.filter(emp => 
                    emp.extraOffs && emp.extraOffs.includes(dateStr)
                );
                
                // Determine shifts based on day of week
                let shiftsToday = [];
                if (dayOfWeek === 0) { // Sunday - only S2 and S3
                    shiftsToday = ['S2', 'S3'];
                } else { // Monday to Saturday - S1, S2, S3
                    shiftsToday = ['S1', 'S2', 'S3'];
                }
                
                // Initialize shifts
                shiftsToday.forEach(shift => {
                    schedule[dateStr][shift] = [];
                });
                
                // Assign shifts based on requirements
                shiftsToday.forEach(shift => {
                    let requiredCount = 0;
                    let availableMembers = [];
                    
                    if (shift === 'S1') {
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                            requiredCount = 3;
                            availableMembers = [...shiftLeads, ...associates];
                        } else if (dayOfWeek === 6) { // Saturday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates];
                        }
                    } else if (shift === 'S2') {
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates, ...s2OnlyMembers];
                        } else if (dayOfWeek === 6) { // Saturday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates, ...s2OnlyMembers];
                        } else { // Sunday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates, ...s2OnlyMembers];
                        }
                    } else if (shift === 'S3') {
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                            requiredCount = 3;
                            availableMembers = [...shiftLeads, ...associates];
                        } else if (dayOfWeek === 6) { // Saturday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates];
                        } else { // Sunday
                            requiredCount = 2;
                            availableMembers = [...shiftLeads, ...associates];
                        }
                    }
                    
                    // Filter out members on extra off
                    availableMembers = availableMembers.filter(emp => 
                        !membersOnExtraOff.some(offEmp => offEmp.name === emp.name)
                    );
                    
                    // Apply week-off rule: filter out employees who have reached weekend limit
                    availableMembers = availableMembers.filter(emp => {
                        const totalOffDays = countOffDaysForEmployee(emp.name, schedule, startDate, i);
                        const extraOffDays = emp.extraOffs ? emp.extraOffs.length : 0;
                        return (totalOffDays + extraOffDays) <= totalWeekends;
                    });
                    
                    // Ensure at least one ShiftLead is in every shift (except S2 on weekend if needed)
                    const availableShiftLeads = shiftLeads.filter(emp => 
                        !membersOnExtraOff.some(offEmp => offEmp.name === emp.name) &&
                        consecutiveDays[emp.name] < 6 && // Max 6 consecutive days
                        (countOffDaysForEmployee(emp.name, schedule, startDate, i) + (emp.extraOffs ? emp.extraOffs.length : 0)) <= totalWeekends
                    );
                    
                    const availableOthers = availableMembers.filter(emp => 
                        emp.role !== 'ShiftLead' &&
                        consecutiveDays[emp.name] < 6 && 
                        (countOffDaysForEmployee(emp.name, schedule, startDate, i) + (emp.extraOffs ? emp.extraOffs.length : 0)) <= totalWeekends
                    );
                    
                    // Sort by consecutive days worked (prioritize those who worked less)
                    availableShiftLeads.sort((a, b) => consecutiveDays[a.name] - consecutiveDays[b.name]);
                    availableOthers.sort((a, b) => consecutiveDays[a.name] - consecutiveDays[b.name]);
                    
                    // Assign members to shift
                    const assigned = [];
                    
                    // First, assign at least one ShiftLead if available
                    if (availableShiftLeads.length > 0) {
                        assigned.push(availableShiftLeads[0]);
                    }
                    
                    // Fill remaining positions
                    const remaining = requiredCount - assigned.length;
                    const remainingCandidates = [
                        ...availableShiftLeads.slice(1),
                        ...availableOthers
                    ].slice(0, remaining);
                    
                    assigned.push(...remainingCandidates);
                    
                    // Add to schedule
                    schedule[dateStr][shift] = assigned.map(emp => emp.name);
                    
                    // Update consecutive days counter
                    assigned.forEach(emp => {
                        consecutiveDays[emp.name]++;
                        lastWorkDate[emp.name] = dateStr;
                    });
                });
                
                // Check for week offs (consecutive days after 4-6 days of work)
                npeTeamData.forEach(emp => {
                    const isWorkingToday = shiftsToday.some(shift => 
                        schedule[dateStr][shift].includes(emp.name)
                    );
                    
                    if (!isWorkingToday) {
                        consecutiveDays[emp.name] = 0; // Reset consecutive counter
                        
                        // Check if this is a week off (not working and had worked 4+ consecutive days)
                        if (lastWorkDate[emp.name] && consecutiveDays[emp.name] === 0) {
                            weekOffsGiven[emp.name]++;
                        }
                    }
                });
            }
            
            scheduleData = schedule;
            return schedule;
        }
        
        // Helper function to count off days for an employee up to a certain point
        function countOffDaysForEmployee(employeeName, schedule, startDate, currentDayIndex) {
            let offDays = 0;
            for (let i = 0; i < currentDayIndex; i++) {
                const checkDate = new Date(startDate);
                checkDate.setDate(checkDate.getDate() + i);
                const dateStr = checkDate.toISOString().split('T')[0];
                const dayOfWeek = checkDate.getDay();
                
                if (schedule[dateStr]) {
                    const shiftsToday = dayOfWeek === 0 ? ['S2', 'S3'] : ['S1', 'S2', 'S3'];
                    const isWorking = shiftsToday.some(shift => 
                        schedule[dateStr][shift] && schedule[dateStr][shift].includes(employeeName)
                    );
                    
                    if (!isWorking) {
                        offDays++;
                    }
                }
            }
            return offDays;
        }

        // Display Generated Schedule
        function displaySchedule(schedule) {
            const output = document.getElementById('scheduleOutput');
            let html = '<div class="alert alert-success">‚úÖ NPE ShiftBot schedule generated according to requirements!</div>';
            
            // Track this activity
            const numDays = parseInt(document.getElementById('numDays').value);
            let duration = '';
            if (numDays === 7) duration = '1 Week';
            else if (numDays === 14) duration = '2 Weeks';
            else if (numDays === 30) duration = '1 Month';
            else if (numDays === 60) duration = '2 Months';
            else duration = `${numDays} days`;
            
            addRealActivity('ü§ñ Schedule generated', `${duration} schedule with AI optimization`);
            
            // Calculate total weekends in schedule
            const scheduleKeys = Object.keys(schedule);
            let totalWeekends = 0;
            scheduleKeys.forEach(dateStr => {
                const date = new Date(dateStr);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) totalWeekends++;
            });
            
            html += '<div class="requirements-summary" style="background:#f8f9fa; padding:15px; border-radius:8px; margin:15px 0;">';
            html += '<h5>üìã Schedule Requirements Applied:</h5>';
            html += '<ul style="margin:0; padding-left:20px;">';
            html += '<li>‚úì One of first 5 members (Jeyakaran, Karthikeyan, Manoj, Panner, SaiKumar) in every shift</li>';
            html += '<li>‚úì Dinesh and Mano only in S2 (no shift coverage)</li>';
            html += '<li>‚úì Mon-Fri: 3 members in S1&S3, 2 members in S2</li>';
            html += '<li>‚úì Saturday: 2 members in each shift (S1, S2, S3)</li>';
            html += '<li>‚úì Sunday: Only S2&S3 with 2 members each</li>';
            html += `<li>‚úì Week offs limited to weekend count: <strong>${totalWeekends} weekends</strong> (Sat+Sun)</li>`;
            html += '</ul></div>';
            
            html += '<table class="table table-striped" style="font-size: 12px;"><thead class="table-dark"><tr><th>Date</th><th>Day</th><th>S1 (Morning)</th><th>S2 (Afternoon)</th><th>S3 (Night)</th></tr></thead><tbody>';
            
            Object.keys(schedule).forEach(date => {
                const daySchedule = schedule[date];
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                
                html += `<tr ${isWeekend ? 'style="background-color:#fff3cd;"' : ''}>`;
                html += `<td><strong>${date}</strong></td>`;
                html += `<td><span class="badge ${isWeekend ? 'bg-warning text-dark' : 'bg-secondary'}">${dayName}</span></td>`;
                
                // Display shifts
                ['S1', 'S2', 'S3'].forEach(shift => {
                    if (daySchedule[shift]) {
                        const members = daySchedule[shift];
                        if (members.length > 0) {
                            // Highlight ShiftLeads in each shift
                            const memberList = members.map(name => {
                                const isShiftLead = npeTeamData.find(emp => emp.name === name && emp.role === 'ShiftLead');
                                const isS2Only = npeTeamData.find(emp => emp.name === name && emp.role === 'S2Only');
                                if (isShiftLead) {
                                    return `<span class="badge bg-primary">${name}</span>`;
                                } else if (isS2Only) {
                                    return `<span class="badge bg-warning text-dark">${name}</span>`;
                                } else {
                                    return `<span class="badge bg-secondary">${name}</span>`;
                                }
                            }).join(' ');
                            html += `<td>${memberList}</td>`;
                        } else {
                            html += `<td><em class="text-muted">No shift</em></td>`;
                        }
                    } else {
                        html += `<td><em class="text-muted">No shift</em></td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // Add summary statistics with weekend validation
            html += '<div class="mt-4"><h5>üìä Schedule Summary:</h5>';
            html += '<div class="row">';
            
            // Count assignments per person and validate against weekend count
            const assignments = {};
            const offDays = {};
            npeTeamData.forEach(emp => {
                assignments[emp.name] = 0;
                offDays[emp.name] = 0;
            });
            
            Object.keys(schedule).forEach(dateStr => {
                const dateObj = new Date(dateStr);
                const dayOfWeek = dateObj.getDay();
                const shiftsToday = dayOfWeek === 0 ? ['S2', 'S3'] : ['S1', 'S2', 'S3'];
                
                npeTeamData.forEach(emp => {
                    const isWorking = shiftsToday.some(shift => 
                        schedule[dateStr][shift] && schedule[dateStr][shift].includes(emp.name)
                    );
                    
                    if (isWorking) {
                        assignments[emp.name]++;
                    } else {
                        offDays[emp.name]++;
                    }
                });
            });
            
            html += '<div class="col-md-6"><h6>Individual Work Days:</h6><ul class="list-group list-group-flush">';
            Object.entries(assignments).forEach(([name, count]) => {
                const member = npeTeamData.find(emp => emp.name === name);
                const roleColor = member?.role === 'ShiftLead' ? 'primary' : 
                                 member?.role === 'S2Only' ? 'warning' : 'secondary';
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>${name} <span class="badge bg-${roleColor}">${member?.role || 'Unknown'}</span></span>
                    <span class="badge bg-info">${count} days</span>
                </li>`;
            });
            html += '</ul></div>';
            
            html += '<div class="col-md-6"><h6>Week-Off Validation:</h6><ul class="list-group list-group-flush">';
            Object.entries(offDays).forEach(([name, offCount]) => {
                const member = npeTeamData.find(emp => emp.name === name);
                const extraOffs = member?.extraOffs ? member.extraOffs.length : 0;
                const totalOffs = offCount + extraOffs;
                const isValid = totalOffs <= totalWeekends;
                const statusColor = isValid ? 'success' : 'danger';
                const statusIcon = isValid ? '‚úì' : '‚ö†';
                
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>${name} (${totalOffs} offs)</span>
                    <span class="badge bg-${statusColor}">${statusIcon} ${isValid ? 'Valid' : 'Exceeds'}</span>
                </li>`;
            });
            html += '</ul>';
            html += `<div class="alert alert-info mt-2"><small><strong>Rule:</strong> Total offs ‚â§ ${totalWeekends} weekends</small></div>`;
            html += '</div>';
            
            html += '</div></div>';
            
            output.innerHTML = html;
        }

        // Extra Off Management Functions
        function initializeExtraOffManagement() {
            // Ensure we have a slight delay to make sure DOM is ready
            const employeeSelect = document.getElementById('extraOffEmployee');
            if (!employeeSelect) {
                console.warn('Employee select not found, retrying...');
                setTimeout(initializeExtraOffManagement, 100);
                return;
            }
            
            // Clear and populate employee dropdown
            employeeSelect.innerHTML = '<option value="">Choose employee...</option>';
            
            // Check if npeTeamData is available
            if (typeof npeTeamData !== 'undefined' && npeTeamData && npeTeamData.length > 0) {
                npeTeamData.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.name;
                    option.textContent = `${emp.name} (${emp.role})`;
                    employeeSelect.appendChild(option);
                });
            } else {
                // If npeTeamData is not available, add a placeholder
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Team data not loaded yet...';
                option.disabled = true;
                employeeSelect.appendChild(option);
            }
            
            // Set up event listeners for date picker updates
            const startDateEl = document.getElementById('startDate');
            const numDaysEl = document.getElementById('numDays');
            const extraOffStartDateEl = document.getElementById('extraOffStartDate');
            const extraOffEndDateEl = document.getElementById('extraOffEndDate');
            
            if (startDateEl && !startDateEl.dataset.extraOffListener) {
                startDateEl.addEventListener('change', () => {
                    console.log('Start date changed to:', startDateEl.value);
                    updateExtraOffDatePicker();
                });
                startDateEl.dataset.extraOffListener = 'true';
            }
            if (numDaysEl && !numDaysEl.dataset.extraOffListener) {
                numDaysEl.addEventListener('change', () => {
                    console.log('Number of days changed to:', numDaysEl.value);
                    updateExtraOffDatePicker();
                });
                numDaysEl.dataset.extraOffListener = 'true';
            }
            if (extraOffStartDateEl && !extraOffStartDateEl.dataset.extraOffListener) {
                extraOffStartDateEl.addEventListener('change', updateExtraOffDatePicker);
                extraOffStartDateEl.dataset.extraOffListener = 'true';
            }
            if (extraOffEndDateEl && !extraOffEndDateEl.dataset.extraOffListener) {
                extraOffEndDateEl.addEventListener('change', updateExtraOffDatePicker);
                extraOffEndDateEl.dataset.extraOffListener = 'true';
            }
            
            updateExtraOffDisplay();
        }
        
        function updateExtraOffDatePicker() {
            let startDate, numDays;
            
            // Check if custom date range is provided
            const customStartDate = document.getElementById('extraOffStartDate').value;
            const customEndDate = document.getElementById('extraOffEndDate').value;
            
            if (customStartDate && customEndDate) {
                // Use custom date range
                startDate = customStartDate;
                const start = new Date(customStartDate);
                const end = new Date(customEndDate);
                numDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                console.log('Using custom date range:', customStartDate, 'to', customEndDate, '(', numDays, 'days)');
            } else {
                // Use main schedule dates
                startDate = document.getElementById('startDate').value;
                numDays = parseInt(document.getElementById('numDays').value);
                console.log('Using main schedule dates:', startDate, 'for', numDays, 'days');
            }
            
            const datePickerContainer = document.getElementById('extraOffDatePicker');
            
            if (!startDate || !numDays) {
                datePickerContainer.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">üìÖ Please set a date range above or use the main schedule dates to see available days</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < numDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                html += `
                    <div class="form-check" style="margin: 5px 0; ${isWeekend ? 'background: #fff3cd; padding: 5px; border-radius: 3px;' : ''}">
                        <input class="form-check-input" type="checkbox" value="${dateStr}" id="date_${dateStr}">
                        <label class="form-check-label" for="date_${dateStr}" style="font-size: 14px;">
                            ${dateStr} (${dayName}) ${isWeekend ? 'üåÖ' : ''}
                        </label>
                    </div>
                `;
            }
            
            if (html) {
                datePickerContainer.innerHTML = html;
            } else {
                datePickerContainer.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">No dates available in the specified range</p>';
            }
        }
        
        function useMainScheduleDates() {
            // Clear custom dates and use main schedule dates
            document.getElementById('extraOffStartDate').value = '';
            document.getElementById('extraOffEndDate').value = '';
            
            // Update the date picker
            updateExtraOffDatePicker();
        }
        
        function addExtraOffs() {
            const employeeName = document.getElementById('extraOffEmployee').value;
            if (!employeeName) {
                alert('Please select an employee');
                return;
            }
            
            const selectedDates = [];
            const checkboxes = document.querySelectorAll('#extraOffDatePicker input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                selectedDates.push(checkbox.value);
            });
            
            if (selectedDates.length === 0) {
                alert('Please select at least one date');
                return;
            }
            
            // Add to employee's extra offs
            const employee = npeTeamData.find(emp => emp.name === employeeName);
            if (employee) {
                if (!employee.extraOffs) employee.extraOffs = [];
                
                selectedDates.forEach(date => {
                    if (!employee.extraOffs.includes(date)) {
                        employee.extraOffs.push(date);
                    }
                });
                
                // Sort dates
                employee.extraOffs.sort();
            }
            
            // Clear selections
            checkboxes.forEach(checkbox => checkbox.checked = false);
            document.getElementById('extraOffEmployee').value = '';
            
            updateExtraOffDisplay();
            
            // Track this activity
            addRealActivity('üèñÔ∏è Extra offs added', `${selectedDates.length} day(s) for ${employeeName}`);
            
            alert(`Added ${selectedDates.length} extra off day(s) for ${employeeName}`);
        }
        
        function clearAllExtraOffs() {
            if (confirm('Are you sure you want to clear all extra offs for all employees?')) {
                npeTeamData.forEach(emp => {
                    emp.extraOffs = [];
                });
                updateExtraOffDisplay();
                alert('All extra offs cleared');
            }
        }
        
        function removeExtraOff(employeeName, date) {
            const employee = npeTeamData.find(emp => emp.name === employeeName);
            if (employee && employee.extraOffs) {
                employee.extraOffs = employee.extraOffs.filter(d => d !== date);
                updateExtraOffDisplay();
            }
        }
        
        function updateExtraOffDisplay() {
            const displayContainer = document.getElementById('extraOffsDisplay');
            
            // Collect all extra offs
            const allExtraOffs = [];
            npeTeamData.forEach(emp => {
                if (emp.extraOffs && emp.extraOffs.length > 0) {
                    emp.extraOffs.forEach(date => {
                        allExtraOffs.push({ employee: emp.name, date: date, role: emp.role });
                    });
                }
            });
            
            if (allExtraOffs.length === 0) {
                displayContainer.innerHTML = '<p class="text-muted">No extra offs scheduled</p>';
                return;
            }
            
            // Sort by date
            allExtraOffs.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div class="list-group list-group-flush">';
            allExtraOffs.forEach(off => {
                const roleColor = off.role === 'ShiftLead' ? 'primary' : 
                                 off.role === 'S2Only' ? 'warning' : 'secondary';
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${off.employee}</strong> 
                            <span class="badge bg-${roleColor}">${off.role}</span>
                            <br>
                            <small class="text-muted">${off.date}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="removeExtraOff('${off.employee}', '${off.date}')">
                            Remove
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            displayContainer.innerHTML = html;
        }

        // Download Schedule as Excel in SharePoint Format with FULL FORMATTING
        async function downloadSchedule() {
            try {
                // Create new workbook with ExcelJS (supports formatting!)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Shift Roster - Format');
                
                // Set up basic worksheet properties
                worksheet.properties.defaultRowHeight = 20;
                
                // Row 1: Header with QA&DOD, UAT sections
                const row1 = worksheet.getRow(1);
                row1.getCell(8).value = 'QA&DOD';
                row1.getCell(9).value = 'UAT';
                
                // Style the header row
                row1.getCell(8).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                row1.getCell(9).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(9).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                
                // Row 3: Date headers
                const row3 = worksheet.getRow(3);
                row3.getCell(4).value = 'Date/Month/Year';
                row3.getCell(4).font = { bold: true };
                
                for (let day = 1; day <= 31; day++) {
                    const formattedDate = String(day).padStart(2, '0') + '-Aug-25';
                    const cell = row3.getCell(5 + day);
                    cell.value = formattedDate;
                    cell.font = { bold: true, size: 10 };
                    cell.alignment = { horizontal: 'center' };
                }
                
                // Row 4: Column headers and day names
                const row4 = worksheet.getRow(4);
                row4.getCell(4).value = 'CTS';
                row4.getCell(5).value = 'ESHC';
                row4.getCell(6).value = 'Name';
                
                // Style column headers
                [4, 5, 6].forEach(col => {
                    const cell = row4.getCell(col);
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' }, bottom: { style: 'thin' },
                        left: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
                
                for (let day = 1; day <= 31; day++) {
                    const date = new Date(2025, 7, day);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    const cell = row4.getCell(6 + day);
                    cell.value = dayName;
                    cell.font = { bold: true, size: 9 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                }
                
                // Employee rows with formatting
                let currentRow = 5;
                npeTeamData.forEach((employee, empIndex) => {
                    const row = worksheet.getRow(currentRow);
                    
                    // Employee info columns
                    row.getCell(4).value = employee.cts;
                    row.getCell(5).value = employee.eshc;
                    row.getCell(6).value = employee.name;
                    
                    // Style employee info
                    [4, 5, 6].forEach(col => {
                        const cell = row.getCell(col);
                        cell.font = { bold: col === 6 }; // Bold name only
                        cell.alignment = { horizontal: col === 6 ? 'left' : 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    });
                    
                    // Daily assignments with color coding
                    for (let day = 1; day <= 31; day++) {
                        const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                        const daySchedule = realAugust2025Schedule[dateStr] || {};
                        
                        let assignment = 'OFF';
                        
                        // Check which shift the employee is assigned to
                        Object.keys(daySchedule).forEach(shift => {
                            if (daySchedule[shift] && daySchedule[shift].includes(employee.name)) {
                                assignment = shift;
                            }
                        });
                        
                        // Check for leaves
                        const leave = realLeaveData.find(l => 
                            l.employeeName === employee.name && 
                            l.date === dateStr && 
                            l.status === 'approved'
                        );
                        
                        if (leave) {
                            assignment = 'Leave';
                        }
                        
                        const cell = row.getCell(6 + day);
                        cell.value = assignment;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: assignment !== 'OFF', size: 10 };
                        
                        // Color coding based on assignment and WFO policy using Chennai timezone
                        if (assignment === 'Leave') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Bright red
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else if (assignment === 'OFF') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF808080' } }; // Gray
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else {
                            // Check if it's weekend using Chennai timezone
                            const currentDate = new Date(2025, 7, day);
                            const isWeekend = isWeekendInChennai(currentDate);
                            
                            if (isWeekend) {
                                // Weekend work = WFH (Strong Blue highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0066CC' } }; // Strong blue
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            } else {
                                // Weekday work = WFO (Strong Green highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00AA00' } }; // Strong green
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            }
                        }
                        
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    
                    currentRow++;
                });
                
                // Add summary rows for shift counts
                currentRow += 1; // Add space
                
                ['S1', 'S2', 'S3'].forEach(shiftType => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(6).value = shiftType;
                    row.getCell(6).font = { bold: true };
                    row.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                    
                    for (let day = 1; day <= 31; day++) {
                        const dateStr = `2025-08-${String(day).padStart(2, '0')}`;
                        const daySchedule = realAugust2025Schedule[dateStr] || {};
                        const count = (daySchedule[shiftType] || []).length;
                        
                        const cell = row.getCell(6 + day);
                        cell.value = count;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: true };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    currentRow++;
                });
                
                // Add shift timing legend
                currentRow += 2;
                const legendData = [
                    ['S1', '06:00 AM TO 04:00 PM IST'],
                    ['S2', '01:00 PM TO 11:00 PM IST'],
                    ['S3', '10:00 PM TO 08:00 AM IST'],
                    ['S4', '12:30 PM TO 10:30 PM IST'],
                    ['G', '09:00 AM TO 07:00 PM IST'],
                    ['P', '06:30 PM TO 04:30 AM IST'],
                    ['HIH', '11:30 AM TO 08:30 PM IST']
                ];
                
                legendData.forEach(([shift, time]) => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(2).value = shift;
                    row.getCell(3).value = time;
                    
                    row.getCell(2).font = { bold: true };
                    row.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9EAD3' } };
                    currentRow++;
                });
                
                // Add team structure
                currentRow += 2;
                const teamData = [
                    ['LeadS'],
                    ['593300', 'EH0647', 'Dinesh Anbalagan'],
                    ['560008', 'EG4208', 'Mano'],
                    ['Shift Leads'],
                    ['410093', 'EH6832', 'Jeyakaran'],
                    ['2167353', 'C7H8KH', 'Karthikeyan'],
                    ['2054459', 'C6X8FS', 'Panner'],
                    ['2240608', 'C7T7SF', 'Sai Kumar'],
                    ['2136623', 'C8G3CW', 'Manoj']
                ];
                
                teamData.forEach(rowData => {
                    const row = worksheet.getRow(currentRow);
                    rowData.forEach((value, colIndex) => {
                        const cell = row.getCell(colIndex + 1);
                        cell.value = value;
                        if (rowData.length === 1) { // Headers
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                        }
                    });
                    currentRow++;
                });
                
                // Set column widths
                worksheet.getColumn(4).width = 10; // CTS
                worksheet.getColumn(5).width = 8;  // ESHC
                worksheet.getColumn(6).width = 15; // Name
                for (let i = 7; i <= 37; i++) {
                    worksheet.getColumn(i).width = 7; // Date columns
                }
                
                // Generate and download the file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const fileName = `Shift_Roster_Format_August_2025_WITH_COLORS.xlsx`;
                saveAs(blob, fileName);
                
                // Track this activity
                addRealActivity('üì• Excel downloaded', `Schedule exported as ${fileName}`);
                
                // Show success message
                alert(`üé® Excel exported with FULL FORMATTING!\n\nFile: ${fileName}\n\n‚úÖ Features:\nüü¢ GREEN highlighting for WFO assignments\nÔøΩ RED highlighting for leaves\n‚ö™ GRAY for OFF days\nüìä Professional borders and fonts\nÔøΩ Ready for SharePoint!`);
                
            } catch (error) {
                console.error('Excel export error:', error);
                alert(`‚ùå Export failed: ${error.message}`);
            }
        }

        // Export AI-generated roster to SharePoint Excel format with FULL FORMATTING
        async function exportGeneratedRosterToSharePoint(startDate, endDate) {
            try {
                // Create new workbook with ExcelJS (supports full formatting!)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('AI Generated Roster');
                
                // Set up basic worksheet properties
                worksheet.properties.defaultRowHeight = 20;
                
                // Row 1: Header with QA&DOD, UAT sections
                const row1 = worksheet.getRow(1);
                row1.getCell(8).value = 'QA&DOD';
                row1.getCell(9).value = 'UAT';
                
                // Style the header row
                row1.getCell(8).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                row1.getCell(9).font = { bold: true, color: { argb: 'FF000000' } };
                row1.getCell(9).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                
                // Calculate date range for export
                const start = new Date(startDate);
                const end = new Date(endDate);
                const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // Row 3: Date headers
                const row3 = worksheet.getRow(3);
                row3.getCell(4).value = 'Date/Month/Year';
                row3.getCell(4).font = { bold: true };
                
                for (let i = 0; i < totalDays && i < 31; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    const day = currentDate.getDate();
                    const formattedDate = String(day).padStart(2, '0') + '-Aug-25';
                    const cell = row3.getCell(7 + i);
                    cell.value = formattedDate;
                    cell.font = { bold: true, size: 10 };
                    cell.alignment = { horizontal: 'center' };
                }
                
                // Row 4: Column headers and day names
                const row4 = worksheet.getRow(4);
                row4.getCell(4).value = 'CTS';
                row4.getCell(5).value = 'ESHC';
                row4.getCell(6).value = 'Name';
                
                // Style column headers
                [4, 5, 6].forEach(col => {
                    const cell = row4.getCell(col);
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' }, bottom: { style: 'thin' },
                        left: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
                
                for (let i = 0; i < totalDays && i < 31; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const cell = row4.getCell(7 + i);
                    cell.value = dayName;
                    cell.font = { bold: true, size: 9 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                }
                
                // Employee rows with AI-generated data and formatting
                let currentRow = 5;
                npeTeamData.forEach((employee, empIndex) => {
                    const row = worksheet.getRow(currentRow);
                    
                    // Employee info columns
                    row.getCell(4).value = employee.cts;
                    row.getCell(5).value = employee.eshc;
                    row.getCell(6).value = employee.name;
                    
                    // Style employee info
                    [4, 5, 6].forEach(col => {
                        const cell = row.getCell(col);
                        cell.font = { bold: col === 6 }; // Bold name only
                        cell.alignment = { horizontal: col === 6 ? 'left' : 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    });
                    
                    // Daily assignments with color coding
                    for (let i = 0; i < totalDays && i < 31; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        // Get assignment from AI-generated schedule or fall back to real data
                        const daySchedule = lastGeneratedSchedule && lastGeneratedSchedule[dateStr] 
                            ? lastGeneratedSchedule[dateStr] 
                            : realAugust2025Schedule[dateStr] || {};
                        
                        let assignment = 'OFF';
                        
                        // Check which shift the employee is assigned to
                        Object.keys(daySchedule).forEach(shift => {
                            if (daySchedule[shift] && daySchedule[shift].includes(employee.name)) {
                                assignment = shift;
                            }
                        });
                        
                        // Check for leaves
                        const leave = realLeaveData.find(l => 
                            l.employeeName === employee.name && 
                            l.date === dateStr && 
                            l.status === 'approved'
                        );
                        
                        if (leave) {
                            assignment = 'Leave';
                        }
                        
                        const cell = row.getCell(7 + i);
                        cell.value = assignment;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: assignment !== 'OFF', size: 10 };
                        
                        // Color coding based on assignment and WFO policy using Chennai timezone
                        if (assignment === 'Leave') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Bright red
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else if (assignment === 'OFF') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF808080' } }; // Gray
                            cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                        } else {
                            // Check if it's weekend using Chennai timezone
                            const currentDate = new Date(start);
                            currentDate.setDate(start.getDate() + i);
                            const isWeekend = isWeekendInChennai(currentDate);
                            
                            if (isWeekend) {
                                // Weekend work = WFH (Strong Blue highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0066CC' } }; // Strong blue
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            } else {
                                // Weekday work = WFO (Strong Green highlighting)
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00AA00' } }; // Strong green
                                cell.font = { ...cell.font, color: { argb: 'FFFFFFFF' } }; // White text
                            }
                        }
                        
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    
                    currentRow++;
                });
                
                // Add summary rows for shift counts
                currentRow += 1; // Add space
                
                ['S1', 'S2', 'S3'].forEach(shiftType => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(6).value = shiftType;
                    row.getCell(6).font = { bold: true };
                    row.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                    
                    for (let i = 0; i < totalDays && i < 31; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        const daySchedule = lastGeneratedSchedule && lastGeneratedSchedule[dateStr] 
                            ? lastGeneratedSchedule[dateStr] 
                            : realAugust2025Schedule[dateStr] || {};
                        
                        const count = (daySchedule[shiftType] || []).length;
                        
                        const cell = row.getCell(7 + i);
                        cell.value = count;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.font = { bold: true };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } };
                        cell.border = {
                            top: { style: 'thin' }, bottom: { style: 'thin' },
                            left: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                    currentRow++;
                });
                
                // Add shift timing legend
                currentRow += 2;
                const legendData = [
                    ['S1', '06:00 AM TO 04:00 PM IST'],
                    ['S2', '01:00 PM TO 11:00 PM IST'],
                    ['S3', '10:00 PM TO 08:00 AM IST'],
                    ['S4', '12:30 PM TO 10:30 PM IST'],
                    ['G', '09:00 AM TO 07:00 PM IST'],
                    ['P', '06:30 PM TO 04:30 AM IST'],
                    ['HIH', '11:30 AM TO 08:30 PM IST']
                ];
                
                legendData.forEach(([shift, time]) => {
                    const row = worksheet.getRow(currentRow);
                    row.getCell(2).value = shift;
                    row.getCell(3).value = time;
                    
                    row.getCell(2).font = { bold: true };
                    row.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9EAD3' } };
                    currentRow++;
                });
                
                // Add team structure
                currentRow += 2;
                const teamData = [
                    ['LeadS'],
                    ['593300', 'EH0647', 'Dinesh Anbalagan'],
                    ['560008', 'EG4208', 'Mano'],
                    ['Shift Leads'],
                    ['410093', 'EH6832', 'Jeyakaran'],
                    ['2167353', 'C7H8KH', 'Karthikeyan'],
                    ['2054459', 'C6X8FS', 'Panner'],
                    ['2240608', 'C7T7SF', 'Sai Kumar'],
                    ['2136623', 'C8G3CW', 'Manoj']
                ];
                
                teamData.forEach(rowData => {
                    const row = worksheet.getRow(currentRow);
                    rowData.forEach((value, colIndex) => {
                        const cell = row.getCell(colIndex + 1);
                        cell.value = value;
                        if (rowData.length === 1) { // Headers
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCCCCCC' } };
                        }
                    });
                    currentRow++;
                });
                
                // Set column widths
                worksheet.getColumn(4).width = 10; // CTS
                worksheet.getColumn(5).width = 8;  // ESHC
                worksheet.getColumn(6).width = 15; // Name
                for (let i = 7; i <= 37; i++) {
                    worksheet.getColumn(i).width = 7; // Date columns
                }
                
                // Generate and download the file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const fileName = `AI_Generated_Roster_${startDate}_to_${endDate}_WITH_COLORS.xlsx`;
                saveAs(blob, fileName);
                
                // Show success message
                alert(`ü§ñ AI-Generated Roster exported with FULL FORMATTING!\n\nFile: ${fileName}\n\n‚úÖ Features:\nüü¢ GREEN highlighting for WFO assignments\nÔøΩ RED highlighting for leaves\n‚ö™ GRAY for OFF days\nüìä Professional borders and fonts\nüéØ Generated using your custom rules!\n‚ú® Ready for SharePoint!`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Export failed: ${error.message}`);
            }
        }

        // Store the last generated schedule for export
        let lastGeneratedSchedule = null;

        // Initialize Reports
        function initReports() {
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            // Create gradient for line chart
            const lineGradient = ctx.createLinearGradient(0, 0, 0, 200);
            lineGradient.addColorStop(0, 'rgba(139, 95, 191, 0.8)');
            lineGradient.addColorStop(0.5, 'rgba(139, 95, 191, 0.4)');
            lineGradient.addColorStop(1, 'rgba(139, 95, 191, 0.1)');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['üìÖ Week 1', 'üìÖ Week 2', 'üìÖ Week 3', 'üìÖ Week 4'],
                    datasets: [{
                        label: 'Average Working Days',
                        data: [4.2, 4.1, 4.3, 4.0],
                        borderColor: '#8b5fbf',
                        backgroundColor: lineGradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#8b5fbf',
                        pointBorderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#ffd700',
                        pointHoverBorderColor: '#8b5fbf',
                        pointHoverBorderWidth: 4,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2500,
                        easing: 'easeInOutCubic',
                        delay: (context) => {
                            return context.dataIndex * 200;
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#8b5fbf',
                            borderWidth: 2,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label.replace('üìÖ ', '');
                                },
                                label: function(context) {
                                    return `Average: ${context.parsed.y} days per week`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 7,
                            grid: {
                                color: 'rgba(139, 95, 191, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value + ' days';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initDashboard();
                
                // Set default start date to today
                const startDateElement = document.getElementById('startDate');
                if (startDateElement) {
                    const today = new Date().toISOString().split('T')[0];
                    startDateElement.value = today;
                }
                
                // Initialize extra off management with delay to ensure DOM is ready
                setTimeout(() => {
                    initializeExtraOffManagement();
                }, 100);
                
                // Register Service Worker for PWA functionality
                registerServiceWorker();
            
            // Add install app prompt
            setupInstallPrompt();
            } catch (error) {
                console.error('Error during app initialization:', error);
                // Continue with basic functionality even if some features fail
            }
        });

        // PWA Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('NPE ShiftBot: Service Worker registered successfully', registration);
                } catch (error) {
                    console.log('NPE ShiftBot: Service Worker registration failed', error);
                }
            }
        }

        // PWA Install Prompt
        let deferredPrompt;
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                showInstallButton();
            });
        }

        function showInstallButton() {
            // Create install button
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-success';
            installBtn.innerHTML = 'üì± Install App';
            installBtn.style.position = 'fixed';
            installBtn.style.bottom = '20px';
            installBtn.style.right = '20px';
            installBtn.style.zIndex = '1000';
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`NPE ShiftBot: User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
        }

        // Enhanced Local Storage with compression
        const Storage = {
            set: (key, value) => {
                try {
                    const compressed = JSON.stringify(value);
                    localStorage.setItem(`npe-shiftbot-${key}`, compressed);
                } catch (error) {
                    console.error('Storage error:', error);
                }
            },
            get: (key) => {
                try {
                    const item = localStorage.getItem(`npe-shiftbot-${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error('Storage error:', error);
                    return null;
                }
            },
            remove: (key) => {
                localStorage.removeItem(`npe-shiftbot-${key}`);
            }
        };

        // Auto-save functionality
        function autoSave() {
            Storage.set('leaveRequests', leaveRequests);
            Storage.set('scheduleData', scheduleData);
            Storage.set('lastSaved', new Date().toISOString());
        }

        // Load saved data on startup
        function loadSavedData() {
            const savedLeaves = Storage.get('leaveRequests');
            const savedSchedule = Storage.get('scheduleData');
            
            if (savedLeaves) {
                leaveRequests = savedLeaves;
            }
            
            if (savedSchedule) {
                scheduleData = savedSchedule;
            }
        }

        // OpenAI API Key Management (Session-based, secure)
        let sessionApiKey = null;

        function getApiKey() {
            if (sessionApiKey) {
                return sessionApiKey;
            }
            
            const key = prompt('üîë Please enter your OpenAI API Key for AI-powered analysis:\n(This will be stored securely in this session only)');
            if (key && key.trim()) {
                sessionApiKey = key.trim();
                return sessionApiKey;
            }
            return null;
        }

        function saveApiKey(key) {
            sessionApiKey = key;
        }

        function clearApiKey() {
            sessionApiKey = null;
            alert('üîë API Key cleared from session.');
        }

        // Custom Rules Management
        let userCustomRules = {
            shiftRules: [],
            teamRules: [],
            timingRules: [],
            restrictionRules: [],
            priorityRules: []
        };

        // Get Custom Rules from User
        function getCustomRulesFromUser() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                margin: 20px;
            `;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">üìã Define Your Custom Roster Rules</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    OpenAI will <strong>strictly follow only these rules</strong> - no other patterns will be applied.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <h4>üîÑ Shift Rules & Patterns:</h4>
                    <textarea id="shiftRules" placeholder="Example:
- S1 shift requires 1 Lead + 2 Associates
- S2 shift requires 1 Lead + 1 Associate  
- Night shifts (S3) require experienced staff only
- Weekend shifts need reduced staffing" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üë• Team & Role Rules:</h4>
                    <textarea id="teamRules" placeholder="Example:
- Karthikeyan must work S1 shifts only
- Leads cannot work consecutive night shifts
- Associates should rotate between S1 and S2
- Specific employees for specific shifts" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>‚è∞ Timing & Schedule Rules:</h4>
                    <textarea id="timingRules" placeholder="Example:
- Maximum 6 consecutive working days
- Minimum 12 hours rest between shifts
- No S3 to S1 consecutive shifts (night to morning)
- Weekends have reduced requirements" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üö´ Restrictions & Constraints:</h4>
                    <textarea id="restrictionRules" placeholder="Example:
- Certain employees cannot work together
- Some staff unavailable on specific days
- Holiday restrictions
- Leave considerations" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>‚≠ê Priority Rules:</h4>
                    <textarea id="priorityRules" placeholder="Example:
- Senior staff gets first preference for preferred shifts
- Equal distribution of weekend duties
- Maintain work-life balance priorities
- Fair overtime distribution" 
                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;"></textarea>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="saveCustomRules()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">üíæ Save Rules & Continue</button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">Cancel</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Load existing rules if any
            const savedRules = Storage.get('userCustomRules');
            if (savedRules) {
                document.getElementById('shiftRules').value = savedRules.shiftRules.join('\n');
                document.getElementById('teamRules').value = savedRules.teamRules.join('\n');
                document.getElementById('timingRules').value = savedRules.timingRules.join('\n');
                document.getElementById('restrictionRules').value = savedRules.restrictionRules.join('\n');
                document.getElementById('priorityRules').value = savedRules.priorityRules.join('\n');
            }
            
            window.saveCustomRules = function() {
                const shiftRules = document.getElementById('shiftRules').value.split('\n').filter(rule => rule.trim());
                const teamRules = document.getElementById('teamRules').value.split('\n').filter(rule => rule.trim());
                const timingRules = document.getElementById('timingRules').value.split('\n').filter(rule => rule.trim());
                const restrictionRules = document.getElementById('restrictionRules').value.split('\n').filter(rule => rule.trim());
                const priorityRules = document.getElementById('priorityRules').value.split('\n').filter(rule => rule.trim());
                
                userCustomRules = {
                    shiftRules,
                    teamRules,
                    timingRules,
                    restrictionRules,
                    priorityRules
                };
                
                Storage.set('userCustomRules', userCustomRules);
                modal.remove();
                
                alert('‚úÖ Custom rules saved! OpenAI will now strictly follow these rules for roster generation.');
            };
        }

        // OpenAI Integration for Custom Rule-Based Roster Generation
        async function generateRosterWithCustomRules(teamData, scheduleData, startDate, endDate, apiKey) {
            console.log('üîÑ Starting generateRosterWithCustomRules...');
            console.log('üìä Team Data:', teamData);
            console.log('üìÖ Date Range:', startDate, 'to', endDate);
            console.log('üîë API Key present:', !!apiKey);
            
            if (!apiKey) {
                throw new Error('OpenAI API key is required');
            }

            const chennaiTime = getChennaiTime();
            const chennaiDate = getChennaiDate();
            const weekendCount = countWeekendsInRange(new Date(startDate), new Date(endDate));

            console.log('üåç Chennai Time:', chennaiTime);
            console.log('üìä Weekend Count:', weekendCount);
            console.log('üìã Custom Rules:', userCustomRules);

            // Ensure custom rules exist with defaults
            const safeCustomRules = {
                shiftRules: userCustomRules?.shiftRules?.length > 0 ? userCustomRules.shiftRules : ['Ensure adequate staffing for all shifts'],
                teamRules: userCustomRules?.teamRules?.length > 0 ? userCustomRules.teamRules : ['Fair distribution among team members'],
                timingRules: userCustomRules?.timingRules?.length > 0 ? userCustomRules.timingRules : ['Respect work-life balance'],
                restrictionRules: userCustomRules?.restrictionRules?.length > 0 ? userCustomRules.restrictionRules : ['Maximum 6 consecutive working days'],
                priorityRules: userCustomRules?.priorityRules?.length > 0 ? userCustomRules.priorityRules : ['Health and wellness first']
            };

            const customRulesText = `
STRICT CUSTOM RULES - FOLLOW THESE EXACTLY:

ULTIMATE RULE (MOST IMPORTANT):
- Count of Saturday & Sunday = Count of each employee OFF days
- Weekend count in this period: ${weekendCount} days
- Each employee must have exactly ${weekendCount} OFF days

CHENNAI TIMEZONE AWARENESS:
- Current Chennai time: ${chennaiTime}
- All calculations must respect Asia/Kolkata timezone
- Saturday/Sunday work = WFH ONLY (Blue highlighting in Excel)
- Weekday work = WFO ONLY (Green highlighting in Excel)
- Maximum 3 WFO days per employee per week

SHIFT RULES:
${safeCustomRules.shiftRules.map(rule => `- ${rule}`).join('\n')}

TEAM & ROLE RULES:
${safeCustomRules.teamRules.map(rule => `- ${rule}`).join('\n')}

TIMING & SCHEDULE RULES:
${safeCustomRules.timingRules.map(rule => `- ${rule}`).join('\n')}

RESTRICTIONS & CONSTRAINTS:
${safeCustomRules.restrictionRules.map(rule => `- ${rule}`).join('\n')}

PRIORITY RULES:
${safeCustomRules.priorityRules.map(rule => `- ${rule}`).join('\n')}
            `;

            // Simplified team data for better AI processing
            const simplifiedTeamData = teamData.map(emp => ({
                name: emp.name,
                role: emp.role,
                status: emp.status
            }));

            const prompt = `Generate a shift roster that STRICTLY follows the rules below.

TEAM MEMBERS:
${simplifiedTeamData.map(emp => `- ${emp.name} (${emp.role})`).join('\n')}

SCHEDULE PERIOD: ${startDate} to ${endDate}

${customRulesText}

CRITICAL REQUIREMENTS:
1. Each employee must have exactly ${weekendCount} OFF days (matching weekend count)
2. Use Chennai timezone for all calculations
3. Weekends (Sat/Sun) = WFH only, Weekdays = WFO only
4. Maximum 3 WFO days per employee per week
5. Ensure fair distribution and work-life balance

RESPOND WITH ONLY A VALID JSON OBJECT IN THIS EXACT FORMAT:
{
  "2025-08-05": {
    "S1": ["Employee Name1", "Employee Name2"],
    "S2": ["Employee Name3"],
    "S3": ["Employee Name4"],
    "S4": []
  },
  "2025-08-06": {
    "S1": ["Employee Name5"],
    "S2": ["Employee Name1", "Employee Name3"],
    "S3": [],
    "S4": []
  }
}

Generate the complete schedule for all dates from ${startDate} to ${endDate}.`;

            console.log('üìù Sending prompt to OpenAI...');

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',  // Using GPT-4 for better rule following
                        messages: [
                            {
                                role: 'system',
                                content: `You are a precise shift roster generator with Chennai timezone awareness that STRICTLY follows user-defined rules. Current Chennai time: ${chennaiTime}. 

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days.

You must respond with ONLY a valid JSON object. No explanations, no markdown, just pure JSON. Always respect Asia/Kolkata timezone and ensure weekend count equals OFF count for each employee.`
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.1  // Low temperature for consistent rule following
                    })
                });

                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå OpenAI API Error:', errorText);
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                console.log('üì• OpenAI Response:', result);

                const content = result.choices[0]?.message?.content;
                
                if (!content) {
                    throw new Error('No response content from OpenAI');
                }

                console.log('üìÑ Raw content:', content);

                // Clean and parse the JSON response
                let cleanContent = content.trim();
                
                // Remove markdown code blocks if present
                if (cleanContent.startsWith('```')) {
                    cleanContent = cleanContent.replace(/```json\n?/, '').replace(/```$/, '');
                }
                
                // Extract JSON object
                const jsonMatch = cleanContent.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const generatedSchedule = JSON.parse(jsonMatch[0]);
                        console.log('‚úÖ Parsed schedule:', generatedSchedule);
                        
                        // Store the generated schedule for export
                        lastGeneratedSchedule = generatedSchedule;
                        
                        return {
                            schedule: generatedSchedule,
                            explanation: `Roster generated with ${Object.keys(generatedSchedule).length} days, following ULTIMATE RULE and Chennai timezone.`,
                            rulesApplied: safeCustomRules,
                            weekendCount: weekendCount
                        };
                    } catch (parseError) {
                        console.error('‚ùå JSON Parse Error:', parseError);
                        console.error('‚ùå Failed content:', jsonMatch[0]);
                        throw new Error(`Failed to parse generated schedule: ${parseError.message}`);
                    }
                } else {
                    console.error('‚ùå No JSON found in content:', cleanContent);
                    throw new Error('No valid schedule JSON found in OpenAI response');
                }
            } catch (error) {
                console.error('‚ùå OpenAI Custom Rules Error:', error);
                throw error;
            }
        }

        // Fallback roster generation when OpenAI is not available
        function generateFallbackRoster(startDate, endDate) {
            console.log('üîÑ Generating fallback roster...');
            const schedule = {};
            const start = new Date(startDate);
            const end = new Date(endDate);
            const shifts = ['S1', 'S2', 'S3'];
            const weekendCount = countWeekendsInRange(start, end);
            
            // Track OFF days for each employee
            const employeeOffDays = {};
            npeTeamData.forEach(emp => {
                employeeOffDays[emp.name] = 0;
            });
            
            // Create basic rotation schedule
            let employeeIndex = 0;
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const isWeekend = isWeekendInChennai(d);
                
                schedule[dateStr] = { S1: [], S2: [], S3: [], S4: [] };
                
                if (isWeekend) {
                    // Weekend: minimal staffing, everyone else OFF
                    const onCallEmployee = npeTeamData[employeeIndex % npeTeamData.length];
                    schedule[dateStr].S1 = [onCallEmployee.name];
                    
                    // Mark others as OFF
                    npeTeamData.forEach(emp => {
                        if (emp.name !== onCallEmployee.name) {
                            employeeOffDays[emp.name]++;
                        }
                    });
                    
                    employeeIndex++;
                } else {
                    // Weekday: full staffing with rotation
                    shifts.forEach((shift, shiftIndex) => {
                        const employeesNeeded = shift === 'S3' ? 2 : 3; // Night shift needs fewer people
                        
                        for (let i = 0; i < employeesNeeded && i < npeTeamData.length; i++) {
                            const empIndex = (employeeIndex + shiftIndex * 2 + i) % npeTeamData.length;
                            const employee = npeTeamData[empIndex];
                            schedule[dateStr][shift].push(employee.name);
                        }
                    });
                    
                    // Mark unassigned employees as OFF
                    const assignedEmployees = Object.values(schedule[dateStr]).flat();
                    npeTeamData.forEach(emp => {
                        if (!assignedEmployees.includes(emp.name)) {
                            employeeOffDays[emp.name]++;
                        }
                    });
                    
                    employeeIndex++;
                }
            }
            
            console.log('üìä Employee OFF days:', employeeOffDays);
            console.log('üìä Weekend count:', weekendCount);
            
            return schedule;
        }

        // Display simple schedule results
        function displaySimpleSchedule(schedule, startDate, endDate) {
            console.log('üìä Displaying fallback schedule...');
            
            // Show in schedule output
            showTab('generator');
            
            const scheduleOutput = document.getElementById('scheduleOutput');
            if (scheduleOutput) {
                let html = '<div class="alert alert-info">‚úÖ Fallback roster generated successfully!</div>';
                html += '<p>üìÖ Schedule period: ' + startDate + ' to ' + endDate + '</p>';
                
                html += '<table class="table" style="font-size: 12px;"><thead><tr><th>Date</th><th>Day</th><th>S1 (Morning)</th><th>S2 (Afternoon)</th><th>S3 (Night)</th></tr></thead><tbody>';
                
                Object.keys(schedule).forEach(date => {
                    const daySchedule = schedule[date];
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'Asia/Kolkata' });
                    const isWeekend = isWeekendInChennai(dateObj);
                    
                    html += `<tr style="${isWeekend ? 'background-color: #e3f2fd;' : ''}">`;
                    html += `<td><strong>${date}</strong></td>`;
                    html += `<td>${dayName}${isWeekend ? ' üè†' : ' üè¢'}</td>`;
                    
                    ['S1', 'S2', 'S3'].forEach(shift => {
                        const employees = daySchedule[shift];
                        html += `<td>${employees.length > 0 ? employees.join(', ') : 'OFF'}</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '<div class="alert alert-warning">üí° This is a basic fallback schedule. Use OpenAI integration for advanced rule-based generation.</div>';
                
                scheduleOutput.innerHTML = html;
                scheduleOutput.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // OpenAI Integration for Smart Excel Analysis
        async function analyzeWithOpenAI(excelData, apiKey) {
            if (!apiKey) {
                throw new Error('OpenAI API key is required');
            }

            const chennaiTime = getChennaiTime();
            const chennaiDate = getChennaiDate();
            
            const prompt = `Analyze this Excel shift roster data with Chennai timezone awareness (Current Chennai time: ${chennaiTime}):

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days (Weekend count must equal OFF count for each employee)

Excel Data Summary:
- Team Members: ${excelData.teamData?.length || 0}
- Schedule Entries: ${excelData.schedulePatterns?.length || 0}
- Leave Requests: ${excelData.leavePatterns?.length || 0}

Sample Team Data: ${JSON.stringify(excelData.teamData?.slice(0, 3) || [])}
Sample Schedule: ${JSON.stringify(excelData.schedulePatterns?.slice(0, 3) || [])}
Sample Leave: ${JSON.stringify(excelData.leavePatterns?.slice(0, 3) || [])}

CRITICAL RULES TO FOLLOW:
1. Chennai timezone awareness - All dates/times must respect Asia/Kolkata timezone
2. ULTIMATE RULE: Weekend count (Sat + Sun) = OFF count for each employee
3. Maximum 3 WFO (Work From Office) days per week per employee
4. Saturday and Sunday work = WFH (Work From Home) ONLY
5. Weekday work = WFO (Work From Office) with green highlighting in Excel
6. Weekend work = WFH with blue highlighting in Excel

Please analyze and provide:
1. Work patterns (shift preferences, rotation cycles) with Chennai timezone consideration
2. Health & wellbeing rules (consecutive days, rest periods)
3. Fairness criteria (workload distribution, weekend OFF enforcement)
4. Optimization suggestions respecting ULTIMATE RULE
5. Specific rules extracted from the data with weekend/weekday distinction

Respond in JSON format with these keys: workPatterns, healthRules, fairnessRules, optimizations, extractedRules, weekendRules, ultimateRuleCompliance`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are an AI specialist in workforce management and shift scheduling with Chennai timezone awareness. Current Chennai time: ${chennaiTime}. 

ULTIMATE RULE: Count of Saturday & Sunday = Count of each employee OFF days.

CRITICAL CONSTRAINTS:
- Always consider Asia/Kolkata timezone for all date/time calculations
- Maximum 3 WFO days per employee per week
- Saturday/Sunday work = WFH ONLY
- Weekday work = WFO
- Weekend count must equal OFF count for each employee
- Analyze data to extract patterns that promote work-life balance and operational efficiency while strictly following the ULTIMATE RULE.`
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const content = result.choices[0]?.message?.content;
                
                if (!content) {
                    throw new Error('No response from OpenAI');
                }

                try {
                    return JSON.parse(content);
                } catch (parseError) {
                    // If JSON parsing fails, create a structured response from the text
                    return {
                        workPatterns: [content.includes('shift') ? 'Flexible shift patterns detected' : 'Standard rotation cycles'],
                        healthRules: [content.includes('consecutive') ? 'Limit consecutive days' : 'Ensure adequate rest periods'],
                        fairnessRules: [content.includes('distribution') ? 'Fair workload distribution' : 'Accommodate preferences when possible'],
                        optimizations: ['AI-powered schedule optimization', 'Work-life balance enhancement'],
                        extractedRules: ['Auto-extracted from Excel data'],
                        rawResponse: content
                    };
                }
            } catch (error) {
                console.error('OpenAI Analysis Error:', error);
                throw error;
            }
        }

        // Fallback rule extraction for when OpenAI is not available
        function extractRulesFromData(excelData) {
            const rules = {
                workPatterns: [],
                healthRules: [],
                fairnessRules: [],
                optimizations: [],
                extractedRules: []
            };

            // Analyze team data
            if (excelData.teamData && excelData.teamData.length > 0) {
                const roles = [...new Set(excelData.teamData.map(t => t.role))];
                rules.workPatterns.push(`Supports ${roles.length} different roles: ${roles.join(', ')}`);
                rules.fairnessRules.push(`Ensure fair distribution across ${excelData.teamData.length} team members`);
            }

            // Analyze schedule patterns
            if (excelData.schedulePatterns && excelData.schedulePatterns.length > 0) {
                const daysWithSchedule = excelData.schedulePatterns.filter(s => 
                    s.s1_leads || s.s2_leads || s.s3_leads
                ).length;
                const coverage = ((daysWithSchedule / excelData.schedulePatterns.length) * 100).toFixed(1);
                rules.workPatterns.push(`Maintains ${coverage}% schedule coverage`);
                rules.healthRules.push('Ensure adequate rest between shifts');
            }

            // Analyze leave patterns
            if (excelData.leavePatterns && excelData.leavePatterns.length > 0) {
                const leaveTypes = [...new Set(excelData.leavePatterns.map(l => l.type))];
                rules.fairnessRules.push(`Accommodate various leave types: ${leaveTypes.join(', ')}`);
                rules.optimizations.push('Consider leave patterns in scheduling');
            }

            // Default health and optimization rules
            rules.healthRules.push('Limit consecutive working days to 6');
            rules.healthRules.push('Ensure minimum 12 hours between shifts');
            rules.optimizations.push('Balance workload across team members');
            rules.optimizations.push('Prioritize work-life balance');
            rules.extractedRules.push('Data-driven scheduling rules applied');

            return rules;
        }

        // Enhanced Schedule Generation with AI Rules
        function createAIGuidedSchedule(rules, startDate, endDate) {
            const schedule = {};
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Track consecutive days and last shift for each employee
            const employeeTracker = {};
            npeTeamData.forEach(emp => {
                employeeTracker[emp.name] = {
                    consecutiveDays: 0,
                    lastShift: null,
                    totalShifts: 0,
                    lastShiftDate: null
                };
            });

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayOfWeek = d.getDay();
                
                schedule[dateStr] = { S1: [], S2: [], S3: [], S4: [] };
                
                // Apply AI-guided scheduling rules
                Object.keys(schedule[dateStr]).forEach(shift => {
                    const availableEmployees = npeTeamData.filter(emp => {
                        // Check if employee is available (not on preferred day off)
                        if (emp.daysOff && emp.daysOff.includes(dayOfWeek)) {
                            return false;
                        }
                        
                        // Check consecutive days rule (from AI health rules)
                        const tracker = employeeTracker[emp.name];
                        if (tracker.consecutiveDays >= 6) {
                            return false;
                        }
                        
                        // Check rest period between shifts
                        if (tracker.lastShiftDate) {
                            const daysSinceLastShift = Math.floor((d - new Date(tracker.lastShiftDate)) / (1000 * 60 * 60 * 24));
                            if (daysSinceLastShift === 1 && tracker.lastShift === 'S3' && shift === 'S1') {
                                return false; // Not enough rest between night and morning shift
                            }
                        }
                        
                        return emp.status === 'Active';
                    });
                    
                    // Prioritize employees with fewer total shifts (fairness rule)
                    availableEmployees.sort((a, b) => {
                        const aShifts = employeeTracker[a.name].totalShifts;
                        const bShifts = employeeTracker[b.name].totalShifts;
                        return aShifts - bShifts;
                    });
                    
                    // Assign employees to shift based on requirements
                    const requiredCount = getShiftRequirement(shift, dayOfWeek);
                    const assignedEmployees = availableEmployees.slice(0, requiredCount);
                    
                    schedule[dateStr][shift] = assignedEmployees.map(emp => emp.name);
                    
                    // Update employee trackers
                    assignedEmployees.forEach(emp => {
                        const tracker = employeeTracker[emp.name];
                        tracker.consecutiveDays++;
                        tracker.lastShift = shift;
                        tracker.totalShifts++;
                        tracker.lastShiftDate = dateStr;
                    });
                });
                
                // Reset consecutive days for employees not working today
                Object.keys(employeeTracker).forEach(empName => {
                    const isWorkingToday = Object.values(schedule[dateStr]).some(shiftEmps => 
                        shiftEmps.includes(empName)
                    );
                    if (!isWorkingToday) {
                        employeeTracker[empName].consecutiveDays = 0;
                    }
                });
            }
            
            return schedule;
        }

        function getShiftRequirement(shift, dayOfWeek) {
            // Weekend reduced staffing
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return shift === 'S1' || shift === 'S2' ? 2 : 1;
            }
            // Weekday full staffing
            return shift === 'S1' || shift === 'S2' ? 3 : shift === 'S3' ? 2 : 1;
        }

        // Enhanced Schedule Display with AI Insights
        function displayEnhancedSchedule(schedule, rules) {
            // Show the schedule in the generator tab
            showTab('generator');
            
            // Display the schedule in the output area
            const scheduleOutput = document.getElementById('scheduleOutput');
            if (scheduleOutput) {
                scheduleOutput.innerHTML = `
                    <div class="alert alert-success">‚úÖ AI-guided schedule generated successfully!</div>
                `;
            }
            
            // Add AI insights panel
            const insightsPanel = document.createElement('div');
            insightsPanel.style.cssText = `
                margin: 20px 0;
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 10px;
                border-left: 4px solid #8b5fbf;
            `;
            
            insightsPanel.innerHTML = `
                <h4 style="color: #8b5fbf; margin-bottom: 15px;">üß† AI Scheduling Insights</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <h5>Work Patterns</h5>
                        <ul>${rules.workPatterns.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Health Rules</h5>
                        <ul>${rules.healthRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Fairness Criteria</h5>
                        <ul>${rules.fairnessRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h5>Optimizations</h5>
                        <ul>${rules.optimizations.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
            
            const scheduleContainer = document.getElementById('schedule-display');
            if (scheduleContainer) {
                scheduleContainer.insertBefore(insightsPanel, scheduleContainer.firstChild);
            }
        }

        // Train AI with Excel data import
        async function trainAIWithExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('üß† AI Training: Please select an Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show AI training indicator
            const trainingIndicator = document.createElement('div');
            trainingIndicator.innerHTML = 'üß† AI Learning from Excel...';
            trainingIndicator.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1001;
                animation: pulse 1.5s infinite;
            `;
            document.body.appendChild(trainingIndicator);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // First try to process with the existing import logic
                    try {
                        processImportedRoster(workbook);
                        trainingIndicator.innerHTML = '‚úÖ Excel data imported successfully!';
                        setTimeout(() => trainingIndicator.remove(), 2000);
                        return;
                    } catch (importError) {
                        console.log('Standard import failed, using AI-powered analysis:', importError);
                    }
                    
                    // If standard import fails, use AI-powered flexible analysis
                    trainingIndicator.innerHTML = 'üß† Using AI for flexible Excel analysis...';
                    
                    let trainingData = {
                        teamData: [],
                        schedulePatterns: [],
                        leavePatterns: [],
                        insights: []
                    };
                    
                    // Extract data from any sheet structure
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Auto-detect data type based on content
                        if (jsonData.length > 1) {
                            const headers = jsonData[0];
                            const rows = jsonData.slice(1);
                            
                            // Check if it's team/employee data
                            if (headers.some(h => h && h.toString().toLowerCase().includes('name')) &&
                                headers.some(h => h && h.toString().toLowerCase().includes('role'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 2 && row[0] && row[1]) {
                                        const nameIdx = headers.findIndex(h => h && h.toString().toLowerCase().includes('name'));
                                        const roleIdx = headers.findIndex(h => h && h.toString().toLowerCase().includes('role'));
                                        
                                        trainingData.teamData.push({
                                            id: row[0] || Date.now().toString(),
                                            name: row[nameIdx] || row[1],
                                            role: row[roleIdx] || row[2] || 'Associate',
                                            status: 'Active',
                                            preferences: row[3] || '',
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                            
                            // Check if it's schedule data
                            else if (headers.some(h => h && h.toString().toLowerCase().includes('date')) ||
                                     headers.some(h => h && h.toString().toLowerCase().includes('shift'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 2 && row[0]) {
                                        trainingData.schedulePatterns.push({
                                            date: row[0],
                                            data: row.slice(1),
                                            headers: headers.slice(1),
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                            
                            // Check if it's leave data
                            else if (headers.some(h => h && h.toString().toLowerCase().includes('leave')) ||
                                     headers.some(h => h && h.toString().toLowerCase().includes('absence'))) {
                                
                                rows.forEach(row => {
                                    if (row.length >= 3 && row[0]) {
                                        trainingData.leavePatterns.push({
                                            employee: row[0],
                                            date: row[1],
                                            type: row[2],
                                            status: row[3] || 'Approved',
                                            originalRow: row
                                        });
                                    }
                                });
                            }
                        }
                    });
                    
                    // Use OpenAI for intelligent analysis if API key is available
                    const apiKey = getApiKey();
                    let aiRules;
                    
                    if (apiKey) {
                        try {
                            trainingIndicator.innerHTML = 'üß† OpenAI analyzing patterns...';
                            aiRules = await analyzeWithOpenAI(trainingData, apiKey);
                        } catch (aiError) {
                            console.error('OpenAI analysis failed:', aiError);
                            aiRules = extractRulesFromData(trainingData);
                            trainingIndicator.innerHTML = 'üß† Using fallback analysis...';
                        }
                    } else {
                        aiRules = extractRulesFromData(trainingData);
                    }
                    
                    // Store AI learning results
                    trainingData.insights = aiRules;
                    Storage.set('aiTrainingData', trainingData);
                    Storage.set('aiLastTrained', new Date().toISOString());
                    Storage.set('aiRules', aiRules);
                    
                    // Apply learned data to current system
                    if (trainingData.teamData.length > 0) {
                        // Update team data if we learned about employees
                        const shouldUpdateTeam = confirm(
                            `üß† AI found ${trainingData.teamData.length} team members in your Excel file.\n\n` +
                            `Would you like to update the current team data with this information?`
                        );
                        
                        if (shouldUpdateTeam) {
                            npeTeamData.length = 0;
                            trainingData.teamData.forEach(emp => {
                                npeTeamData.push({
                                    id: emp.id,
                                    name: emp.name,
                                    role: emp.role,
                                    status: emp.status,
                                    daysOff: [0, 6], // Default weekend off
                                    cts: emp.id,
                                    eshc: 'N/A',
                                    maxConsecutiveDays: 6,
                                    minRestHours: 12,
                                    skills: []
                                });
                            });
                            updateTeamDisplay();
                        }
                    }
                    
                    if (trainingData.schedulePatterns.length > 0) {
                        // Generate AI-guided schedule with custom rules
                        const shouldGenerateSchedule = confirm(
                            `üß† AI analyzed ${trainingData.schedulePatterns.length} schedule patterns.\n\n` +
                            `Would you like to generate a new roster using YOUR CUSTOM RULES with OpenAI?`
                        );
                        
                        if (shouldGenerateSchedule) {
                            // First, get custom rules from user
                            const hasCustomRules = Storage.get('userCustomRules');
                            if (!hasCustomRules || !hasCustomRules.shiftRules.length) {
                                const shouldDefineRules = confirm(
                                    'üìã To ensure OpenAI follows YOUR specific requirements, you need to define custom rules.\n\n' +
                                    'Would you like to define your roster rules now?'
                                );
                                
                                if (shouldDefineRules) {
                                    getCustomRulesFromUser();
                                    // Wait for rules to be saved before continuing
                                    setTimeout(() => {
                                        proceedWithCustomRosterGeneration(trainingData, aiRules);
                                    }, 1000);
                                } else {
                                    alert('‚ö†Ô∏è Custom rules are required for OpenAI to follow your specific requirements. Using fallback generation.');
                                    const startDate = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
                                    const endDate = prompt('Enter end date (YYYY-MM-DD):', 
                                        new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                                    
                                    if (startDate && endDate) {
                                        const aiSchedule = createAIGuidedSchedule(aiRules, startDate, endDate);
                                        scheduleData = { ...scheduleData, ...aiSchedule };
                                        displayEnhancedSchedule(aiSchedule, aiRules);
                                    }
                                }
                            } else {
                                proceedWithCustomRosterGeneration(trainingData, aiRules);
                            }
                        }
                    }
                    
                    // Remove training indicator and show results
                    trainingIndicator.remove();
                    showAITrainingResults(trainingData, aiRules);
                    
                } catch (error) {
                    console.error('AI Training error:', error);
                    trainingIndicator.remove();
                    alert(`üß† AI Training encountered an error: ${error.message}\n\nPlease check the Excel file format or try again.`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Proceed with custom roster generation using OpenAI
        async function proceedWithCustomRosterGeneration(trainingData, aiRules) {
            console.log('üìÖ Starting proceedWithCustomRosterGeneration...');
            
            const startDate = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            const endDate = prompt('Enter end date (YYYY-MM-DD):', 
                new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            
            if (!startDate || !endDate) {
                alert('‚ùå Start and end dates are required for roster generation.');
                return;
            }
            
            console.log(`üìÖ Dates selected: ${startDate} to ${endDate}`);
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.innerHTML = 'ü§ñ OpenAI generating roster with your custom rules...';
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                padding: 20px 30px;
                border-radius: 25px;
                font-size: 16px;
                z-index: 4000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: pulse 2s infinite;
            `;
            document.body.appendChild(loadingIndicator);
            
            try {
                console.log('üîë Getting API key...');
                const apiKey = getApiKey();
                if (!apiKey) {
                    loadingIndicator.remove();
                    alert('‚ùå OpenAI API key is required for custom rule-based generation.');
                    return;
                }
                
                console.log('üìã Loading custom rules...');
                // Get saved custom rules
                const savedRules = Storage.get('userCustomRules');
                if (savedRules) {
                    userCustomRules = savedRules;
                }
                
                console.log('ü§ñ Calling OpenAI for roster generation...');
                // Generate roster using OpenAI with custom rules
                const result = await generateRosterWithCustomRules(
                    npeTeamData, 
                    scheduleData, 
                    startDate, 
                    endDate, 
                    apiKey
                );
                
                console.log('‚úÖ OpenAI generation successful!', result);
                
                // Apply the generated schedule
                scheduleData = { ...scheduleData, ...result.schedule };
                
                // Show results with custom rules explanation
                loadingIndicator.remove();
                displayCustomRosterResults(result, startDate, endDate);
                
                console.log('üìä Updating schedule display...');
                // Show the generated schedule in the reports tab or schedule generator
                showTab('generator');
                
                // Scroll to schedule output
                const scheduleOutput = document.getElementById('scheduleOutput');
                if (scheduleOutput) {
                    scheduleOutput.scrollIntoView({ behavior: 'smooth' });
                    scheduleOutput.innerHTML = `
                        <div class="alert alert-success">‚úÖ Custom roster generated successfully with OpenAI!</div>
                        <p>Check the modal for detailed results and rule explanations.</p>
                    `;
                }
                
            } catch (error) {
                console.error('Custom roster generation error:', error);
                loadingIndicator.remove();
                
                const useFallback = confirm(`‚ùå Failed to generate roster with OpenAI: ${error.message}\n\nWould you like to use the fallback roster generator instead?`);
                
                if (useFallback) {
                    console.log('üîÑ Using fallback generation...');
                    const fallbackSchedule = generateFallbackRoster(startDate, endDate);
                    scheduleData = { ...scheduleData, ...fallbackSchedule };
                    lastGeneratedSchedule = fallbackSchedule;
                    displaySimpleSchedule(fallbackSchedule, startDate, endDate);
                } else {
                    alert('‚ùå Roster generation cancelled.');
                }
            }
        }

        // Display custom roster generation results
        function displayCustomRosterResults(result, startDate, endDate) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                margin: 20px;
            `;
            
            const scheduleCount = Object.keys(result.schedule).length;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">ü§ñ Custom Rule-Based Roster Generated!</h3>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2d5a2d; margin-bottom: 10px;">‚úÖ Success!</h4>
                    <p>OpenAI has generated a roster for <strong>${scheduleCount} days</strong> (${startDate} to ${endDate}) 
                    following YOUR custom rules strictly.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üìã Your Custom Rules Applied:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üîÑ Shift Rules (${result.rulesApplied.shiftRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.shiftRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üë• Team Rules (${result.rulesApplied.teamRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.teamRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">‚è∞ Timing Rules (${result.rulesApplied.timingRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.timingRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üö´ Restrictions (${result.rulesApplied.restrictionRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.restrictionRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold;">‚≠ê Priority Rules (${result.rulesApplied.priorityRules.length})</summary>
                            <ul style="margin-top: 10px;">
                                ${result.rulesApplied.priorityRules.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üß† OpenAI Explanation:</h4>
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto;">
${result.explanation}
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="exportGeneratedRosterToSharePoint('${startDate}', '${endDate}'); this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #28a745, #34ce57);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">üìä Export SharePoint Excel</button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">‚úÖ Perfect!</button>
                    <button onclick="getCustomRulesFromUser(); this.closest('[style*=fixed]').remove()" style="
                        background: #f39c12;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">üìù Modify Rules</button>
                    <button onclick="clearApiKey(); this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">üîë Clear API Key</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Generate AI insights from training data
        function generateAIInsights(data) {
            const insights = [];
            
            // Analyze team patterns
            if (data.teamData.length > 0) {
                const roles = data.teamData.map(t => t.role);
                const roleCount = roles.reduce((acc, role) => {
                    acc[role] = (acc[role] || 0) + 1;
                    return acc;
                }, {});
                
                insights.push(`Team composition: ${Object.entries(roleCount).map(([role, count]) => `${count} ${role}s`).join(', ')}`);
            }
            
            // Analyze schedule patterns
            if (data.schedulePatterns.length > 0) {
                const avgDaysWithSchedule = data.schedulePatterns.filter(s => s.s1_leads || s.s2_leads || s.s3_leads).length;
                insights.push(`Schedule coverage: ${((avgDaysWithSchedule / data.schedulePatterns.length) * 100).toFixed(1)}% of days scheduled`);
            }
            
            // Analyze leave patterns
            if (data.leavePatterns.length > 0) {
                const leaveTypes = data.leavePatterns.map(l => l.type);
                const typeCount = leaveTypes.reduce((acc, type) => {
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                const mostCommonLeave = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0];
                insights.push(`Most common leave type: ${mostCommonLeave[0]} (${mostCommonLeave[1]} requests)`);
            }
            
            insights.push(`AI processed ${data.teamData.length} team members, ${data.schedulePatterns.length} schedule entries, ${data.leavePatterns.length} leave records`);
            
            return insights;
        }
        
        // Show AI training results
        function showAITrainingResults(data, rules) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="color: #8b5fbf; margin-bottom: 20px;">üß† AI Training Complete!</h3>
                <div style="margin-bottom: 20px;">
                    <h4>Data Processed:</h4>
                    <ul>
                        <li>üìä Team Members: ${data.teamData.length}</li>
                        <li>üìÖ Schedule Patterns: ${data.schedulePatterns.length}</li>
                        <li>üèñÔ∏è Leave Records: ${data.leavePatterns.length}</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>AI-Extracted Rules:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Work Patterns:</h5>
                        <ul>${rules.workPatterns.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Health & Wellbeing Rules:</h5>
                        <ul>${rules.healthRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h5>Fairness Criteria:</h5>
                        <ul>${rules.fairnessRules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h5>Optimizations:</h5>
                        <ul>${rules.optimizations.map(rule => `<li>${rule}</li>`).join('')}</ul>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: linear-gradient(135deg, #8b5fbf, #a374d0);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">Got it!</button>
                    <button onclick="clearApiKey(); this.closest('[style*=fixed]').remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                    ">Clear API Key</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Apply AI learning to current data
        function applyAILearning(data) {
            // This function would apply learned patterns to improve scheduling
            // For now, we'll just show a confirmation
            alert('üß† AI patterns applied! The system will now use learned preferences for future scheduling.');
            
            // Update dashboard to reflect AI learning
            updateDashboardStats();
        }

        // Add small import button in corner for AI training
        function addSmartImportButton() {
            const importBtn = document.createElement('button');
            importBtn.innerHTML = 'üß†';
            importBtn.title = 'Train AI with Excel data';
            importBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #8b5fbf, #a374d0);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(139, 95, 191, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls';
            fileInput.style.display = 'none';
            fileInput.onchange = trainAIWithExcel;
            
            importBtn.onmouseover = () => {
                importBtn.style.transform = 'scale(1.1)';
                importBtn.style.boxShadow = '0 6px 16px rgba(139, 95, 191, 0.4)';
            };
            
            importBtn.onmouseout = () => {
                importBtn.style.transform = 'scale(1)';
                importBtn.style.boxShadow = '0 4px 12px rgba(139, 95, 191, 0.3)';
            };
            
            importBtn.onclick = () => fileInput.click();
            
            document.body.appendChild(importBtn);
            document.body.appendChild(fileInput);
        }

        // Add custom rules button
        function addCustomRulesButton() {
            const rulesBtn = document.createElement('button');
            rulesBtn.innerHTML = 'üìã';
            rulesBtn.title = 'Define Custom Roster Rules for OpenAI';
            rulesBtn.style.cssText = `
                position: fixed;
                top: 65px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #e67e22, #f39c12);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            rulesBtn.onmouseover = () => {
                rulesBtn.style.transform = 'scale(1.1)';
                rulesBtn.style.boxShadow = '0 6px 16px rgba(230, 126, 34, 0.4)';
            };
            
            rulesBtn.onmouseout = () => {
                rulesBtn.style.transform = 'scale(1)';
                rulesBtn.style.boxShadow = '0 4px 12px rgba(230, 126, 34, 0.3)';
            };
            
            rulesBtn.onclick = () => getCustomRulesFromUser();
            
            document.body.appendChild(rulesBtn);
        }

        // Add generate custom roster button
        function addGenerateRosterButton() {
            const generateBtn = document.createElement('button');
            generateBtn.innerHTML = 'ü§ñ';
            generateBtn.title = 'Generate Roster with Custom Rules using OpenAI';
            generateBtn.style.cssText = `
                position: fixed;
                top: 110px;
                right: 20px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                border: none;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            generateBtn.onmouseover = () => {
                generateBtn.style.transform = 'scale(1.1)';
                generateBtn.style.boxShadow = '0 6px 16px rgba(39, 174, 96, 0.4)';
            };
            
            generateBtn.onmouseout = () => {
                generateBtn.style.transform = 'scale(1)';
                generateBtn.style.boxShadow = '0 4px 12px rgba(39, 174, 96, 0.3)';
            };
            
            generateBtn.onclick = (event) => {
                console.log('ü§ñ Generate button clicked!');
                
                // Prevent any form submission or navigation
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                try {
                    // Check if custom rules exist
                    const savedRules = Storage.get('userCustomRules');
                    if (!savedRules || !savedRules.shiftRules.length) {
                        const shouldDefineRules = confirm(
                            'üìã No custom rules found!\n\n' +
                            'OpenAI needs your specific rules to generate the roster exactly as you want.\n\n' +
                            'Would you like to define your rules now?'
                        );
                        
                        if (shouldDefineRules) {
                            getCustomRulesFromUser();
                        }
                    } else {
                        console.log('üöÄ Starting custom roster generation...');
                        proceedWithCustomRosterGeneration({teamData: npeTeamData, schedulePatterns: [], leavePatterns: []}, {});
                    }
                } catch (error) {
                    console.error('Generate button error:', error);
                    alert(`‚ùå Error: ${error.message}`);
                }
            };
            
            document.body.appendChild(generateBtn);
        }

        // Add backup/restore functionality to UI
        function addBackupButtons() {
        // Legacy backup/restore UI removed. Only smart import button remains.
        }

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            addSmartImportButton();
            addCustomRulesButton();
            addGenerateRosterButton();
            
            // Load existing custom rules
            const savedRules = Storage.get('userCustomRules');
            if (savedRules) {
                userCustomRules = savedRules;
            }
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
        });
    </script>
    <!-- Floating Bot Button -->
    <div id="shiftBotButton" style="position: fixed; bottom: 32px; right: 32px; z-index: 1000;">
        <button onclick="showShiftBotRequirements()" style="width: 60px; height: 60px; border-radius: 50%; background: #22c55e; box-shadow: 0 4px 16px rgba(34,197,94,0.15); border: none; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 2rem;">ü§ñ</span>
        </button>
    </div>
    <!-- Modal for Requirements -->
    <div id="shiftBotModal" style="display:none; position: fixed; bottom: 100px; right: 32px; z-index: 1100; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(34,197,94,0.18); padding: 24px; min-width: 320px; max-width: 90vw;">
        <h3 style="margin-top:0;">‚ö° NPE ShiftBot Requirements</h3>
        <ul style="list-style-type: none; padding: 0;">
            <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">ÔøΩ <strong>SHIFT_LEADS:</strong> One of first 5 members (Jeyakaran, Karthikeyan, Manoj, Panner, SaiKumar) must be in every shift</li>
            <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">üö´ <strong>S2_ONLY:</strong> Dinesh and Mano only work S2 (no shift coverage)</li>
            <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">ÔøΩ <strong>WEEKDAY_RULES:</strong> Mon-Fri: 3 in S1&S3, 2 in S2 | Sat: 2 in each shift | Sun: Only S2&S3 with 2 each</li>
            <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">üîÑ <strong>WEEK_OFF_RULE:</strong> Total off days ‚â§ number of Saturdays + Sundays in the month</li>
            <li style="margin: 10px 0; padding: 10px; background: #f8f6fb; border-radius: 5px;">üèñÔ∏è <strong>EXTRA_OFFS:</strong> Additional off days with multiple day selection (counted in total offs)</li>
        </ul>
        <button onclick="hideShiftBotRequirements()" style="margin-top: 16px; background: #22c55e; color: white; border: none; border-radius: 8px; padding: 8px 20px; font-size: 1rem; cursor: pointer;">Close</button>
    </div>
    <script>
    function showShiftBotRequirements() {
        document.getElementById('shiftBotModal').style.display = 'block';
    }
    function hideShiftBotRequirements() {
        document.getElementById('shiftBotModal').style.display = 'none';
    }
    </script>
</body>
</html>
