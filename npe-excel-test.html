<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPE Excel Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        #status { margin: 20px 0; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>NPE Team Excel Export Test</h1>
    
    <button onclick="loadSampleData()">1. Load Sample Roster</button>
    <button onclick="exportToExcel()" id="exportBtn" disabled>2. Export to Excel</button>
    <button onclick="testFileDialog()">3. Test File Import Dialog</button>
    
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">
    
    <div id="status">Ready to test...</div>
    
    <script type="module">
        const { DateTime } = luxon;
        let sampleSchedule = null;

        // Sample NPE team data
        const npeTeam = [
            { id: 'NPE001', name: 'Dinesh Anbalagan', role: 'Lead' },
            { id: 'NPE002', name: 'Mano Kumar', role: 'Lead' },
            { id: 'NPE003', name: 'Jeyakaran S', role: 'Lead' },
            { id: 'NPE004', name: 'Karthikeyan R', role: 'Associate' },
            { id: 'NPE005', name: 'Jeeva Subramaniam', role: 'Associate' }
        ];

        window.loadSampleData = function() {
            const startDate = DateTime.now().startOf('month');
            sampleSchedule = {
                startDate: startDate.toISODate(),
                numDays: 5,
                assignments: {}
            };
            
            // Create sample assignments
            npeTeam.forEach((emp, index) => {
                sampleSchedule.assignments[emp.id] = {};
                for (let i = 0; i < 5; i++) {
                    const date = startDate.plus({ days: i }).toISODate();
                    const shifts = ['S1', 'S2', 'S3', 'OFF'];
                    sampleSchedule.assignments[emp.id][date] = shifts[i % 4];
                }
            });
            
            document.getElementById('status').innerHTML = 'Sample data loaded! Ready to export.';
            document.getElementById('exportBtn').disabled = false;
        };

        window.exportToExcel = function() {
            if (!sampleSchedule) {
                document.getElementById('status').innerHTML = 'ERROR: No data to export!';
                return;
            }

            try {
                document.getElementById('status').innerHTML = 'Creating Excel file...';
                
                // Create workbook
                const workbook = XLSX.utils.book_new();
                
                // Create header row
                const startDate = DateTime.fromISO(sampleSchedule.startDate);
                const headers = ['Employee ID', 'Name', 'Role'];
                for (let i = 0; i < sampleSchedule.numDays; i++) {
                    const date = startDate.plus({ days: i });
                    headers.push(date.toFormat('dd-MMM-yyyy'));
                }
                
                // Create data rows
                const rows = [headers];
                npeTeam.forEach(emp => {
                    const row = [emp.id, emp.name, emp.role];
                    for (let i = 0; i < sampleSchedule.numDays; i++) {
                        const date = startDate.plus({ days: i }).toISODate();
                        const shift = sampleSchedule.assignments[emp.id][date] || 'OFF';
                        row.push(shift);
                    }
                    rows.push(row);
                });
                
                // Create worksheet
                const worksheet = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'NPE Team Roster');
                
                // Export file
                const filename = 'NPE-Team-Test-' + DateTime.now().toFormat('yyyy-MM-dd') + '.xlsx';
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                document.getElementById('status').innerHTML = '✅ Excel file exported successfully! Check your downloads.';
                
            } catch (error) {
                document.getElementById('status').innerHTML = '❌ ERROR: ' + error.message;
                console.error('Export error:', error);
            }
        };

        window.testFileDialog = function() {
            document.getElementById('fileInput').click();
        };

        window.handleFileImport = function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                    document.getElementById('status').innerHTML = '✅ Excel file selected: ' + file.name + ' (Size: ' + file.size + ' bytes)';
                } else {
                    document.getElementById('status').innerHTML = '❌ Please select an Excel file (.xlsx or .xls)';
                }
            }
        };
    </script>
</body>
</html>
